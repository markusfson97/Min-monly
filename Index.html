<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0e27">
    <title>Monly - Din personliga budgetapp</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            touch-action: manipulation; 
            -webkit-text-size-adjust: 100%; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }
        input, select, button { font-size: 16px !important; }
        input.large-input { font-size: 42px !important; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%); 
            color: #e8eaf6; 
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 12px;
            padding-top: max(12px, env(safe-area-inset-top));
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        .app { max-width: 420px; margin: 0 auto; }
        
        /* Kompaktare header */
        .view-header { display: flex; justify-content: center; align-items: center; margin-bottom: 16px; position: relative; padding: 4px 0; }
        .view-header h2 { font-size: 18px; font-weight: 700; color: #e8eaf6; text-align: center; }
        .view-header-left { position: absolute; left: 0; }
        .view-header-right { position: absolute; right: 0; }
        .icon-button { background: none; border: none; color: #667eea; cursor: pointer; padding: 6px; font-size: 16px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .icon-button:active { background: rgba(102, 126, 234, 0.2); }
        
        /* Kompaktare knappar */
        .primary-button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 14px 24px; border-radius: 14px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-bottom: 8px; box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3); transition: all 0.2s ease; }
        .primary-button:active { transform: scale(0.98); }
        .primary-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .secondary-button { background: rgba(159, 168, 218, 0.1); color: #667eea; border: 2px solid rgba(159, 168, 218, 0.2); padding: 12px 20px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-bottom: 8px; }
        .secondary-button:active { background: rgba(159, 168, 218, 0.2); }
        
        /* Start-vy */
        .start-view { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 80px); gap: 24px; }
        .logo { font-size: 52px; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 4px; }
        .tagline { font-size: 14px; color: #9fa8da; }
        
        /* Kompaktare formul√§r */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 12px; color: #9fa8da; margin-bottom: 6px; font-weight: 600; }
        .form-group input, .form-group select { background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 10px; padding: 10px 12px; font-size: 15px; color: #e8eaf6; font-family: inherit; width: 100%; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        select { background: rgba(10, 14, 39, 0.6) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E") no-repeat right 8px center; padding-right: 28px; }
        .flex-row { display: flex; gap: 8px; }
        .flex-row input, .flex-row select { flex: 1; }
        
        /* Kompaktare category cards */
        .category-card { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 16px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease; }
        .category-card:active { transform: scale(0.98); }
        .category-card.utgifter { cursor: default; }
        .category-card.utgifter:active { transform: none; }
        .category-card.fasta { border-color: rgba(244, 67, 54, 0.3); }
        .category-card.nojen { border-color: rgba(255, 152, 0, 0.3); }
        .category-card.sparande { border-color: rgba(76, 175, 80, 0.3); }
        .category-card h3 { font-size: 15px; font-weight: 700; color: #e8eaf6; margin-bottom: 4px; }
        .category-card .percentage { font-size: 12px; color: #9fa8da; font-weight: 600; margin-bottom: 8px; }
        .category-card .budget-amount { font-size: 26px; font-weight: 800; color: #e8eaf6; margin-bottom: 10px; }
        .category-card .remaining { display: flex; justify-content: space-between; font-size: 14px; font-weight: 700; padding-top: 10px; border-top: 1px solid rgba(159, 168, 218, 0.1); }
        .category-card .remaining.negative { color: #e57373; }
        .category-card .remaining:not(.negative) { color: #81c784; }
        
        /* Kompaktare income display */
        .income-display { background: rgba(102, 126, 234, 0.1); border-radius: 10px; padding: 12px 14px; margin-bottom: 14px; display: flex; justify-content: space-between; align-items: center; }
        .income-display-label { font-size: 11px; color: #9fa8da; }
        .income-display-amount { font-size: 20px; font-weight: 700; color: #667eea; }
        
        /* Kompaktare summary bars */
        .summary-bars { display: flex; gap: 8px; margin-bottom: 14px; }
        .summary-bar { flex: 1; border-radius: 10px; padding: 12px; background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); }
        .summary-bar-label { font-size: 10px; color: #9fa8da; margin-bottom: 4px; }
        .summary-bar-amount { font-size: 15px; font-weight: 700; }
        
        /* Kompaktare menu buttons */
        .menu-button { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; font-size: 14px; font-weight: 600; color: #e8eaf6; margin-bottom: 8px; transition: all 0.2s ease; width: 100%; }
        .menu-button:active { background: rgba(159, 168, 218, 0.15); }
        
        /* Kompaktare total cards */
        .total-card { background: rgba(159, 168, 218, 0.1); border-radius: 10px; padding: 12px; margin-bottom: 8px; }
        .total-card h3 { font-size: 10px; color: #9fa8da; text-transform: uppercase; margin-bottom: 4px; font-weight: 600; }
        .total-card-amount { font-size: 16px; font-weight: 700; }
        .total-card.fasta { border-left: 3px solid rgba(244, 67, 54, 0.5); }
        .total-card.nojen { border-left: 3px solid rgba(255, 193, 7, 0.5); }
        .total-card.sparande { border-left: 3px solid rgba(76, 175, 80, 0.5); }
        
        /* Kompaktare special box */
        .special-box { background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.1) 100%); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 14px; padding: 16px; margin-bottom: 14px; }
        .special-box-amount { font-size: 24px; font-weight: 700; color: #667eea; margin: 8px 0; }
        
        /* Kompaktare expense items */
        .expense-item { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 12px; padding: 12px 14px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .expense-item[style*="flex-direction"] { align-items: flex-start; }
        .expense-name { flex: 1; font-size: 14px; font-weight: 600; }
        .expense-amount { font-size: 13px; font-weight: 700; color: #667eea; margin: 0 10px; }
        .delete-button { background: none; border: none; color: #ef5350; cursor: pointer; font-size: 18px; padding: 6px; }
        .delete-button:active { transform: scale(1.2); }
        
        /* Kompaktare history */
        .history-month { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 14px; padding: 16px; margin-bottom: 10px; }
        .history-month h3 { font-size: 16px; font-weight: 700; margin-bottom: 10px; color: #e8eaf6; }
        .history-month-stats { font-size: 13px; color: #9fa8da; }
        
        /* Kompaktare budget options */
        .budget-option { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 10px; padding: 12px 14px; color: #e8eaf6; cursor: pointer; transition: all 0.2s ease; }
        .budget-option:active { background: rgba(159, 168, 218, 0.15); }
        .budget-option.active { background: rgba(102, 126, 234, 0.3); border-color: rgba(102, 126, 234, 0.6); }
        .budget-option-title { font-weight: 600; margin-bottom: 2px; font-size: 14px; }
        .budget-option-desc { font-size: 12px; color: #9fa8da; }
        
        /* Horisontell scrolling f√∂r tabs */
        .scroll-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 12px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .scroll-tabs::-webkit-scrollbar { display: none; }
        .scroll-tab { flex-shrink: 0; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; background: rgba(159, 168, 218, 0.1); border: none; color: #9fa8da; cursor: pointer; }
        .scroll-tab.active { background: rgba(102, 126, 234, 0.3); color: #e8eaf6; }
        
        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(10, 14, 39, 0.95) 0%, rgba(10, 14, 39, 1) 100%);
            border-top: 1px solid rgba(159, 168, 218, 0.1);
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            padding: 8px 12px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 10px;
            transition: all 0.2s ease;
            background: none;
            border: none;
            color: #6b7280;
            min-width: 56px;
        }
        .nav-item:active { background: rgba(159, 168, 218, 0.1); }
        .nav-item.active { color: #667eea; }
        .nav-item .nav-icon { font-size: 20px; }
        .nav-item .nav-label { font-size: 10px; font-weight: 600; }
        
        /* Center button - upph√∂jd */
        .nav-item.center {
            position: relative;
            margin-top: -24px;
        }
        .nav-item.center .nav-icon-wrapper {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
        }
        .nav-item.center .nav-icon { font-size: 24px; color: white; }
        .nav-item.center .nav-label { color: #667eea; margin-top: 4px; }
        
        /* App container med plats f√∂r bottom nav */
        .app { max-width: 420px; margin: 0 auto; padding-bottom: 80px; }
        
        /* Settings dropdown */
        .settings-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 8px;
            min-width: 180px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 200;
        }
        .settings-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #e8eaf6;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
        }
        .settings-item:active { background: rgba(102, 126, 234, 0.2); }
    </style>
</head>
<body>
    <div class="app" id="app"></div>

    <script>
        const languages = {
            sv: {
                appName: 'Monly', tagline: 'Enkel privatekonomi f√∂r alla', createFirst: 'üìÖ Starta budgetering',
                income: 'M√•nadsinkomst', next: 'B√∂rja budgetera', back: 'Tillbaka', myProfile: 'Min profil',
                account: 'Konto', history: 'Historik', totalResult: 'Totalt resultat', editExpenses: 'Redigera utgifter',
                language: 'Spr√•k', currency: 'Valuta', name: 'Namn', fixedCosts: 'Fasta kostnader',
                fun: 'N√∂jen', savings: 'Sparande', remaining: 'Kvar', used: 'Anv√§nt', leftToUse: 'Kvar att anv√§nda',
                forFunAndEntertainment: 'f√∂r n√∂je och underh√•llning', addExpense: 'L√§gg till utgift', 
                noExpenses: 'Inga poster √§nnu', totalIncome: 'Total inkomst', totalExpenses: 'Totala utgifter',
                totalSavings: 'Totalt sparande', totalUsed: 'Totalt anv√§nt', totalRemaining: 'Totalt kvar',
                extraIncome: 'Extra inkomst'
            },
            en: {
                appName: 'Monly', tagline: 'Easy personal finance for everyone', createFirst: 'üìÖ Start budgeting',
                income: 'Monthly income', next: 'Start budgeting', back: 'Back', myProfile: 'My profile',
                account: 'Account', history: 'History', totalResult: 'Total result', editExpenses: 'Edit expenses',
                language: 'Language', currency: 'Currency', name: 'Name', fixedCosts: 'Fixed costs',
                fun: 'Fun', savings: 'Savings', remaining: 'Remaining', used: 'Used', leftToUse: 'Left to use',
                forFunAndEntertainment: 'for fun and entertainment', addExpense: 'Add expense', 
                noExpenses: 'No items yet', totalIncome: 'Total income', totalExpenses: 'Total expenses',
                totalSavings: 'Total savings', totalUsed: 'Total used', totalRemaining: 'Total remaining',
                extraIncome: 'Extra income'
            }
        };

        const state = {
            view: 'start', language: 'sv', currency: 'SEK', userName: '',
            currentMonth: null, // { monthKey, displayDate, income, extraIncome, budgetModel, categories }
            months: [], // Array of all saved months
            selectedCategory: null, accounts: [], currentAccountId: null,
            showExtraIncomeForm: false, budgetModel: 'recommended',
            customPercentages: { fasta: 50, nojen: 30, sparande: 20 },
            priceToTime: { incomeType: 'monthly', incomeAmount: 0, price: 0 },
            pendingIncome: 0, pendingMonth: new Date().getMonth() + 1, pendingYear: new Date().getFullYear(),
            savedExpenseTemplate: null,
            editingItem: null, // { key, id, name, amount }
            totalResultView: 'month', // 'month' or 'year'
            noSpendStreak: {
                lastExpenseDate: null, // Senaste datum en utgift lades till
                streakStartDate: null, // N√§r nuvarande streak b√∂rjade
                savedDays: [], // Array av {date, amount} f√∂r varje sparad dag
                lastCheckedDate: null // Senaste datum vi uppdaterade streaken
            },
            salaryAfterTax: {
                incomeType: 'monthly', // 'monthly' eller 'hourly'
                grossSalary: 0,
                hourlyRate: 0,
                hoursWorked: 160,
                municipality: '',
                birthYear: 1990,
                churchMember: false
            },
            // Brytdag och notis-inst√§llningar
            breakDay: 25, // Dag i m√•naden n√§r ny period b√∂rjar (l√∂nedagen)
            notifications: {
                enabled: false,
                newPeriodReminder: true,
                noSpendCelebration: true,
                reminderTime: 'evening', // 'morning' eller 'evening'
                lastShownDate: null
            }
        };

        const currencies = {
            'SEK': 'Svenska kronor', 'EUR': 'Euro', 'USD': 'US Dollar', 'GBP': 'British Pound',
            'NOK': 'Norska kronor', 'DKK': 'Danska kronor'
        };

        function t(key) { return languages[state.language][key] || key; }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('sv-SE', { style: 'currency', currency: state.currency, minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        }

        function loadState() {
            const saved = localStorage.getItem('monly_data');
            if (saved) Object.assign(state, JSON.parse(saved));
        }

        function saveState() { localStorage.setItem('monly_data', JSON.stringify(state)); }

        // FIX: Hj√§lpfunktion f√∂r att f√• antalet dagar i en m√•nad baserat p√• monthKey
        function getDaysInMonth(monthKey) {
            if (!monthKey) return 30;
            const parts = monthKey.split('-');
            if (parts.length !== 2) return 30;
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            return new Date(year, month, 0).getDate();
        }

        // FIX: Hj√§lpfunktion f√∂r att kolla om en m√•nad anv√§nder simple mode
        function isMonthSimpleMode(month) {
            if (!month) return false;
            // Kolla om m√•naden har en sparad budgetModel
            if (month.budgetModel) {
                return month.budgetModel === 'simple';
            }
            // Fallback: kolla om utgifter-kategorin finns (indikerar simple mode)
            return month.categories && month.categories.utgifter !== undefined;
        }

        // FIX: Hj√§lpfunktion f√∂r att f√• extra inkomst fr√•n m√•naden
        function getExtraIncome(month) {
            return (month && month.extraIncome) ? month.extraIncome : 0;
        }

        function render() {
            switch(state.view) {
                case 'start': renderStart(); break;
                case 'createIncome': renderCreateIncome(); break;
                case 'budget': renderBudget(); break;
                case 'accountSettings': renderAccountSettings(); break;
                case 'priceToTime': renderPriceToTime(); break;
                case 'salaryAfterTax': renderSalaryAfterTax(); break;
                case 'totalResult': renderTotalResult(); break;
                case 'history': renderHistory(); break;
                case 'editExpenses': renderEditExpenses(); break;
                case 'category': renderCategory(); break;
            }
        }
        
        // Bottom Navigation HTML
        function getBottomNav(activeTab = 'budget') {
            return `
                <nav class="bottom-nav">
                    <button class="nav-item ${activeTab === 'totalResult' ? 'active' : ''}" onclick="goTo('totalResult')">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-label">Resultat</span>
                    </button>
                    <button class="nav-item ${activeTab === 'editExpenses' ? 'active' : ''}" onclick="goTo('editExpenses')">
                        <span class="nav-icon">‚úèÔ∏è</span>
                        <span class="nav-label">Utgifter</span>
                    </button>
                    <button class="nav-item center ${activeTab === 'budget' ? 'active' : ''}" onclick="goTo('budget')">
                        <div class="nav-icon-wrapper">
                            <span class="nav-icon">üè†</span>
                        </div>
                        <span class="nav-label">${state.currentMonth ? state.currentMonth.displayDate.split(' ')[0].substring(0,3) : 'Hem'}</span>
                    </button>
                    <button class="nav-item ${activeTab === 'priceToTime' ? 'active' : ''}" onclick="goTo('priceToTime')">
                        <span class="nav-icon">‚è±Ô∏è</span>
                        <span class="nav-label">Pris i tid</span>
                    </button>
                    <button class="nav-item ${activeTab === 'salaryAfterTax' ? 'active' : ''}" onclick="goTo('salaryAfterTax')">
                        <span class="nav-icon">üíµ</span>
                        <span class="nav-label">Nettol√∂n</span>
                    </button>
                </nav>
            `;
        }
        
        // Settings dropdown toggle
        let settingsOpen = false;
        function toggleSettings() {
            settingsOpen = !settingsOpen;
            render();
        }
        
        function getSettingsButton() {
            return `
                <div style="position: relative;">
                    <button class="icon-button" onclick="toggleSettings()">‚öôÔ∏è</button>
                    ${settingsOpen ? `
                        <div class="settings-dropdown">
                            <button class="settings-item" onclick="settingsOpen = false; goTo('accountSettings')">
                                <span>üë§</span> Konto
                            </button>
                            <button class="settings-item" onclick="settingsOpen = false; goTo('history')">
                                <span>üìÖ</span> Historik
                            </button>
                            <button class="settings-item" onclick="settingsOpen = false; goTo('createIncome')">
                                <span>‚ûï</span> Ny period
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderStart() {
            app.innerHTML = `
                <div class="start-view">
                    <div style="text-align: center;">
                        <div class="logo">${t('appName')}</div>
                        <div class="tagline">${t('tagline')}</div>
                    </div>
                    <button class="primary-button" onclick="goTo('createIncome')">${t('createFirst')}</button>
                </div>
            `;
        }

        function renderCreateIncome() {
            const isFirstBudget = !state.months || state.months.length === 0;
            
            // FIX: Tillbaka-knappen g√•r till budget om det finns m√•nader, annars start
            const backView = state.months && state.months.length > 0 ? 'budget' : 'start';
            
            // Generera brytdagar (1-28 f√∂r att undvika problem med kortare m√•nader)
            const breakDayOptions = [];
            for (let day = 1; day <= 28; day++) {
                breakDayOptions.push(`<option value="${day}" ${state.breakDay === day ? 'selected' : ''}>${day}</option>`);
            }
            
            // Ber√§kna aktuell period baserat p√• brytdag
            const today = new Date();
            const currentDay = today.getDate();
            let periodMonth, periodYear;
            
            if (currentDay >= state.breakDay) {
                periodMonth = today.getMonth() + 1;
                periodYear = today.getFullYear();
            } else {
                // Vi √§r i f√∂reg√•ende m√•nads period
                periodMonth = today.getMonth();
                if (periodMonth === 0) {
                    periodMonth = 12;
                    periodYear = today.getFullYear() - 1;
                } else {
                    periodYear = today.getFullYear();
                }
            }
            
            const monthNames = ['', 'Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni', 'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'];
            const periodDisplay = `${monthNames[periodMonth]} ${periodYear}`;

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('${backView}')">‚Üê</button>
                        </div>
                        <h2>${isFirstBudget ? 'V√§lkommen!' : 'Ny period'}</h2>
                        <div class="view-header-right"></div>
                    </div>

                    ${isFirstBudget ? `
                        <p style="font-size: 13px; color: #9fa8da; margin-bottom: 16px; text-align: center;">L√•t oss s√§tta upp din f√∂rsta budget üå±</p>
                        
                        <!-- Brytdag val -->
                        <div style="background: rgba(102, 126, 234, 0.08); border: 2px solid rgba(102, 126, 234, 0.2); border-radius: 12px; padding: 14px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="font-size: 20px;">üìÖ</div>
                                    <div>
                                        <div style="font-size: 13px; font-weight: 700; color: #e8eaf6;">N√§r f√•r du l√∂n?</div>
                                        <div style="font-size: 11px; color: #9fa8da;">Budget-period b√∂rjar denna dag</div>
                                    </div>
                                </div>
                                <select id="breakDaySelect" onchange="state.breakDay = parseInt(this.value); saveState();" style="width: 70px; background: rgba(10, 14, 39, 0.8); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 8px; padding: 8px; color: #667eea; font-family: inherit; font-size: 15px; font-weight: 700; text-align: center;">
                                    ${breakDayOptions.join('')}
                                </select>
                            </div>
                        </div>
                    ` : `
                        <p style="font-size: 13px; color: #9fa8da; margin-bottom: 14px; text-align: center;">Period: <strong style="color: #667eea;">${periodDisplay}</strong></p>
                    `}

                    <!-- Inkomst input -->
                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
                        <div style="font-size: 11px; color: #9fa8da; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">üí∞ Din inkomst denna period</div>
                        <input type="number" id="incomeInput" class="large-input" placeholder="0" value="${state.pendingIncome}" oninput="state.pendingIncome = parseFloat(this.value) || 0;" onfocus="if(this.value === '0') this.value = ''" required min="1" style="background: none; border: none; outline: none; font-weight: 800; color: #667eea; width: 100%; padding: 0; font-family: inherit; margin-bottom: 6px;">
                        <div style="font-size: 13px; color: #9fa8da;">${state.currency}</div>
                    </div>

                    ${isFirstBudget ? `
                        <!-- Notis-opt in -->
                        <div style="background: rgba(159, 168, 218, 0.03); border: 1px solid rgba(159, 168, 218, 0.1); border-radius: 10px; padding: 12px 14px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="font-size: 18px;">üîî</div>
                                    <div>
                                        <div style="font-size: 13px; font-weight: 600; color: #e8eaf6;">P√•minnelser</div>
                                        <div style="font-size: 11px; color: #9fa8da;">Mjuka notiser, max en/dag</div>
                                    </div>
                                </div>
                                <label style="position: relative; display: inline-block; width: 46px; height: 26px; cursor: pointer;">
                                    <input type="checkbox" id="notificationToggle" ${state.notifications.enabled ? 'checked' : ''} onchange="state.notifications.enabled = this.checked; saveState();" style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: ${state.notifications.enabled ? 'rgba(102, 126, 234, 0.6)' : 'rgba(159, 168, 218, 0.2)'}; border-radius: 26px; transition: 0.3s;"></span>
                                    <span style="position: absolute; height: 20px; width: 20px; left: ${state.notifications.enabled ? '23px' : '3px'}; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;"></span>
                                </label>
                            </div>
                        </div>
                    ` : ''}

                    <button type="button" class="primary-button" onclick="createBudgetSimple()" style="margin-top: 12px;">
                        ${isFirstBudget ? 'üöÄ Starta min budget' : '‚úì Skapa period'}
                    </button>
                </div>
            `;
            document.getElementById('incomeInput').focus();
        }
        
        // Ny f√∂renklad funktion f√∂r att skapa budget
        function createBudgetSimple() {
            const income = state.pendingIncome;
            if (!income || income <= 0) {
                alert('Ange en giltig inkomst');
                return;
            }
            
            // Ber√§kna period baserat p√• brytdag
            const today = new Date();
            const currentDay = today.getDate();
            let periodMonth, periodYear;
            
            if (currentDay >= state.breakDay) {
                periodMonth = today.getMonth() + 1;
                periodYear = today.getFullYear();
            } else {
                periodMonth = today.getMonth();
                if (periodMonth === 0) {
                    periodMonth = 12;
                    periodYear = today.getFullYear() - 1;
                } else {
                    periodYear = today.getFullYear();
                }
            }
            
            const monthKey = `${periodYear}-${String(periodMonth).padStart(2, '0')}`;
            const monthNames = ['', 'Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni', 'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'];
            const displayDate = `${monthNames[periodMonth]} ${periodYear}`;
            
            // Kontrollera om perioden redan finns
            const existingMonth = state.months.find(m => m.monthKey === monthKey);
            if (existingMonth) {
                alert('Du har redan en budget f√∂r denna period. G√• till Historik f√∂r att redigera den.');
                return;
            }
            
            // Skapa alltid med enkel modell
            const newMonth = {
                monthKey,
                displayDate,
                income: income,
                extraIncome: 0,
                budgetModel: 'simple',
                categories: {
                    utgifter: { name: 'Utgifter', items: [] }
                }
            };
            
            state.months.push(newMonth);
            state.months.sort((a, b) => a.monthKey.localeCompare(b.monthKey));
            state.currentMonth = newMonth;
            state.pendingIncome = 0;
            
            saveState();
            goTo('budget');
        }

        function renderBudget() {
            if (!state.currentMonth) return;
            const month = state.currentMonth;
            
            // FIX: Anv√§nd m√•nadens sparade budgetModel ist√§llet f√∂r global state
            const isSimpleMode = isMonthSimpleMode(month);
            
            // FIX: H√§mta extra inkomst fr√•n m√•naden direkt
            const extraIncome = getExtraIncome(month);

            let categoryHtml = '';
            let totalSpent = 0;

            if (isSimpleMode) {
                // Simple mode: Utgifter and Kvar i pl√•nboken
                const utgifter = month.categories.utgifter || { name: 'Utgifter', items: [] };
                const spent = utgifter.items.reduce((sum, item) => sum + item.amount, 0);
                totalSpent = spent;
                const totalIncome = month.income + extraIncome;
                const remaining = totalIncome - spent;
                const warningThreshold = totalIncome * 0.1; // 10% warning
                const isWarning = remaining >= 0 && remaining <= warningThreshold;
                
                // FIX: Anv√§nd m√•nadens dagar ist√§llet f√∂r nuvarande datum
                const daysInMonth = getDaysInMonth(month.monthKey);
                const dailyBudget = Math.round(remaining / daysInMonth);
                
                let dailyColor = '#81c784';
                let psychoText = 'Okej, jag kan ta en lunch idag';
                
                if (remaining < 0) {
                    dailyColor = '#e57373';
                    psychoText = 'Fyfan, nu √§r jag fattig...';
                } else if (isWarning) {
                    dailyColor = '#ffa726';
                    psychoText = 'Aj aj nu blir det matl√•dor';
                }

                categoryHtml = `
                    <div class="category-card utgifter">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div>
                                <h3>${utgifter.name}</h3>
                                <div class="budget-amount" style="font-size: 24px; margin-bottom: 0;">${formatCurrency(spent)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 11px; color: #9fa8da;">Kvar</div>
                                <div style="font-size: 20px; font-weight: 800; color: ${dailyColor};">${formatCurrency(remaining)}</div>
                            </div>
                        </div>
                        <div style="background: rgba(102, 126, 234, 0.08); border-radius: 10px; padding: 12px; text-align: center; margin-top: 10px;">
                            <div style="font-size: 11px; color: #9fa8da; margin-bottom: 4px;">üí∞ Daglig budget</div>
                            <div style="font-size: 26px; font-weight: 800; color: ${dailyColor};">${formatCurrency(Math.max(0, dailyBudget))}</div>
                            <div style="font-size: 11px; color: ${dailyColor}; margin-top: 4px;">${psychoText}</div>
                        </div>
                        <button type="button" style="background: rgba(102, 126, 234, 0.15); border: none; border-radius: 10px; padding: 10px; color: #c5caf5; cursor: pointer; font-size: 13px; font-weight: 600; width: 100%; margin-top: 10px;" onclick="goToCategory('utgifter')">
                            ‚ûï L√§gg till utgift
                        </button>
                    </div>
                `;
            } else {
                // Percentage-based mode: Fasta, N√∂jen, Sparande
                // FIX: Inkludera extraIncome i totalBudget f√∂r procentbaserade l√§gen
                const totalIncome = month.income + extraIncome;
                totalSpent = Object.values(month.categories).reduce((sum, cat) => sum + cat.items.reduce((s, item) => s + item.amount, 0), 0);

                for (const [key, cat] of Object.entries(month.categories)) {
                    const spent = cat.items.reduce((sum, item) => sum + item.amount, 0);
                    // FIX: Ber√§kna budget baserat p√• totalIncome (inkl extra) och sparad procent
                    const budget = totalIncome * (cat.percentage / 100);
                    const remaining = budget - spent;
                    
                    categoryHtml += `
                        <div class="category-card ${key}">
                            <h3>${cat.name}</h3>
                            <div class="percentage">${cat.percentage}%</div>
                            <div class="budget-amount">${formatCurrency(budget)}</div>
                            <div class="remaining ${remaining < 0 ? 'negative' : ''}">
                                <span>${t('remaining')}:</span>
                                <span>${formatCurrency(remaining)}</span>
                            </div>
                            <button type="button" style="background: rgba(102, 126, 234, 0.4); border: 2px solid rgba(102, 126, 234, 0.5); border-radius: 12px; padding: 10px; color: #667eea; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; margin-top: 16px;" onclick="goToCategory('${key}')">
                                ‚ûï ${t('addExpense')}
                            </button>
                        </div>
                    `;
                }
            }

            const totalIncome = month.income + extraIncome;
            
            // H√§mta streak-data f√∂r display
            const streakData = getStreakData();
            let streakColor = '#667eea';
            let streakEmoji = 'üî•';
            if (streakData.streakDays >= 3) streakColor = '#ff5722';
            if (streakData.streakDays >= 7) { streakColor = '#f44336'; streakEmoji = 'üî•üî•'; }
            if (streakData.streakDays >= 14) streakEmoji = 'üî•üî•üî•';

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left"></div>
                        <h2>${month.displayDate}</h2>
                        <div class="view-header-right">
                            ${getSettingsButton()}
                        </div>
                    </div>

                    <!-- Kompakt inkomst-sektion -->
                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 14px; padding: 14px 16px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 10px; color: #9fa8da; text-transform: uppercase; font-weight: 600;">${t('totalIncome')}</div>
                                <input type="number" id="editableIncome" class="large-input" value="${month.income}" style="background: none; border: none; outline: none; font-size: 26px; font-weight: 800; color: #667eea; width: 100%; padding: 0; font-family: inherit;" onchange="updateMainIncome(this.value)">
                            </div>
                            ${!state.showExtraIncomeForm && extraIncome === 0 ? `
                                <button style="background: rgba(102, 126, 234, 0.2); border: none; border-radius: 8px; padding: 8px 12px; color: #a8b8f0; font-size: 11px; font-weight: 600; cursor: pointer;" onclick="toggleExtraIncome()">+ Extra</button>
                            ` : extraIncome > 0 ? `
                                <div style="text-align: right;">
                                    <div style="font-size: 10px; color: #81c784;">+${formatCurrency(extraIncome)}</div>
                                    <button style="background: none; border: none; color: #ef5350; font-size: 12px; cursor: pointer; padding: 2px;" onclick="removeExtraIncome()">‚úï</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    ${state.showExtraIncomeForm ? `
                        <div style="background: rgba(102, 126, 234, 0.08); border: 2px solid rgba(102, 126, 234, 0.2); border-radius: 10px; padding: 10px; margin-bottom: 10px; display: flex; gap: 6px;">
                            <input type="number" id="extraIncomeInput" placeholder="Belopp" style="flex: 1; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 8px; color: #e8eaf6; font-family: inherit; font-size: 14px;">
                            <button type="button" style="background: rgba(102, 126, 234, 0.3); border: none; border-radius: 8px; padding: 8px 12px; color: #e8eaf6; font-size: 12px; font-weight: 600; cursor: pointer;" onclick="saveExtraIncome()">‚úì</button>
                            <button type="button" style="background: rgba(159, 168, 218, 0.1); border: none; border-radius: 8px; padding: 8px 12px; color: #9fa8da; font-size: 12px; cursor: pointer;" onclick="cancelExtraIncome()">‚úï</button>
                        </div>
                    ` : ''}

                    ${categoryHtml}
                    
                    <!-- No-spend streak mini-display med motivation -->
                    <div style="background: linear-gradient(135deg, rgba(255, 152, 0, 0.1) 0%, rgba(244, 67, 54, 0.05) 100%); border: 2px solid ${streakColor}30; border-radius: 12px; padding: 12px 14px; margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 24px;">${streakEmoji}</div>
                                <div>
                                    <div style="font-size: 20px; font-weight: 800; color: ${streakColor};">${streakData.streakDays}</div>
                                    <div style="font-size: 9px; color: #9fa8da;">${streakData.streakDays === 1 ? 'dag' : 'dagar'} utan on√∂dig utgift</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 16px; font-weight: 700; color: #81c784;">${formatCurrency(streakData.totalSaved)}</div>
                                <div style="font-size: 9px; color: #9fa8da;">sparat</div>
                            </div>
                        </div>
                        <!-- Motivation: +1, +2, +3 dagar -->
                        <div style="display: flex; gap: 6px; padding-top: 8px; border-top: 1px solid rgba(159, 168, 218, 0.1);">
                            <div style="flex: 1; background: rgba(129, 199, 132, 0.1); border-radius: 6px; padding: 6px; text-align: center;">
                                <div style="font-size: 10px; color: #81c784; font-weight: 600;">+1 dag</div>
                                <div style="font-size: 12px; font-weight: 700; color: #81c784;">${formatCurrency(streakData.dailyBudget)}</div>
                            </div>
                            <div style="flex: 1; background: rgba(129, 199, 132, 0.15); border-radius: 6px; padding: 6px; text-align: center;">
                                <div style="font-size: 10px; color: #81c784; font-weight: 600;">+2 dagar</div>
                                <div style="font-size: 12px; font-weight: 700; color: #81c784;">${formatCurrency(streakData.dailyBudget * 2)}</div>
                            </div>
                            <div style="flex: 1; background: rgba(129, 199, 132, 0.2); border-radius: 6px; padding: 6px; text-align: center;">
                                <div style="font-size: 10px; color: #81c784; font-weight: 600;">+3 dagar</div>
                                <div style="font-size: 12px; font-weight: 700; color: #81c784;">${formatCurrency(streakData.dailyBudget * 3)}</div>
                            </div>
                        </div>
                    </div>
                </div>
                ${getBottomNav('budget')}
            `;
        }

        function renderAccountSettings() {
            // Generera brytdagar
            const breakDayOptions = [];
            for (let day = 1; day <= 28; day++) {
                breakDayOptions.push(`<option value="${day}" ${state.breakDay === day ? 'selected' : ''}>${day}</option>`);
            }
            
            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="settingsOpen = false; goTo('budget')">‚Üê</button>
                        </div>
                        <h2>${t('account')}</h2>
                        <div class="view-header-right"></div>
                    </div>
                    
                    <!-- Grundinst√§llningar -->
                    <div class="form-group">
                        <label>${t('name')}</label>
                        <input type="text" id="userName" value="${state.userName}" oninput="state.userName = this.value" placeholder="${t('name')}">
                    </div>
                    <div class="form-group">
                        <label>${t('language')}</label>
                        <select onchange="state.language = this.value; render()">
                            <option value="sv" ${state.language === 'sv' ? 'selected' : ''}>Svenska</option>
                            <option value="en" ${state.language === 'en' ? 'selected' : ''}>English</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>${t('currency')}</label>
                        <select onchange="state.currency = this.value; render()">
                            ${Object.entries(currencies).map(([code, name]) => `<option value="${code}" ${state.currency === code ? 'selected' : ''}>${code} (${name})</option>`).join('')}
                        </select>
                    </div>
                    
                    <!-- Brytdag -->
                    <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(159, 168, 218, 0.1);">
                        <h3 style="font-size: 14px; color: #9fa8da; margin-bottom: 16px; font-weight: 600; text-transform: uppercase;">üìÖ Budget-period</h3>
                        
                        <div class="form-group">
                            <label>Ny period b√∂rjar den</label>
                            <select onchange="state.breakDay = parseInt(this.value); saveState(); render();">
                                ${breakDayOptions.join('')}
                            </select>
                            <div style="font-size: 12px; color: #9fa8da; margin-top: 8px;">Din budget-period startar denna dag varje m√•nad (t.ex. l√∂nedagen)</div>
                        </div>
                    </div>
                    
                    <!-- Notis-inst√§llningar -->
                    <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(159, 168, 218, 0.1);">
                        <h3 style="font-size: 14px; color: #9fa8da; margin-bottom: 16px; font-weight: 600; text-transform: uppercase;">üîî P√•minnelser</h3>
                        
                        <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
                            <!-- Master toggle -->
                            <div style="display: flex; align-items: center; justify-content: space-between; padding-bottom: 16px; border-bottom: 1px solid rgba(159, 168, 218, 0.1); margin-bottom: 16px;">
                                <div>
                                    <div style="font-size: 15px; font-weight: 600; color: #e8eaf6;">Aktivera p√•minnelser</div>
                                    <div style="font-size: 12px; color: #9fa8da;">Max en per dag, alltid mjuk ton</div>
                                </div>
                                <label style="position: relative; display: inline-block; width: 50px; height: 28px; cursor: pointer;">
                                    <input type="checkbox" ${state.notifications.enabled ? 'checked' : ''} onchange="state.notifications.enabled = this.checked; saveState(); render();" style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: ${state.notifications.enabled ? 'rgba(102, 126, 234, 0.6)' : 'rgba(159, 168, 218, 0.2)'}; border-radius: 28px; transition: 0.3s;"></span>
                                    <span style="position: absolute; height: 22px; width: 22px; left: ${state.notifications.enabled ? '25px' : '3px'}; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;"></span>
                                </label>
                            </div>
                            
                            ${state.notifications.enabled ? `
                                <!-- Ny period p√•minnelse -->
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                    <div>
                                        <div style="font-size: 14px; font-weight: 600; color: #e8eaf6;">üå± Ny period</div>
                                        <div style="font-size: 12px; color: #9fa8da;">P√•minnelse att s√§tta upp ny budget</div>
                                    </div>
                                    <label style="position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer;">
                                        <input type="checkbox" ${state.notifications.newPeriodReminder ? 'checked' : ''} onchange="state.notifications.newPeriodReminder = this.checked; saveState();" style="opacity: 0; width: 0; height: 0;">
                                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: ${state.notifications.newPeriodReminder ? 'rgba(129, 199, 132, 0.6)' : 'rgba(159, 168, 218, 0.2)'}; border-radius: 24px; transition: 0.3s;"></span>
                                        <span style="position: absolute; height: 18px; width: 18px; left: ${state.notifications.newPeriodReminder ? '23px' : '3px'}; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;"></span>
                                    </label>
                                </div>
                                
                                <!-- No-spend celebration -->
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                    <div>
                                        <div style="font-size: 14px; font-weight: 600; color: #e8eaf6;">üî• No-spend dag</div>
                                        <div style="font-size: 12px; color: #9fa8da;">Bekr√§ftelse n√§r du klarat en dag</div>
                                    </div>
                                    <label style="position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer;">
                                        <input type="checkbox" ${state.notifications.noSpendCelebration ? 'checked' : ''} onchange="state.notifications.noSpendCelebration = this.checked; saveState();" style="opacity: 0; width: 0; height: 0;">
                                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: ${state.notifications.noSpendCelebration ? 'rgba(129, 199, 132, 0.6)' : 'rgba(159, 168, 218, 0.2)'}; border-radius: 24px; transition: 0.3s;"></span>
                                        <span style="position: absolute; height: 18px; width: 18px; left: ${state.notifications.noSpendCelebration ? '23px' : '3px'}; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;"></span>
                                    </label>
                                </div>
                                
                                <!-- Tid p√• dygnet -->
                                <div style="padding-top: 16px;">
                                    <div style="font-size: 13px; color: #9fa8da; margin-bottom: 8px;">N√§r vill du bli p√•mind?</div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="state.notifications.reminderTime = 'morning'; saveState(); render();" style="flex: 1; padding: 12px; border-radius: 10px; border: 2px solid ${state.notifications.reminderTime === 'morning' ? 'rgba(102, 126, 234, 0.5)' : 'rgba(159, 168, 218, 0.2)'}; background: ${state.notifications.reminderTime === 'morning' ? 'rgba(102, 126, 234, 0.2)' : 'rgba(159, 168, 218, 0.05)'}; color: #e8eaf6; cursor: pointer; font-size: 14px; font-weight: 600;">
                                            üåÖ Morgon
                                        </button>
                                        <button onclick="state.notifications.reminderTime = 'evening'; saveState(); render();" style="flex: 1; padding: 12px; border-radius: 10px; border: 2px solid ${state.notifications.reminderTime === 'evening' ? 'rgba(102, 126, 234, 0.5)' : 'rgba(159, 168, 218, 0.2)'}; background: ${state.notifications.reminderTime === 'evening' ? 'rgba(102, 126, 234, 0.2)' : 'rgba(159, 168, 218, 0.05)'}; color: #e8eaf6; cursor: pointer; font-size: 14px; font-weight: 600;">
                                            üåô Kv√§ll
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Avancerade budgetinst√§llningar -->
                    <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(159, 168, 218, 0.1);">
                        <h3 style="font-size: 14px; color: #9fa8da; margin-bottom: 16px; font-weight: 600; text-transform: uppercase;">‚öôÔ∏è Avancerat: Budgetmodell</h3>
                        <p style="font-size: 12px; color: #9fa8da; margin-bottom: 16px;">G√§ller f√∂r nya perioder. Enkel √∂versikt rekommenderas.</p>

                        <div class="budget-option ${state.budgetModel === 'simple' ? 'active' : ''}" onclick="selectBudgetModel('simple'); saveSettings();">
                            <div class="budget-option-title">Enkel √∂versikt ‚úì</div>
                            <div class="budget-option-desc">Utgifter & Kvar i pl√•nboken - utan %-basering</div>
                        </div>

                        <div class="budget-option ${state.budgetModel === 'recommended' ? 'active' : ''}" onclick="selectBudgetModel('recommended'); saveSettings();" style="margin-top: 12px;">
                            <div class="budget-option-title">50/30/20 modell</div>
                            <div class="budget-option-desc">Fasta: 50% | N√∂jen: 30% | Sparande: 20%</div>
                        </div>

                        <div class="budget-option ${state.budgetModel === 'custom' ? 'active' : ''}" onclick="selectBudgetModel('custom');" style="margin-top: 12px;">
                            <div class="budget-option-title">Egen % f√∂rdelning</div>
                            <div class="budget-option-desc">Du v√§ljer sj√§lv hur du vill f√∂rdela</div>
                        </div>

                        ${state.budgetModel === 'custom' ? `
                            <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 20px; margin-top: 16px;">
                                <div class="form-group">
                                    <label>Fasta kostnader (%)</label>
                                    <input type="number" id="customFasta2" value="${state.customPercentages.fasta}" min="0" max="100" oninput="updateCustomPercentage('fasta', this.value)">
                                </div>

                                <div class="form-group">
                                    <label>N√∂jen (%)</label>
                                    <input type="number" id="customNojen2" value="${state.customPercentages.nojen}" min="0" max="100" oninput="updateCustomPercentage('nojen', this.value)">
                                </div>

                                <div class="form-group">
                                    <label>Sparande (%)</label>
                                    <input type="number" id="customSparande2" value="${state.customPercentages.sparande}" min="0" max="100" oninput="updateCustomPercentage('sparande', this.value)">
                                </div>

                                <div style="background: rgba(102, 126, 234, 0.2); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 12px; text-align: center;">
                                    <div style="font-size: 12px; color: #9fa8da; margin-bottom: 4px;">Totalt</div>
                                    <div style="font-size: 18px; font-weight: 700; color: ${(state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande) === 100 ? '#81c784' : '#e57373'};">${state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande}%</div>
                                </div>

                                <button type="button" class="primary-button" onclick="saveSettings()" style="margin-top: 16px;" ${(state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande) !== 100 ? 'disabled' : ''}>Spara √§ndringar</button>
                            </div>
                        ` : ''}
                    </div>

                    <button class="primary-button" onclick="saveSettings()" style="margin-top: 32px;">Spara</button>
                </div>
            `;
        }

        function renderTotalResult() {
            if (!state.currentMonth) return;
            
            // FIX: Anv√§nd m√•nadens sparade budgetModel
            const isSimpleMode = isMonthSimpleMode(state.currentMonth);
            const extraIncome = getExtraIncome(state.currentMonth);

            // Calculate month data
            let monthCardHtml = '';
            if (isSimpleMode) {
                const utgifterSpent = state.currentMonth.categories.utgifter?.items.reduce((sum, item) => sum + item.amount, 0) || 0;
                const totalIncome = state.currentMonth.income + extraIncome;
                const remaining = totalIncome - utgifterSpent;
                
                monthCardHtml = `
                    <div class="total-card utgifter">
                        <h3>Utgifter</h3>
                        <div class="total-card-amount">${formatCurrency(utgifterSpent)}</div>
                    </div>

                    <div class="special-box">
                        <h3 style="font-size: 14px; font-weight: 700; color: #e8eaf6;">üí∞ Kvar i pl√•nboken</h3>
                        <div class="special-box-amount">${formatCurrency(Math.max(0, remaining))}</div>
                        <p style="font-size: 12px; color: #9fa8da;">Du kan spendera detta fritt denna m√•nad</p>
                    </div>
                `;
            } else {
                const totalIncome = state.currentMonth.income + extraIncome;
                const fataSpent = state.currentMonth.categories.fasta?.items.reduce((sum, item) => sum + item.amount, 0) || 0;
                const nojenSpent = state.currentMonth.categories.nojen?.items.reduce((sum, item) => sum + item.amount, 0) || 0;
                const sparandeSpent = state.currentMonth.categories.sparande?.items.reduce((sum, item) => sum + item.amount, 0) || 0;
                const leftToUse = totalIncome - (fataSpent + sparandeSpent);

                monthCardHtml = `
                    <div class="total-card fasta">
                        <h3>Fasta kostnader</h3>
                        <div class="total-card-amount">${formatCurrency(fataSpent)}</div>
                    </div>

                    <div class="total-card nojen">
                        <h3>N√∂jen</h3>
                        <div class="total-card-amount">${formatCurrency(nojenSpent)}</div>
                    </div>

                    <div class="total-card sparande">
                        <h3>Sparande</h3>
                        <div class="total-card-amount">${formatCurrency(sparandeSpent)}</div>
                    </div>

                    <div class="special-box">
                        <h3 style="font-size: 14px; font-weight: 700; color: #e8eaf6;">üí∞ ${t('leftToUse')}</h3>
                        <div class="special-box-amount">${formatCurrency(Math.max(0, leftToUse))}</div>
                        <p style="font-size: 12px; color: #9fa8da;">${t('forFunAndEntertainment')}</p>
                    </div>
                `;
            }

            // FIX: Calculate year data - hantera blandade budgetmodeller
            let yearCardHtml = '';
            if (state.months && state.months.length > 0) {
                // Ber√§kna totaler oavsett budgetmodell
                let yearTotalIncome = 0;
                let yearTotalSpent = 0;
                let yearFasta = 0;
                let yearNojen = 0;
                let yearSparande = 0;
                let yearUtgifter = 0;

                state.months.forEach(month => {
                    const monthExtra = getExtraIncome(month);
                    yearTotalIncome += (month.income || 0) + monthExtra;
                    
                    if (isMonthSimpleMode(month)) {
                        const spent = month.categories.utgifter?.items.reduce((s, item) => s + item.amount, 0) || 0;
                        yearUtgifter += spent;
                        yearTotalSpent += spent;
                    } else {
                        const fSpent = month.categories.fasta?.items.reduce((s, item) => s + item.amount, 0) || 0;
                        const nSpent = month.categories.nojen?.items.reduce((s, item) => s + item.amount, 0) || 0;
                        const sSpent = month.categories.sparande?.items.reduce((s, item) => s + item.amount, 0) || 0;
                        yearFasta += fSpent;
                        yearNojen += nSpent;
                        yearSparande += sSpent;
                        yearTotalSpent += fSpent + nSpent + sSpent;
                    }
                });

                const yearRemaining = yearTotalIncome - yearTotalSpent;

                // Visa alltid en kombinerad vy f√∂r √•ret
                yearCardHtml = `
                    ${yearFasta > 0 || yearNojen > 0 || yearSparande > 0 ? `
                        <div class="total-card fasta">
                            <h3>Fasta kostnader (Helt √•r)</h3>
                            <div class="total-card-amount">${formatCurrency(yearFasta)}</div>
                        </div>

                        <div class="total-card nojen">
                            <h3>N√∂jen (Helt √•r)</h3>
                            <div class="total-card-amount">${formatCurrency(yearNojen)}</div>
                        </div>

                        <div class="total-card sparande">
                            <h3>Sparande (Helt √•r)</h3>
                            <div class="total-card-amount">${formatCurrency(yearSparande)}</div>
                        </div>
                    ` : ''}

                    ${yearUtgifter > 0 ? `
                        <div class="total-card" style="border-left: 4px solid rgba(159, 168, 218, 0.5);">
                            <h3>Utgifter - enkel modell (Helt √•r)</h3>
                            <div class="total-card-amount">${formatCurrency(yearUtgifter)}</div>
                        </div>
                    ` : ''}

                    <div class="special-box">
                        <h3 style="font-size: 14px; font-weight: 700; color: #e8eaf6;">üí∞ Kvar (Helt √•r)</h3>
                        <div class="special-box-amount">${formatCurrency(Math.max(0, yearRemaining))}</div>
                        <p style="font-size: 12px; color: #9fa8da;">Total inkomst: ${formatCurrency(yearTotalIncome)}</p>
                    </div>
                `;
            }

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('budget')">‚Üê</button>
                        </div>
                        <h2>${t('totalResult')}</h2>
                        <div class="view-header-right"></div>
                    </div>
                    
                    <div style="display: flex; gap: 6px; margin-bottom: 14px;">
                        <button style="flex: 1; padding: 10px; border-radius: 10px; font-size: 12px; font-weight: 600; border: none; cursor: pointer; ${state.totalResultView === 'month' ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;' : 'background: rgba(102, 126, 234, 0.15); color: #a8b8f0;'}" onclick="state.totalResultView = 'month'; render();">üìä ${state.currentMonth.displayDate}</button>
                        <button style="flex: 1; padding: 10px; border-radius: 10px; font-size: 12px; font-weight: 600; border: none; cursor: pointer; ${state.totalResultView === 'year' ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;' : 'background: rgba(102, 126, 234, 0.15); color: #a8b8f0;'}" onclick="state.totalResultView = 'year'; render();">üìà Helt √•r</button>
                    </div>

                    ${state.totalResultView === 'month' ? monthCardHtml : yearCardHtml}
                </div>
                ${getBottomNav('totalResult')}
            `;
        }

        function renderPriceToTime() {
            const hourlyIncome = calculateHourlyIncome();
            const hours = hourlyIncome > 0 && state.priceToTime.price > 0 ? state.priceToTime.price / hourlyIncome : 0;
            const totalMinutes = Math.round(hours * 60);
            const displayHours = Math.floor(hours);
            const displayMinutes = Math.round((hours - displayHours) * 60);

            let timeDisplay = '';
            if (totalMinutes < 1) {
                timeDisplay = '< 1 min';
            } else if (displayHours === 0) {
                timeDisplay = `${displayMinutes}m`;
            } else if (displayMinutes === 0) {
                timeDisplay = `${displayHours}h`;
            } else {
                timeDisplay = `${displayHours}h ${displayMinutes}m`;
            }

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('budget')">‚Üê</button>
                        </div>
                        <h2>Pris i tid</h2>
                        <div class="view-header-right">
                            <button class="icon-button" onclick="showInfoModal('priceToTime')">?</button>
                        </div>
                    </div>

                    <!-- Kompakt inkomst -->
                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%); border: 2px solid rgba(102, 126, 234, 0.2); border-radius: 12px; padding: 14px; margin-bottom: 12px;">
                        <div style="display: flex; gap: 6px; margin-bottom: 10px;">
                            <button style="flex: 1; padding: 8px; border-radius: 8px; font-size: 11px; font-weight: 600; border: 2px solid ${state.priceToTime.incomeType === 'hourly' ? 'rgba(102, 126, 234, 0.5)' : 'rgba(159, 168, 218, 0.2)'}; background: ${state.priceToTime.incomeType === 'hourly' ? 'rgba(102, 126, 234, 0.2)' : 'transparent'}; color: #e8eaf6; cursor: pointer;" onclick="state.priceToTime.incomeType = 'hourly'; render()">Timl√∂n</button>
                            <button style="flex: 1; padding: 8px; border-radius: 8px; font-size: 11px; font-weight: 600; border: 2px solid ${state.priceToTime.incomeType === 'monthly' ? 'rgba(102, 126, 234, 0.5)' : 'rgba(159, 168, 218, 0.2)'}; background: ${state.priceToTime.incomeType === 'monthly' ? 'rgba(102, 126, 234, 0.2)' : 'transparent'}; color: #e8eaf6; cursor: pointer;" onclick="state.priceToTime.incomeType = 'monthly'; render()">M√•nad</button>
                            <button style="flex: 1; padding: 8px; border-radius: 8px; font-size: 11px; font-weight: 600; border: 2px solid ${state.priceToTime.incomeType === 'yearly' ? 'rgba(102, 126, 234, 0.5)' : 'rgba(159, 168, 218, 0.2)'}; background: ${state.priceToTime.incomeType === 'yearly' ? 'rgba(102, 126, 234, 0.2)' : 'transparent'}; color: #e8eaf6; cursor: pointer;" onclick="state.priceToTime.incomeType = 'yearly'; render()">√Ör</button>
                        </div>
                        <input type="number" id="incomeInput" value="${state.priceToTime.incomeAmount}" placeholder="Din inkomst" onfocus="if(this.value === '0') this.value = ''" onchange="state.priceToTime.incomeAmount = parseFloat(this.value) || 0; render();" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 10px; padding: 12px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 16px; font-weight: 600;">
                        <div style="font-size: 12px; color: #81c784; font-weight: 600; margin-top: 6px;">‚âà ${formatCurrency(hourlyIncome)}/h</div>
                    </div>

                    <!-- Pris input -->
                    <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 12px; padding: 14px; margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #9fa8da; margin-bottom: 6px; font-weight: 600;">üõí Pris att utv√§rdera</div>
                        <input type="number" id="priceInput" value="${state.priceToTime.price}" placeholder="0" onfocus="if(this.value === '0') this.value = ''" onchange="state.priceToTime.price = parseFloat(this.value) || 0; render();" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(219, 112, 147, 0.3); border-radius: 10px; padding: 12px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 16px; font-weight: 600;">
                    </div>

                    <!-- Resultat -->
                    <div style="background: linear-gradient(135deg, rgba(255, 152, 0, 0.15) 0%, rgba(233, 30, 99, 0.08) 100%); border: 2px solid rgba(255, 152, 0, 0.3); border-radius: 16px; padding: 20px; text-align: center;">
                        <div style="font-size: 12px; color: #ff9800; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">‚è±Ô∏è Tidskostnad</div>
                        <div style="font-size: 48px; font-weight: 800; color: #ff9800;">${timeDisplay}</div>
                        <div style="font-size: 13px; color: #9fa8da; margin-top: 8px;">arbetstid f√∂r detta k√∂p</div>
                    </div>
                </div>
                ${getBottomNav('priceToTime')}
            `;
        }

        function calculateHourlyIncome() {
            if (state.priceToTime.incomeAmount <= 0) return 0;
            
            switch(state.priceToTime.incomeType) {
                case 'hourly':
                    return state.priceToTime.incomeAmount;
                case 'monthly':
                    return (state.priceToTime.incomeAmount * 12) / (52 * 40);
                case 'yearly':
                    return state.priceToTime.incomeAmount / (52 * 40);
                default:
                    return 0;
            }
        }

        // No-spend streak hj√§lpfunktioner
        function getLatestMonth() {
            if (!state.months || state.months.length === 0) return null;
            // Returnera senaste m√•naden (sista i sorterad array)
            return state.months[state.months.length - 1];
        }
        
        function getStreakData() {
            const latestMonth = getLatestMonth();
            if (!latestMonth) return { dailyBudget: 0, streakDays: 0, totalSaved: 0, todaySaved: 0, remaining: 0, monthName: '' };
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Ber√§kna daglig budget baserat p√• kvar att anv√§nda i senaste m√•naden
            const extraIncome = getExtraIncome(latestMonth);
            const totalIncome = latestMonth.income + extraIncome;
            
            let totalSpent = 0;
            Object.values(latestMonth.categories).forEach(cat => {
                cat.items.forEach(item => {
                    totalSpent += item.amount;
                });
            });
            
            const remaining = totalIncome - totalSpent;
            const daysInMonth = getDaysInMonth(latestMonth.monthKey);
            const dailyBudget = Math.max(0, Math.round(remaining / daysInMonth));
            
            // Ber√§kna streak - antal dagar sedan senaste utgift
            let streakDays = 0;
            const lastExpenseDate = state.noSpendStreak.lastExpenseDate;
            
            if (!lastExpenseDate) {
                // Ingen utgift registrerad, r√§kna fr√•n streak-start
                if (state.noSpendStreak.streakStartDate) {
                    const startDate = new Date(state.noSpendStreak.streakStartDate);
                    streakDays = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                }
            } else {
                const lastExpense = new Date(lastExpenseDate);
                const daysSinceExpense = Math.floor((today - lastExpense) / (1000 * 60 * 60 * 24));
                
                // Om utgift var idag, streak = 0
                if (lastExpenseDate === todayStr) {
                    streakDays = 0;
                } else {
                    // Streak b√∂rjar dagen efter senaste utgift
                    streakDays = daysSinceExpense;
                    
                    // S√§tt streak startdatum om det inte finns
                    if (!state.noSpendStreak.streakStartDate && streakDays > 0) {
                        const nextDay = new Date(lastExpense);
                        nextDay.setDate(nextDay.getDate() + 1);
                        state.noSpendStreak.streakStartDate = nextDay.toISOString().split('T')[0];
                        saveState();
                    }
                }
            }
            
            // Uppdatera sparade dagar vid midnatt
            updateSavedDays(dailyBudget, todayStr, latestMonth.monthKey);
            
            const totalSaved = state.noSpendStreak.savedDays
                .filter(d => d.monthKey === latestMonth.monthKey)
                .reduce((sum, d) => sum + d.amount, 0);
            
            return {
                dailyBudget,
                streakDays,
                totalSaved,
                todaySaved: dailyBudget,
                remaining,
                monthName: latestMonth.displayDate,
                monthKey: latestMonth.monthKey
            };
        }
        
        function updateSavedDays(dailyBudget, todayStr, monthKey) {
            if (!state.noSpendStreak.savedDays) {
                state.noSpendStreak.savedDays = [];
            }
            
            const lastChecked = state.noSpendStreak.lastCheckedDate;
            
            // Om vi inte har kollat f√∂rut eller det √§r en ny dag
            if (lastChecked !== todayStr) {
                // L√§gg till alla dagar mellan lastChecked och ig√•r (inte idag, den √§r inte klar √§n)
                if (lastChecked && state.noSpendStreak.streakStartDate) {
                    const lastDate = new Date(lastChecked);
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    let checkDate = new Date(lastDate);
                    checkDate.setDate(checkDate.getDate() + 1);
                    
                    while (checkDate <= yesterday) {
                        const dateStr = checkDate.toISOString().split('T')[0];
                        
                        // Kolla att dagen inte redan finns och att vi hade en aktiv streak
                        const exists = state.noSpendStreak.savedDays.some(d => d.date === dateStr);
                        const wasInStreak = state.noSpendStreak.streakStartDate && 
                                           dateStr >= state.noSpendStreak.streakStartDate &&
                                           (!state.noSpendStreak.lastExpenseDate || dateStr > state.noSpendStreak.lastExpenseDate);
                        
                        if (!exists && wasInStreak) {
                            state.noSpendStreak.savedDays.push({
                                date: dateStr,
                                amount: dailyBudget,
                                monthKey: monthKey
                            });
                        }
                        
                        checkDate.setDate(checkDate.getDate() + 1);
                    }
                }
                
                state.noSpendStreak.lastCheckedDate = todayStr;
                saveState();
            }
        }

        function renderNoSpendStreak() {
            const latestMonth = getLatestMonth();
            if (!latestMonth) {
                goTo('budget');
                return;
            }
            
            const data = getStreakData();
            const today = new Date();
            const todayStr = today.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'long' });
            
            // Ber√§kna kommande dagar
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'short' });
            
            const dayAfter = new Date(today);
            dayAfter.setDate(dayAfter.getDate() + 2);
            const dayAfterStr = dayAfter.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'short' });
            
            // Streak f√§rg baserat p√• l√§ngd
            let streakColor = '#667eea';
            let streakEmoji = 'üî•';
            let motivationText = 'Varje dag utan utgift r√§knas!';
            
            if (data.streakDays >= 1) {
                streakColor = '#ff9800';
                motivationText = 'Bra start! Forts√§tt s√•!';
            }
            if (data.streakDays >= 3) {
                streakColor = '#ff5722';
                motivationText = 'Du √§r p√• g√•ng! üí™';
            }
            if (data.streakDays >= 7) {
                streakColor = '#f44336';
                streakEmoji = 'üî•üî•';
                motivationText = 'En hel vecka! Fantastiskt!';
            }
            if (data.streakDays >= 14) {
                streakEmoji = 'üî•üî•üî•';
                motivationText = 'Tv√• veckor! Du √§r unstoppable!';
            }
            if (data.streakDays >= 30) {
                streakEmoji = 'üëëüî•üëë';
                motivationText = 'LEGEND! En hel m√•nad!';
            }
            
            // Visa senaste sparade dagar
            const recentSaved = state.noSpendStreak.savedDays
                .filter(d => d.monthKey === data.monthKey)
                .sort((a, b) => b.date.localeCompare(a.date))
                .slice(0, 5);

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('profile')">‚Üê</button>
                        </div>
                        <h2>No-spend Streak</h2>
                        <div class="view-header-right">
                            <button class="icon-button" onclick="showInfoModal('noSpendStreak')">?</button>
                        </div>
                    </div>

                    <!-- Streak Counter + Sparat - kompakt -->
                    <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                        <!-- Streak -->
                        <div style="flex: 1; background: linear-gradient(135deg, rgba(255, 152, 0, 0.15) 0%, rgba(244, 67, 54, 0.1) 100%); border: 2px solid ${streakColor}40; border-radius: 16px; padding: 16px; text-align: center;">
                            <div style="font-size: 32px;">${streakEmoji}</div>
                            <div style="font-size: 42px; font-weight: 800; color: ${streakColor}; line-height: 1;">${data.streakDays}</div>
                            <div style="font-size: 12px; color: #9fa8da; margin-top: 4px;">${data.streakDays === 1 ? 'dag' : 'dagar'} i rad</div>
                        </div>
                        <!-- Sparat -->
                        <div style="flex: 1; background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(56, 142, 60, 0.1) 100%); border: 2px solid rgba(76, 175, 80, 0.4); border-radius: 16px; padding: 16px; text-align: center;">
                            <div style="font-size: 11px; color: #81c784; text-transform: uppercase; font-weight: 600;">üí∞ Sparat</div>
                            <div style="font-size: 28px; font-weight: 800; color: #81c784; margin-top: 8px;">${formatCurrency(data.totalSaved)}</div>
                            <div style="font-size: 10px; color: #9fa8da; margin-top: 4px;">${data.monthName}</div>
                        </div>
                    </div>
                    
                    <!-- Motivation text -->
                    <div style="text-align: center; padding: 10px 0; margin-bottom: 12px;">
                        <span style="font-size: 13px; color: ${streakColor}; font-weight: 600;">${motivationText}</span>
                    </div>

                    <!-- Kommande Dagar - kompakt -->
                    <div style="background: rgba(102, 126, 234, 0.08); border: 2px solid rgba(102, 126, 234, 0.2); border-radius: 12px; padding: 14px; margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #667eea; text-transform: uppercase; font-weight: 600; margin-bottom: 10px;">üéØ Kommande potential</div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                            <span style="font-size: 13px; color: #e8eaf6;">Idag</span>
                            <span style="font-size: 15px; font-weight: 700; color: #81c784;">+${formatCurrency(data.dailyBudget)}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                            <span style="font-size: 13px; color: #e8eaf6;">Imorgon</span>
                            <span style="font-size: 15px; font-weight: 700; color: #81c784;">+${formatCurrency(data.dailyBudget * 2)}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                            <span style="font-size: 13px; color: #e8eaf6;">I √∂vermorgon</span>
                            <span style="font-size: 15px; font-weight: 700; color: #81c784;">+${formatCurrency(data.dailyBudget * 3)}</span>
                        </div>
                    </div>

                    <!-- Senaste Sparade Dagar - kompakt -->
                    ${recentSaved.length > 0 ? `
                        <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 12px; padding: 14px;">
                            <div style="font-size: 11px; color: #9fa8da; text-transform: uppercase; font-weight: 600; margin-bottom: 10px;">‚úÖ Senaste sparade</div>
                            ${recentSaved.map(day => {
                                const date = new Date(day.date);
                                const dateStr = date.toLocaleDateString('sv-SE', { weekday: 'short', day: 'numeric', month: 'short' });
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                        <span style="font-size: 12px; color: #e8eaf6; text-transform: capitalize;">${dateStr}</span>
                                        <span style="font-size: 12px; font-weight: 700; color: #81c784;">+${formatCurrency(day.amount)}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <!-- Info Modal -->
                <div id="infoModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 1000; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 20px; padding: 28px; max-width: 360px; width: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: 700; color: #e8eaf6;">‚ÑπÔ∏è S√• fungerar det</h3>
                            <button onclick="closeInfoModal()" style="background: none; border: none; color: #9fa8da; font-size: 24px; cursor: pointer; padding: 4px;">‚úï</button>
                        </div>
                        <ul style="font-size: 14px; color: #9fa8da; line-height: 1.8; padding-left: 20px; margin: 0;">
                            <li>Streaken r√§knar dagar i rad utan nya utgifter</li>
                            <li style="margin-top: 8px;">Baseras alltid p√• senaste m√•naden: <strong style="color: #667eea;">${data.monthName}</strong></li>
                            <li style="margin-top: 8px;">Dagligt sparande = Kvar att anv√§nda (${formatCurrency(data.remaining)}) √∑ dagar i m√•naden</li>
                            <li style="margin-top: 8px;">Vid midnatt (00:00) l√§ggs dagens sparande till totalen</li>
                            <li style="margin-top: 8px;">N√§r du registrerar en utgift b√∂rjar streaken om fr√•n 0</li>
                        </ul>
                        <button onclick="closeInfoModal()" class="primary-button" style="margin-top: 24px; margin-bottom: 0;">F√∂rst√•tt!</button>
                    </div>
                </div>
            `;
        }

        // Svenska kommuner med skattesatser 2026
        const SWEDISH_MUNICIPALITIES = [
            {name: "Ale", tax: 32.80}, {name: "Alings√•s", tax: 32.84}, {name: "Alvesta", tax: 33.42}, {name: "Aneby", tax: 33.85},
            {name: "Arboga", tax: 33.12}, {name: "Arjeplog", tax: 34.08}, {name: "Arvidsjaur", tax: 33.85}, {name: "Arvika", tax: 33.69},
            {name: "Askersund", tax: 33.42}, {name: "Avesta", tax: 33.49}, {name: "Bengtsfors", tax: 34.04}, {name: "Berg", tax: 34.09},
            {name: "Bjurholm", tax: 34.63}, {name: "Bjuv", tax: 32.23}, {name: "Boden", tax: 33.71}, {name: "Bollebygd", tax: 32.66},
            {name: "Bolln√§s", tax: 33.12}, {name: "Borgholm", tax: 33.28}, {name: "Borl√§nge", tax: 33.41}, {name: "Bor√•s", tax: 32.59},
            {name: "Botkyrka", tax: 32.23}, {name: "Boxholm", tax: 32.52}, {name: "Brom√∂lla", tax: 33.14}, {name: "Br√§cke", tax: 34.39},
            {name: "Burl√∂v", tax: 32.14}, {name: "B√•stad", tax: 31.30}, {name: "Dals-Ed", tax: 34.34}, {name: "Danderyd", tax: 30.18},
            {name: "Degerfors", tax: 35.25}, {name: "Dorotea", tax: 35.65}, {name: "Eda", tax: 33.89}, {name: "Eker√∂", tax: 30.28},
            {name: "Eksj√∂", tax: 32.75}, {name: "Emmaboda", tax: 33.16}, {name: "Enk√∂ping", tax: 32.57}, {name: "Eskilstuna", tax: 32.52},
            {name: "Esl√∂v", tax: 32.04}, {name: "Essunga", tax: 32.73}, {name: "Fagersta", tax: 33.07}, {name: "Falkenberg", tax: 32.09},
            {name: "Falk√∂ping", tax: 32.78}, {name: "Falun", tax: 32.91}, {name: "Filipstad", tax: 34.10}, {name: "Finsp√•ng", tax: 33.02},
            {name: "Flen", tax: 33.22}, {name: "Forshaga", tax: 33.89}, {name: "F√§rgelanda", tax: 33.39}, {name: "Gagnef", tax: 33.21},
            {name: "Gislaved", tax: 32.55}, {name: "Gnesta", tax: 32.72}, {name: "Gnosj√∂", tax: 32.25}, {name: "Gotland", tax: 33.60},
            {name: "Grums", tax: 33.89}, {name: "Gr√§storp", tax: 32.73}, {name: "Gullsp√•ng", tax: 33.28}, {name: "G√§llivare", tax: 33.46},
            {name: "G√§vle", tax: 33.26}, {name: "G√∂teborg", tax: 32.40}, {name: "G√∂tene", tax: 33.23}, {name: "Habo", tax: 32.45},
            {name: "Hagfors", tax: 34.19}, {name: "Hallsberg", tax: 33.12}, {name: "Hallstahammar", tax: 33.07}, {name: "Halmstad", tax: 32.18},
            {name: "Hammar√∂", tax: 33.54}, {name: "Haninge", tax: 31.15}, {name: "Haparanda", tax: 33.71}, {name: "Heby", tax: 33.42},
            {name: "Hedemora", tax: 33.61}, {name: "Helsingborg", tax: 31.44}, {name: "Herrljunga", tax: 32.83}, {name: "Hjo", tax: 32.93},
            {name: "Hofors", tax: 33.56}, {name: "Huddinge", tax: 31.33}, {name: "Hudiksvall", tax: 33.02}, {name: "Hultsfred", tax: 33.16},
            {name: "Hylte", tax: 32.39}, {name: "H√•bo", tax: 32.22}, {name: "H√§llefors", tax: 34.05}, {name: "H√§rjedalen", tax: 34.09},
            {name: "H√§rn√∂sand", tax: 34.08}, {name: "H√§rryda", tax: 31.68}, {name: "H√§ssleholm", tax: 32.20}, {name: "H√∂gan√§s", tax: 31.11},
            {name: "H√∂gsby", tax: 33.71}, {name: "H√∂rby", tax: 32.23}, {name: "H√∂√∂r", tax: 31.87}, {name: "Jokkmokk", tax: 33.75},
            {name: "J√§rf√§lla", tax: 30.68}, {name: "J√∂nk√∂ping", tax: 32.55}, {name: "Kalix", tax: 33.71}, {name: "Kalmar", tax: 32.81},
            {name: "Karlsborg", tax: 32.48}, {name: "Karlshamn", tax: 32.64}, {name: "Karlskoga", tax: 33.47}, {name: "Karlskrona", tax: 32.84},
            {name: "Karlstad", tax: 33.19}, {name: "Katrineholm", tax: 32.62}, {name: "Kil", tax: 33.54}, {name: "Kinda", tax: 33.27},
            {name: "Kiruna", tax: 33.34}, {name: "Klippan", tax: 32.38}, {name: "Knivsta", tax: 31.82}, {name: "Kramfors", tax: 34.33},
            {name: "Kristianstad", tax: 32.41}, {name: "Kristinehamn", tax: 33.54}, {name: "Krokom", tax: 34.04}, {name: "Kumla", tax: 32.92},
            {name: "Kungsbacka", tax: 32.03}, {name: "Kungs√∂r", tax: 33.07}, {name: "Kung√§lv", tax: 32.55}, {name: "K√§vlinge", tax: 31.11},
            {name: "K√∂ping", tax: 33.07}, {name: "Laholm", tax: 32.59}, {name: "Landskrona", tax: 32.39}, {name: "Lax√•", tax: 33.94},
            {name: "Lekeberg", tax: 32.42}, {name: "Leksand", tax: 32.91}, {name: "Lerum", tax: 31.98}, {name: "Lessebo", tax: 33.46},
            {name: "Liding√∂", tax: 29.67}, {name: "Lidk√∂ping", tax: 32.53}, {name: "Lilla Edet", tax: 33.38}, {name: "Lindesberg", tax: 33.37},
            {name: "Link√∂ping", tax: 32.02}, {name: "Ljungby", tax: 32.68}, {name: "Ljusdal", tax: 33.67}, {name: "Ljusnarsberg", tax: 33.62},
            {name: "Lomma", tax: 30.74}, {name: "Ludvika", tax: 33.71}, {name: "Lule√•", tax: 33.23}, {name: "Lund", tax: 31.84},
            {name: "Lycksele", tax: 34.68}, {name: "Lysekil", tax: 33.43}, {name: "Malm√∂", tax: 32.42}, {name: "Malung-S√§len", tax: 33.56},
            {name: "Mal√•", tax: 34.68}, {name: "Mariestad", tax: 32.73}, {name: "Mark", tax: 32.63}, {name: "Markaryd", tax: 32.73},
            {name: "Mellerud", tax: 33.91}, {name: "Mj√∂lby", tax: 32.52}, {name: "Mora", tax: 33.16}, {name: "Motala", tax: 32.72},
            {name: "Mullsj√∂", tax: 32.80}, {name: "Munkedal", tax: 33.98}, {name: "Munkfors", tax: 34.29}, {name: "M√∂lndal", tax: 31.88},
            {name: "M√∂nster√•s", tax: 33.01}, {name: "M√∂rbyl√•nga", tax: 32.93}, {name: "Nacka", tax: 30.08}, {name: "Nora", tax: 33.17},
            {name: "Norberg", tax: 33.67}, {name: "Nordanstig", tax: 33.27}, {name: "Nordmaling", tax: 34.48}, {name: "Norrk√∂ping", tax: 32.52},
            {name: "Norrt√§lje", tax: 31.18}, {name: "Norsj√∂", tax: 34.73}, {name: "Nybro", tax: 33.31}, {name: "Nykvarn", tax: 30.98},
            {name: "Nyk√∂ping", tax: 32.47}, {name: "Nyn√§shamn", tax: 31.63}, {name: "N√§ssj√∂", tax: 33.30}, {name: "Ockelbo", tax: 33.46},
            {name: "Olofstr√∂m", tax: 33.04}, {name: "Orsa", tax: 33.26}, {name: "Orust", tax: 32.88}, {name: "Osby", tax: 33.46},
            {name: "Oskarshamn", tax: 33.06}, {name: "Ovan√•ker", tax: 33.22}, {name: "Oxel√∂sund", tax: 32.72}, {name: "Pajala", tax: 33.66},
            {name: "Partille", tax: 31.78}, {name: "Perstorp", tax: 32.33}, {name: "Pite√•", tax: 33.33}, {name: "Ragunda", tax: 34.49},
            {name: "Robertsfors", tax: 34.63}, {name: "Ronneby", tax: 33.04}, {name: "R√§ttvik", tax: 32.81}, {name: "Sala", tax: 33.07},
            {name: "Salem", tax: 30.73}, {name: "Sandviken", tax: 33.06}, {name: "Sigtuna", tax: 31.53}, {name: "Simrishamn", tax: 32.43},
            {name: "Sj√∂bo", tax: 32.29}, {name: "Skara", tax: 32.78}, {name: "Skellefte√•", tax: 33.08}, {name: "Skinnskatteberg", tax: 33.37},
            {name: "Skurup", tax: 32.09}, {name: "Sk√∂vde", tax: 32.58}, {name: "Smedjebacken", tax: 33.51}, {name: "Sollefte√•", tax: 34.33},
            {name: "Sollentuna", tax: 29.70}, {name: "Solna", tax: 29.63}, {name: "Sorsele", tax: 34.68}, {name: "Soten√§s", tax: 33.23},
            {name: "Staffanstorp", tax: 31.24}, {name: "Stenungsund", tax: 32.38}, {name: "Stockholm", tax: 30.33}, {name: "Storfors", tax: 34.09},
            {name: "Storuman", tax: 34.68}, {name: "Str√§ngn√§s", tax: 32.27}, {name: "Str√∂mstad", tax: 33.48}, {name: "Str√∂msund", tax: 34.39},
            {name: "Sundbyberg", tax: 30.63}, {name: "Sundsvall", tax: 33.48}, {name: "Sunne", tax: 33.84}, {name: "Surahammar", tax: 33.07},
            {name: "Sval√∂v", tax: 32.34}, {name: "Svedala", tax: 31.74}, {name: "Svenljunga", tax: 32.93}, {name: "S√§ffle", tax: 33.79},
            {name: "S√§ter", tax: 33.11}, {name: "S√§vsj√∂", tax: 32.70}, {name: "S√∂derhamn", tax: 33.42}, {name: "S√∂derk√∂ping", tax: 32.77},
            {name: "S√∂dert√§lje", tax: 31.58}, {name: "S√∂lvesborg", tax: 32.76}, {name: "Tanum", tax: 33.48}, {name: "Tibro", tax: 32.78},
            {name: "Tidaholm", tax: 32.83}, {name: "Tierp", tax: 32.67}, {name: "Timr√•", tax: 33.63}, {name: "Tingsryd", tax: 33.46},
            {name: "Tj√∂rn", tax: 32.68}, {name: "Tomelilla", tax: 32.54}, {name: "Torsby", tax: 34.09}, {name: "Tors√•s", tax: 33.46},
            {name: "Tranemo", tax: 32.53}, {name: "Tran√•s", tax: 32.60}, {name: "Trelleborg", tax: 32.19}, {name: "Trollh√§ttan", tax: 32.93},
            {name: "Trosa", tax: 31.72}, {name: "Tyres√∂", tax: 30.83}, {name: "T√§by", tax: 29.68}, {name: "T√∂reboda", tax: 33.08},
            {name: "Uddevalla", tax: 33.28}, {name: "Ulricehamn", tax: 32.58}, {name: "Ume√•", tax: 34.08}, {name: "Upplands V√§sby", tax: 30.98},
            {name: "Upplands-Bro", tax: 30.88}, {name: "Uppsala", tax: 32.77}, {name: "Uppvidinge", tax: 33.26}, {name: "Vadstena", tax: 33.02},
            {name: "Vaggeryd", tax: 32.50}, {name: "Valdemarsvik", tax: 33.57}, {name: "Vallentuna", tax: 30.23}, {name: "Vansbro", tax: 33.66},
            {name: "Vara", tax: 32.38}, {name: "Varberg", tax: 31.68}, {name: "Vaxholm", tax: 30.68}, {name: "Vellinge", tax: 29.69},
            {name: "Vetlanda", tax: 33.10}, {name: "Vilhelmina", tax: 35.00}, {name: "Vimmerby", tax: 33.16}, {name: "Vindeln", tax: 34.58},
            {name: "Ving√•ker", tax: 33.37}, {name: "V√•rg√•rda", tax: 32.88}, {name: "V√§nersborg", tax: 33.38}, {name: "V√§nn√§s", tax: 34.43},
            {name: "V√§rmd√∂", tax: 30.48}, {name: "V√§rnamo", tax: 32.45}, {name: "V√§stervik", tax: 33.36}, {name: "V√§ster√•s", tax: 32.57},
            {name: "V√§xj√∂", tax: 32.79}, {name: "Ydre", tax: 33.57}, {name: "Ystad", tax: 31.84}, {name: "√Öm√•l", tax: 33.78},
            {name: "√Önge", tax: 34.38}, {name: "√Öre", tax: 33.59}, {name: "√Örj√§ng", tax: 33.94}, {name: "√Ösele", tax: 35.10},
            {name: "√Östorp", tax: 32.24}, {name: "√Ötvidaberg", tax: 33.22}, {name: "√Ñlmhult", tax: 33.06}, {name: "√Ñlvdalen", tax: 33.26},
            {name: "√Ñlvkarleby", tax: 32.87}, {name: "√Ñlvsbyn", tax: 33.31}, {name: "√Ñngelholm", tax: 31.79}, {name: "√ñcker√∂", tax: 32.38},
            {name: "√ñdesh√∂g", tax: 33.17}, {name: "√ñrebro", tax: 32.72}, {name: "√ñrkelljunga", tax: 32.43}, {name: "√ñrnsk√∂ldsvik", tax: 34.03},
            {name: "√ñstersund", tax: 33.69}, {name: "√ñster√•ker", tax: 28.93}, {name: "√ñsthammar", tax: 32.82}, {name: "√ñstra G√∂inge", tax: 32.98},
            {name: "√ñverkalix", tax: 33.71}, {name: "√ñvertorne√•", tax: 33.71}
        ].sort((a, b) => a.name.localeCompare(b.name, 'sv'));

        // Prisbasbelopp 2026
        const PBB_2026 = 58800;
        const EMPLOYER_FEE = 0.3142; // 31.42%
        const STATE_TAX_RATE = 0.20; // 20%
        const STATE_TAX_THRESHOLD = 625800; // Skiktgr√§ns 2026 (ungef√§rlig)
        const BURIAL_FEE = 0.00293; // 0.293%
        const CHURCH_FEE_AVG = 0.01; // ca 1%

        function calculateGrundavdrag(yearlyIncome, birthYear) {
            const currentYear = new Date().getFullYear();
            const age = currentYear - birthYear;
            const isOver66 = age >= 66;
            
            // F√∂renklad ber√§kning av grundavdrag
            if (yearlyIncome <= 0) return 0;
            
            const pbb = PBB_2026;
            
            if (isOver66) {
                // F√∂rh√∂jt grundavdrag f√∂r 66+
                if (yearlyIncome <= 1.11 * pbb) return 0.99 * pbb;
                if (yearlyIncome <= 3.21 * pbb) return 0.77 * pbb + 0.2 * yearlyIncome;
                if (yearlyIncome <= 7.88 * pbb) return 1.415 * pbb;
                return 0.293 * pbb;
            } else {
                // Vanligt grundavdrag
                if (yearlyIncome <= 0.99 * pbb) return 0.423 * pbb;
                if (yearlyIncome <= 2.72 * pbb) return 0.423 * pbb + 0.2 * (yearlyIncome - 0.99 * pbb);
                if (yearlyIncome <= 3.11 * pbb) return 0.77 * pbb;
                if (yearlyIncome <= 7.88 * pbb) return 0.77 * pbb + 0.1 * (yearlyIncome - 3.11 * pbb);
                return 0.293 * pbb;
            }
        }

        function calculateJobbskatteavdrag(yearlyIncome, communalTax, birthYear) {
            const currentYear = new Date().getFullYear();
            const age = currentYear - birthYear;
            const isOver66 = age >= 66;
            
            const pbb = PBB_2026;
            const ga = calculateGrundavdrag(yearlyIncome, birthYear);
            const ki = communalTax / 100; // Kommunal skattesats som decimal
            
            // F√∂renklad jobbskatteavdragsber√§kning
            if (yearlyIncome <= 0) return 0;
            
            const ai = yearlyIncome; // Arbetsinkomst
            
            if (isOver66) {
                // F√∂rh√∂jt jobbskatteavdrag f√∂r 66+
                if (ai <= 1.0 * pbb) return (ai - ga) * ki;
                if (ai <= 3.0 * pbb) return (1.0 * pbb - ga + 0.35 * (ai - 1.0 * pbb)) * ki;
                if (ai <= 7.88 * pbb) return (1.0 * pbb - ga + 0.7 * pbb + 0.10 * (ai - 3.0 * pbb)) * ki;
                return (1.0 * pbb - ga + 0.7 * pbb + 0.488 * pbb) * ki;
            } else {
                // Vanligt jobbskatteavdrag (f√∂renklad 2026)
                if (ai <= 0.91 * pbb) return (ai - ga) * ki;
                if (ai <= 3.24 * pbb) return (0.91 * pbb - ga + 0.342 * (ai - 0.91 * pbb)) * ki;
                if (ai <= 8.08 * pbb) return (0.91 * pbb - ga + 0.797 * pbb + 0.128 * (ai - 3.24 * pbb)) * ki;
                return (0.91 * pbb - ga + 0.797 * pbb + 0.620 * pbb) * ki;
            }
        }

        function calculateSalaryAfterTax() {
            const s = state.salaryAfterTax;
            if (!s.municipality) return null;
            
            const muni = SWEDISH_MUNICIPALITIES.find(m => m.name === s.municipality);
            if (!muni) return null;
            
            // Ber√§kna bruttol√∂n per m√•nad
            let monthlyGross = 0;
            if (s.incomeType === 'monthly') {
                monthlyGross = s.grossSalary || 0;
            } else {
                monthlyGross = (s.hourlyRate || 0) * (s.hoursWorked || 0);
            }
            
            if (monthlyGross <= 0) return null;
            
            const yearlyGross = monthlyGross * 12;
            const communalTax = muni.tax;
            
            // Arbetsgivaravgifter (31.42%)
            const employerFee = monthlyGross * EMPLOYER_FEE;
            const totalEmployerCost = monthlyGross + employerFee;
            
            // Grundavdrag
            const yearlyGrundavdrag = calculateGrundavdrag(yearlyGross, s.birthYear);
            const monthlyGrundavdrag = yearlyGrundavdrag / 12;
            
            // Beskattningsbar inkomst
            const yearlyTaxableIncome = Math.max(0, yearlyGross - yearlyGrundavdrag);
            const monthlyTaxableIncome = yearlyTaxableIncome / 12;
            
            // Kommunalskatt
            const monthlyCommunalTax = monthlyTaxableIncome * (communalTax / 100);
            
            // Statlig skatt (om √∂ver skiktgr√§nsen)
            let monthlyStateTax = 0;
            if (yearlyGross > STATE_TAX_THRESHOLD) {
                const yearlyAboveThreshold = yearlyGross - STATE_TAX_THRESHOLD;
                monthlyStateTax = (yearlyAboveThreshold / 12) * STATE_TAX_RATE;
            }
            
            // Jobbskatteavdrag
            const yearlyJobbskatteavdrag = calculateJobbskatteavdrag(yearlyGross, communalTax, s.birthYear);
            const monthlyJobbskatteavdrag = yearlyJobbskatteavdrag / 12;
            
            // Begravningsavgift (ca 0.258%)
            const monthlyBurialFee = monthlyTaxableIncome * BURIAL_FEE;
            
            // Kyrkoavgift
            const monthlyChurchFee = s.churchMember ? monthlyTaxableIncome * CHURCH_FEE_AVG : 0;
            
            // Public service-avgift (1% av beskattningsbar inkomst, max 1523 kr/√•r = 127 kr/m√•n)
            const PUBLIC_SERVICE_FEE = 0.01;
            const PUBLIC_SERVICE_MAX_YEARLY = 1523;
            const yearlyPublicServiceFee = Math.min(yearlyTaxableIncome * PUBLIC_SERVICE_FEE, PUBLIC_SERVICE_MAX_YEARLY);
            const monthlyPublicServiceFee = yearlyPublicServiceFee / 12;
            
            // Skattereduktion f√∂r f√∂rv√§rvsinkomst (1500 kr/√•r = 125 kr/m√•n f√∂r de flesta)
            const FORVARVSINKOMST_REDUCTION = 1500 / 12;
            const monthlyForvarvsinkomstReduction = monthlyGross > 0 ? FORVARVSINKOMST_REDUCTION : 0;
            
            // Total skatt f√∂re avdrag
            const totalTaxBeforeDeductions = monthlyCommunalTax + monthlyStateTax + monthlyBurialFee + monthlyChurchFee + monthlyPublicServiceFee;
            
            // Slutlig skatt efter alla avdrag
            const totalReductions = monthlyJobbskatteavdrag + monthlyForvarvsinkomstReduction;
            const finalTax = Math.max(0, totalTaxBeforeDeductions - totalReductions);
            
            // Nettol√∂n
            const netSalary = monthlyGross - finalTax;
            
            // Skatteeffekt i procent
            const effectiveTaxRate = (finalTax / monthlyGross) * 100;
            
            // Summa skatter (alla avdrag som dras)
            const totalSkatter = monthlyCommunalTax + monthlyStateTax + monthlyBurialFee + monthlyChurchFee + monthlyPublicServiceFee;
            
            return {
                monthlyGross: Math.round(monthlyGross),
                yearlyGross: Math.round(yearlyGross),
                employerFee: Math.round(employerFee),
                totalEmployerCost: Math.round(totalEmployerCost),
                grundavdrag: Math.round(monthlyGrundavdrag),
                taxableIncome: Math.round(monthlyTaxableIncome),
                communalTax: Math.round(monthlyCommunalTax),
                communalTaxRate: communalTax,
                stateTax: Math.round(monthlyStateTax),
                jobbskatteavdrag: Math.round(monthlyJobbskatteavdrag),
                burialFee: Math.round(monthlyBurialFee),
                churchFee: Math.round(monthlyChurchFee),
                publicServiceFee: Math.round(monthlyPublicServiceFee),
                forvarvsinkomstReduction: Math.round(monthlyForvarvsinkomstReduction),
                totalTax: Math.round(finalTax),
                totalSkatter: Math.round(totalSkatter),
                netSalary: Math.round(netSalary),
                effectiveTaxRate: effectiveTaxRate.toFixed(1),
                municipality: s.municipality
            };
        }

        function selectMunicipality(value) {
            // Hitta matchande kommun
            const muni = SWEDISH_MUNICIPALITIES.find(m => 
                m.name.toLowerCase() === value.toLowerCase() || 
                m.name === value ||
                value.includes(m.name)
            );
            
            if (muni) {
                state.salaryAfterTax.municipality = muni.name;
                saveState();
                render();
            }
        }
        
        function updateSalaryCalc() {
            const s = state.salaryAfterTax;
            
            if (s.incomeType === 'monthly') {
                s.grossSalary = parseFloat(document.getElementById('salaryInput')?.value) || 0;
            } else {
                s.hourlyRate = parseFloat(document.getElementById('hourlyInput')?.value) || 0;
                s.hoursWorked = parseFloat(document.getElementById('hoursInput')?.value) || 160;
            }
            
            // Kommun hanteras av selectMunicipality
            s.birthYear = parseInt(document.getElementById('birthYearInput')?.value) || 1990;
            s.churchMember = document.getElementById('churchCheckbox')?.checked || false;
            
            saveState();
            render();
        }

        function renderSalaryAfterTax() {
            const s = state.salaryAfterTax;
            const result = calculateSalaryAfterTax();
            
            const municipalityOptions = SWEDISH_MUNICIPALITIES.map(m => 
                `<option value="${m.name}" ${s.municipality === m.name ? 'selected' : ''}>${m.name} (${m.tax.toFixed(2)}%)</option>`
            ).join('');
            
            // Generera f√∂delse√•r (1940-2010)
            const birthYearOptions = [];
            for (let year = 2010; year >= 1940; year--) {
                birthYearOptions.push(`<option value="${year}" ${s.birthYear === year ? 'selected' : ''}>${year}</option>`);
            }

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('budget')">‚Üê</button>
                        </div>
                        <h2>L√∂n efter skatt</h2>
                        <div class="view-header-right">
                            <button class="icon-button" onclick="openAIChat()">ü§ñ</button>
                        </div>
                    </div>

                    <!-- Inkomsttyp tabs -->
                    <div style="display: flex; gap: 6px; margin-bottom: 12px;">
                        <button style="flex: 1; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 600; border: 2px solid ${s.incomeType === 'monthly' ? 'rgba(102, 126, 234, 0.5)' : 'rgba(159, 168, 218, 0.2)'}; background: ${s.incomeType === 'monthly' ? 'rgba(102, 126, 234, 0.2)' : 'transparent'}; color: #e8eaf6; cursor: pointer;" onclick="state.salaryAfterTax.incomeType = 'monthly'; render()">
                            üí∞ M√•nadsl√∂n
                        </button>
                        <button style="flex: 1; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 600; border: 2px solid ${s.incomeType === 'hourly' ? 'rgba(102, 126, 234, 0.5)' : 'rgba(159, 168, 218, 0.2)'}; background: ${s.incomeType === 'hourly' ? 'rgba(102, 126, 234, 0.2)' : 'transparent'}; color: #e8eaf6; cursor: pointer;" onclick="state.salaryAfterTax.incomeType = 'hourly'; render()">
                            ‚è±Ô∏è Timl√∂n
                        </button>
                    </div>

                    <!-- Inmatningsf√§lt - kompakt -->
                    <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 12px; padding: 14px; margin-bottom: 12px;">
                        ${s.incomeType === 'monthly' ? `
                            <div style="margin-bottom: 12px;">
                                <label style="font-size: 11px; color: #9fa8da; display: block; margin-bottom: 4px; font-weight: 600;">Bruttol√∂n per m√•nad</label>
                                <input type="number" id="salaryInput" value="${s.grossSalary || ''}" placeholder="35000" onchange="updateSalaryCalc()" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 10px 12px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 16px; font-weight: 600;">
                            </div>
                        ` : `
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; color: #9fa8da; display: block; margin-bottom: 4px; font-weight: 600;">Timl√∂n (kr)</label>
                                    <input type="number" id="hourlyInput" value="${s.hourlyRate || ''}" placeholder="180" onchange="updateSalaryCalc()" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 10px 12px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 16px; font-weight: 600;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; color: #9fa8da; display: block; margin-bottom: 4px; font-weight: 600;">Timmar/m√•n</label>
                                    <input type="number" id="hoursInput" value="${s.hoursWorked || 160}" placeholder="160" onchange="updateSalaryCalc()" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 10px 12px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 16px; font-weight: 600;">
                                </div>
                            </div>
                        `}
                        
                        <div style="margin-bottom: 12px;">
                            <label style="font-size: 11px; color: #9fa8da; display: block; margin-bottom: 4px; font-weight: 600;">üìç Kommun</label>
                            <input type="text" id="municipalityInput" list="municipalityList" value="${s.municipality}" placeholder="Skriv kommun..." onchange="selectMunicipality(this.value)" oninput="selectMunicipality(this.value)" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 10px 12px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 14px;">
                            <datalist id="municipalityList">
                                ${municipalityOptions}
                            </datalist>
                        </div>

                        <div style="display: flex; gap: 8px;">
                            <div style="flex: 1;">
                                <label style="font-size: 11px; color: #9fa8da; display: block; margin-bottom: 4px; font-weight: 600;">üéÇ F√∂delse√•r</label>
                                <select id="birthYearInput" onchange="updateSalaryCalc()" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 10px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 14px;">
                                    ${birthYearOptions.join('')}
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 11px; color: #9fa8da; display: block; margin-bottom: 4px; font-weight: 600;">‚õ™ Kyrkan</label>
                                <div style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 10px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                    <input type="checkbox" id="churchCheckbox" ${s.churchMember ? 'checked' : ''} onchange="updateSalaryCalc()" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: #e8eaf6; font-size: 13px;">Medlem</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${result ? `
                        <!-- Nettol√∂n stor display -->
                        <div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(56, 142, 60, 0.1) 100%); border: 2px solid rgba(76, 175, 80, 0.4); border-radius: 14px; padding: 16px; text-align: center; margin-bottom: 12px;">
                            <div style="font-size: 11px; color: #81c784; text-transform: uppercase; font-weight: 600;">üíµ Din l√∂n efter skatt</div>
                            <div style="font-size: 36px; font-weight: 800; color: #81c784; margin: 8px 0;">${formatCurrency(result.netSalary)}</div>
                            <div style="font-size: 12px; color: #9fa8da;">per m√•nad i ${result.municipality}</div>
                        </div>
                        
                        <!-- Arbetsgivaren betalar - som i bilden -->
                        <div style="background: rgba(0, 128, 128, 0.15); border-radius: 8px; padding: 12px; margin-bottom: 2px;">
                            <div style="display: flex; justify-content: space-between;">
                                <div style="font-size: 13px; font-weight: 700; color: #26a69a;">Arbetsgivaren betalar f√∂r dig</div>
                                <div style="font-size: 13px; font-weight: 700; color: #26a69a;">${formatCurrency(result.totalEmployerCost)}</div>
                            </div>
                        </div>
                        
                        <!-- Skattetabell som i bilden -->
                        <div style="background: rgba(30, 35, 60, 0.8); border-radius: 12px; overflow: hidden; margin-bottom: 12px;">
                            <!-- Arbetsgivaravgift -->
                            <div style="display: flex; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <div style="font-size: 13px; color: #9fa8da;">Arbetsgivaravgift</div>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <span style="color: #9fa8da;">‚àí</span>
                                    <span style="font-size: 13px; color: #e8eaf6; min-width: 80px; text-align: right;">${formatCurrency(result.employerFee)}</span>
                                </div>
                            </div>
                            
                            <!-- Din bruttol√∂n -->
                            <div style="display: flex; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid rgba(159, 168, 218, 0.1); background: rgba(159, 168, 218, 0.05);">
                                <div style="font-size: 13px; font-weight: 700; color: #e8eaf6;">Din bruttol√∂n</div>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <span style="color: #9fa8da;">=</span>
                                    <span style="font-size: 13px; font-weight: 700; color: #e8eaf6; min-width: 80px; text-align: right;">${formatCurrency(result.monthlyGross)}</span>
                                </div>
                            </div>
                            
                            <!-- Kommunalskatt -->
                            <div style="display: flex; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <div style="font-size: 13px; color: #9fa8da;">Kommunalskatt</div>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <span style="color: #9fa8da;">‚àí</span>
                                    <span style="font-size: 13px; color: #e8eaf6; min-width: 80px; text-align: right;">${formatCurrency(result.communalTax)}</span>
                                </div>
                            </div>
                            
                            <!-- Statlig inkomstskatt -->
                            <div style="display: flex; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <div style="font-size: 13px; color: #9fa8da;">Statlig inkomstskatt</div>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <span style="color: #9fa8da;">‚àí</span>
                                    <span style="font-size: 13px; color: #e8eaf6; min-width: 80px; text-align: right;">${formatCurrency(result.stateTax)}</span>
                                </div>
                            </div>
                            
                            <!-- Pensionsavgift -->
                            <div style="display: flex; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <div style="font-size: 13px; color: #9fa8da;">Pensionsavgift, netto</div>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <span style="color: #9fa8da;">‚àí</span>
                                    <span style="font-size: 13px; color: #e8eaf6; min-width: 80px; text-align: right;">0 kr</span>
                                </div>
                            </div>
                            
                            <!-- Jobbskatteavdrag -->
                            <div style="display: flex; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <div style="font-size: 13px; color: #9fa8da;">Jobbskatteavdrag</div>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <span style="color: #81c784;">+</span>
                                    <span style="font-size: 13px; color: #81c784; min-width: 80px; text-align: right;">${formatCurrency(result.jobbskatteavdrag)}</span>
                                </div>
                            </div>
                            
                            <!-- Begravningsavgift -->
                            <div style="display: flex; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <div style="font-size: 13px; color: #9fa8da;">Begravningsavgift</div>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <span style="color: #9fa8da;">‚àí</span>
                                    <span style="font-size: 13px; color: #e8eaf6; min-width: 80px; text-align: right;">${formatCurrency(result.burialFee)}</span>
                                </div>
                            </div>
                            
                            <!-- Public service-avgift -->
                            <div style="display: flex; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <div style="font-size: 13px; color: #9fa8da;">Public service-avgift</div>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <span style="color: #9fa8da;">‚àí</span>
                                    <span style="font-size: 13px; color: #e8eaf6; min-width: 80px; text-align: right;">${formatCurrency(result.publicServiceFee)}</span>
                                </div>
                            </div>
                            
                            ${result.churchFee > 0 ? `
                            <!-- Kyrkoavgift -->
                            <div style="display: flex; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <div style="font-size: 13px; color: #9fa8da;">Kyrkoavgift</div>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <span style="color: #9fa8da;">‚àí</span>
                                    <span style="font-size: 13px; color: #e8eaf6; min-width: 80px; text-align: right;">${formatCurrency(result.churchFee)}</span>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Skattereduktion f√∂r sjuk/aktivitetsers√§ttning -->
                            <div style="display: flex; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <div style="font-size: 13px; color: #9fa8da;">Skattereduktion f√∂r sjuk/aktivitetsers</div>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <span style="color: #81c784;">+</span>
                                    <span style="font-size: 13px; color: #e8eaf6; min-width: 80px; text-align: right;">0 kr</span>
                                </div>
                            </div>
                            
                            <!-- Skattereduktion f√∂rv√§rvsinkomst -->
                            <div style="display: flex; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <div style="font-size: 13px; color: #9fa8da;">Skattereduktion f√∂rv√§rvsinkomst</div>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <span style="color: #81c784;">+</span>
                                    <span style="font-size: 13px; color: #81c784; min-width: 80px; text-align: right;">${formatCurrency(result.forvarvsinkomstReduction)}</span>
                                </div>
                            </div>
                            
                            <!-- P√• ditt l√∂nebesked -->
                            <div style="display: flex; justify-content: space-between; padding: 12px 14px; background: rgba(0, 128, 128, 0.2);">
                                <div style="font-size: 13px; font-weight: 700; color: #26a69a;">P√• ditt l√∂nebesked</div>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <span style="color: #26a69a;">=</span>
                                    <span style="font-size: 13px; font-weight: 700; color: #26a69a; min-width: 80px; text-align: right;">${formatCurrency(result.netSalary)}</span>
                                </div>
                            </div>
                            
                            <!-- Summa skatter -->
                            <div style="display: flex; justify-content: space-between; padding: 12px 14px; background: rgba(0, 128, 128, 0.3);">
                                <div style="font-size: 13px; font-weight: 700; color: #26a69a;">Summa skatter</div>
                                <div style="font-size: 13px; font-weight: 700; color: #26a69a; min-width: 80px; text-align: right;">${formatCurrency(result.totalSkatter)}</div>
                            </div>
                        </div>
                        
                        <!-- √Örlig √∂versikt -->
                        <div style="background: rgba(255, 152, 0, 0.08); border: 2px solid rgba(255, 152, 0, 0.2); border-radius: 12px; padding: 14px;">
                            <div style="font-size: 11px; color: #ff9800; text-transform: uppercase; font-weight: 600; margin-bottom: 10px;">üìÖ P√• √•rsbasis</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 10px; color: #9fa8da;">√Örsl√∂n brutto</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #e8eaf6;">${formatCurrency(result.monthlyGross * 12)}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 10px; color: #9fa8da;">√Örsl√∂n netto</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #81c784;">${formatCurrency(result.netSalary * 12)}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 10px; color: #9fa8da;">Total skatt/√•r</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #ef5350;">${formatCurrency(result.totalTax * 12)}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 10px; color: #9fa8da;">Arb.givarkostnad/√•r</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #667eea;">${formatCurrency(result.totalEmployerCost * 12)}</div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 12px; padding: 24px; text-align: center;">
                            <div style="font-size: 36px; margin-bottom: 12px;">üí∞</div>
                            <div style="font-size: 14px; color: #9fa8da;">Fyll i l√∂n och kommun f√∂r att se din nettol√∂n</div>
                        </div>
                    `}
                </div>
                ${getBottomNav('salaryAfterTax')}
                
                <!-- Info Modal - kompakt -->
                <div id="infoModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 1000; align-items: center; justify-content: center; padding: 12px;">
                    <div style="background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 16px; padding: 20px; max-width: 340px; width: 100%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
                            <h3 style="font-size: 16px; font-weight: 700; color: #e8eaf6;">‚ÑπÔ∏è Om skatteber√§kningen</h3>
                            <button onclick="closeInfoModal()" style="background: none; border: none; color: #9fa8da; font-size: 20px; cursor: pointer; padding: 4px;">‚úï</button>
                        </div>
                        <div style="font-size: 12px; color: #9fa8da; line-height: 1.6;">
                            <p style="margin-bottom: 12px;"><strong style="color: #e8eaf6;">Vad ing√•r?</strong><br>
                            Kommunalskatt, statlig skatt, grundavdrag, jobbskatteavdrag, begravningsavgift och kyrkoavgift.</p>
                            
                            <p style="margin-bottom: 12px;"><strong style="color: #667eea;">Kommunalskatt</strong><br>
                            28,93% (√ñster√•ker) till 35,65% (Dorotea). Snitt: 32,38%.</p>
                            
                            <p style="margin-bottom: 12px;"><strong style="color: #667eea;">Statlig skatt</strong><br>
                            20% p√• √•rsinkomst √∂ver ~625 800 kr.</p>
                            
                            <p style="margin-bottom: 12px;"><strong style="color: #81c784;">Jobbskatteavdrag</strong><br>
                            Minskar skatten med upp till ~4 400 kr/m√•n.</p>
                            
                            <p style="margin-bottom: 0;"><strong style="color: #ff9800;">Arbetsgivaravgift</strong><br>
                            31,42% ut√∂ver din l√∂n.</p>
                        </div>
                        <button onclick="closeInfoModal()" class="primary-button" style="margin-top: 16px; margin-bottom: 0; padding: 12px;">F√∂rst√•tt!</button>
                    </div>
                </div>
            `;
        }

        function renderHistory() {
            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('budget')">‚Üê</button>
                        </div>
                        <h2>${t('history')}</h2>
                        <div class="view-header-right"></div>
                    </div>
                    
                    ${state.months && state.months.length > 0 ? state.months.map(month => {
                        const spent = Object.values(month.categories).reduce((sum, cat) => sum + cat.items.reduce((s, item) => s + item.amount, 0), 0);
                        const extraIncome = getExtraIncome(month);
                        const totalIncome = month.income + extraIncome;
                        const isSimple = isMonthSimpleMode(month);
                        const isCurrentMonth = state.currentMonth && state.currentMonth.monthKey === month.monthKey;
                        return `
                            <div class="history-month" style="cursor: default;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                    <div>
                                        <h3 style="margin-bottom: 4px;">${month.displayDate}</h3>
                                        <div style="font-size: 11px; color: #667eea; text-transform: uppercase;">${isSimple ? 'üìä Enkel modell' : 'üìà Procentmodell'}${isCurrentMonth ? ' ‚Ä¢ <span style="color: #81c784;">Aktiv</span>' : ''}</div>
                                    </div>
                                </div>
                                <div class="history-month-stats">
                                    <div style="margin-bottom: 8px;">
                                        <span style="color: #9fa8da; font-size: 12px;">INKOMST:</span> <span style="font-weight: 700; color: #667eea;">${formatCurrency(totalIncome)}</span>
                                        ${extraIncome > 0 ? `<span style="font-size: 11px; color: #81c784;"> (+${formatCurrency(extraIncome)} extra)</span>` : ''}
                                    </div>
                                    <div style="margin-bottom: 16px;">
                                        <span style="color: #9fa8da; font-size: 12px;">UTGIFTER:</span> <span style="font-weight: 700; color: #667eea;">${formatCurrency(spent)}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="selectMonth('${month.monthKey}')" style="flex: 1; background: rgba(102, 126, 234, 0.15); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 12px; color: #667eea; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease;">
                                        ‚úèÔ∏è Redigera
                                    </button>
                                    <button onclick="confirmDeleteMonth('${month.monthKey}', '${month.displayDate}')" style="flex: 1; background: rgba(239, 83, 80, 0.1); border: 2px solid rgba(239, 83, 80, 0.3); border-radius: 10px; padding: 12px; color: #ef5350; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease;">
                                        üóëÔ∏è Radera
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('') : '<p style="color: #9fa8da; text-align: center; padding: 32px 0;">Ingen historik √§nnu</p>'}
                </div>
                
                <!-- Delete Confirmation Modal -->
                <div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%); border: 2px solid rgba(239, 83, 80, 0.4); border-radius: 20px; padding: 28px; max-width: 340px; width: 100%; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                        <h3 style="font-size: 20px; font-weight: 700; color: #e8eaf6; margin-bottom: 12px;">Radera m√•nad?</h3>
                        <p id="deleteModalText" style="font-size: 14px; color: #9fa8da; margin-bottom: 24px;">√Ñr du s√§ker p√• att du vill radera denna m√•nad? Detta g√•r inte att √•ngra.</p>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeDeleteModal()" style="flex: 1; background: rgba(159, 168, 218, 0.1); border: 2px solid rgba(159, 168, 218, 0.3); border-radius: 12px; padding: 14px; color: #9fa8da; cursor: pointer; font-size: 15px; font-weight: 600;">
                                Avbryt
                            </button>
                            <button id="confirmDeleteBtn" onclick="" style="flex: 1; background: rgba(239, 83, 80, 0.2); border: 2px solid rgba(239, 83, 80, 0.5); border-radius: 12px; padding: 14px; color: #ef5350; cursor: pointer; font-size: 15px; font-weight: 700;">
                                Radera
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEditExpenses() {
            if (!state.currentMonth) return;
            
            // Definiera utgiftskategorier f√∂r sortering (korta namn utan emojis f√∂r tabs)
            const expenseCategories = {
                'sparande': { name: 'Sparande', shortName: 'Spar', color: '#81c784' },
                'fasta': { name: 'Fast', shortName: 'Fast', color: '#ef5350' },
                'prenumerationer': { name: 'Abo', shortName: 'Abo', color: '#9c27b0' },
                'ovrigt': { name: '√ñvrigt', shortName: '√ñvr', color: '#ff9800' }
            };
            
            // H√§mta alla utgifter
            let allExpenses = [];
            Object.entries(state.currentMonth.categories).forEach(([key, cat]) => {
                cat.items.forEach(item => {
                    allExpenses.push({ 
                        ...item, 
                        category: key, 
                        categoryName: cat.name,
                        expenseType: item.expenseType || 'ovrigt' 
                    });
                });
            });
            
            // Aktuellt filter
            const currentFilter = state.expenseFilter || 'all';
            
            // Filtrera utgifter
            const filteredExpenses = currentFilter === 'all' 
                ? allExpenses 
                : allExpenses.filter(e => e.expenseType === currentFilter);
            
            // R√§kna per kategori
            const categoryCounts = {
                'sparande': allExpenses.filter(e => e.expenseType === 'sparande').length,
                'fasta': allExpenses.filter(e => e.expenseType === 'fasta').length,
                'prenumerationer': allExpenses.filter(e => e.expenseType === 'prenumerationer').length,
                'ovrigt': allExpenses.filter(e => e.expenseType === 'ovrigt').length
            };

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('budget')">‚Üê</button>
                        </div>
                        <h2>Utgifter</h2>
                        <div class="view-header-right">
                            <button class="icon-button" onclick="showAddExpenseModal()">+</button>
                        </div>
                    </div>
                    
                    <!-- Filter tabs - kompakta -->
                    <div style="display: flex; gap: 4px; margin-bottom: 12px;">
                        <button onclick="state.expenseFilter = 'all'; render();" style="flex: 1; padding: 8px 4px; border-radius: 8px; font-size: 10px; font-weight: 600; border: none; cursor: pointer; ${currentFilter === 'all' ? 'background: rgba(102, 126, 234, 0.3); color: #e8eaf6;' : 'background: rgba(159, 168, 218, 0.1); color: #9fa8da;'}">
                            Alla<br><span style="font-size: 12px;">${allExpenses.length}</span>
                        </button>
                        ${Object.entries(expenseCategories).map(([key, cat]) => `
                            <button onclick="state.expenseFilter = '${key}'; render();" style="flex: 1; padding: 8px 4px; border-radius: 8px; font-size: 10px; font-weight: 600; border: none; cursor: pointer; ${currentFilter === key ? `background: ${cat.color}30; color: ${cat.color};` : 'background: rgba(159, 168, 218, 0.1); color: #9fa8da;'}">
                                ${cat.shortName}<br><span style="font-size: 12px;">${categoryCounts[key]}</span>
                            </button>
                        `).join('')}
                    </div>
                    
                    ${filteredExpenses.length > 0 ? `
                        <div style="margin-bottom: 14px;">
                            ${filteredExpenses.map(expense => {
                                const typeInfo = expenseCategories[expense.expenseType] || expenseCategories.ovrigt;
                                return `
                                <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-left: 3px solid ${typeInfo.color}; border-radius: 12px; padding: 12px; margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <select onchange="updateExpenseType('${expense.category}', ${expense.id}, this.value)" style="background: rgba(10, 14, 39, 0.4); border: 1px solid rgba(159, 168, 218, 0.2); border-radius: 6px; padding: 4px 8px; color: ${typeInfo.color}; font-size: 10px; font-weight: 600;">
                                            ${Object.entries(expenseCategories).map(([key, cat]) => `
                                                <option value="${key}" ${expense.expenseType === key ? 'selected' : ''}>${cat.name}</option>
                                            `).join('')}
                                        </select>
                                        <button style="background: none; border: none; color: #ef5350; font-size: 16px; cursor: pointer; padding: 4px;" onclick="deleteExpense('${expense.category}', ${expense.id})">‚úï</button>
                                    </div>
                                    
                                    <div style="display: flex; gap: 8px;">
                                        <input type="text" value="${expense.name}" onchange="updateExpenseName('${expense.category}', ${expense.id}, this.value)" placeholder="Namn" style="flex: 2; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 8px; color: #e8eaf6; font-family: inherit; font-size: 14px;">
                                        <input type="number" value="${expense.amount}" onchange="updateExpenseAmount('${expense.category}', ${expense.id}, this.value)" placeholder="Kr" style="flex: 1; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 8px; color: #e8eaf6; font-family: inherit; font-size: 14px; text-align: right;">
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                        <div style="font-size: 12px; color: #9fa8da; text-align: center; padding: 8px 0;">
                            Totalt: <strong style="color: #667eea;">${formatCurrency(filteredExpenses.reduce((s,e) => s + e.amount, 0))}</strong> (${filteredExpenses.length} poster)
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 32px 0;">
                            <div style="font-size: 48px; margin-bottom: 12px;">üìù</div>
                            <p style="color: #9fa8da; margin-bottom: 16px;">${currentFilter === 'all' ? 'Inga utgifter √§nnu' : 'Inga utgifter i denna kategori'}</p>
                            <button onclick="showAddExpenseModal()" class="primary-button" style="width: auto; padding: 12px 24px;">+ L√§gg till</button>
                        </div>
                    `}
                </div>
                
                <!-- Add Expense Modal -->
                <div id="addExpenseModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 16px;">
                    <div style="background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 16px; padding: 20px; max-width: 360px; width: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="font-size: 16px; font-weight: 700; color: #e8eaf6;">Ny utgift</h3>
                            <button onclick="closeAddExpenseModal()" style="background: none; border: none; color: #9fa8da; font-size: 20px; cursor: pointer;">‚úï</button>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="font-size: 11px; color: #9fa8da; display: block; margin-bottom: 4px;">Namn</label>
                            <input type="text" id="newExpenseName" placeholder="T.ex. Spotify" style="width: 100%; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 14px;">
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="font-size: 11px; color: #9fa8da; display: block; margin-bottom: 4px;">Belopp (kr)</label>
                            <input type="number" id="newExpenseAmount" placeholder="0" style="width: 100%; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 14px;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 11px; color: #9fa8da; display: block; margin-bottom: 4px;">Typ</label>
                            <select id="newExpenseType" style="width: 100%; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 14px;">
                                <option value="ovrigt">√ñvrigt</option>
                                <option value="fasta">Fast kostnad</option>
                                <option value="prenumerationer">Abonnemang</option>
                                <option value="sparande">Sparande</option>
                            </select>
                        </div>
                        
                        <button onclick="addExpenseFromModal()" class="primary-button" style="margin-bottom: 0;">L√§gg till</button>
                    </div>
                </div>
                ${getBottomNav('editExpenses')}
            `;
        }
        
        // Hj√§lpfunktioner f√∂r utgiftshantering
        function showAddExpenseModal() {
            document.getElementById('addExpenseModal').style.display = 'flex';
        }
        
        function closeAddExpenseModal() {
            document.getElementById('addExpenseModal').style.display = 'none';
        }
        
        function addExpenseFromModal() {
            const name = document.getElementById('newExpenseName').value;
            const amount = parseFloat(document.getElementById('newExpenseAmount').value) || 0;
            const expenseType = document.getElementById('newExpenseType').value;
            
            if (!name || amount <= 0) {
                alert('Ange namn och belopp');
                return;
            }
            
            // L√§gg till i utgifter-kategorin
            const category = state.currentMonth.categories.utgifter || state.currentMonth.categories.fasta;
            const categoryKey = state.currentMonth.categories.utgifter ? 'utgifter' : 'fasta';
            
            const newItem = {
                id: Date.now(),
                name: name,
                amount: amount,
                expenseType: expenseType
            };
            
            state.currentMonth.categories[categoryKey].items.push(newItem);
            saveState();
            closeAddExpenseModal();
            render();
        }
        
        function updateExpenseType(categoryKey, expenseId, newType) {
            const item = state.currentMonth.categories[categoryKey].items.find(i => i.id === expenseId);
            if (item) {
                item.expenseType = newType;
                saveState();
                render();
            }
        }

        function renderCategory() {
            if (!state.selectedCategory || !state.currentMonth) return;
            const key = state.selectedCategory.key;
            const cat = state.currentMonth.categories[key];
            const spent = cat.items.reduce((sum, item) => sum + item.amount, 0);
            
            // FIX: Ber√§kna budget korrekt f√∂r b√•de simple och percentage mode
            const isSimple = isMonthSimpleMode(state.currentMonth);
            const extraIncome = getExtraIncome(state.currentMonth);
            const totalIncome = state.currentMonth.income + extraIncome;
            
            let budget, remaining;
            if (isSimple) {
                budget = totalIncome;
                remaining = totalIncome - spent;
            } else {
                budget = totalIncome * (cat.percentage / 100);
                remaining = budget - spent;
            }
            
            const isOverBudget = remaining < 0;
            const warningThreshold = budget * 0.1;
            const isWarning = remaining >= 0 && remaining <= warningThreshold;

            let statusColor = '#81c784';
            let psychoText = 'Okej, jag kan ta en lunch idag';

            if (isOverBudget) {
                statusColor = '#e57373';
                psychoText = 'Fyfan, nu √§r jag fattig...';
            } else if (isWarning) {
                statusColor = '#ffa726';
                psychoText = 'Aj aj nu blir det matl√•dor';
            }

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('budget')">‚Üê</button>
                        </div>
                        <h2>${cat.name}</h2>
                        <div class="view-header-right"></div>
                    </div>

                    <div class="total-card" style="margin-bottom: 24px;">
                        <h3>Status</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                            <div>
                                <div style="font-size: 12px; color: #9fa8da; margin-bottom: 4px;">${isSimple ? 'Total inkomst' : 'Budget'}</div>
                                <div style="font-size: 18px; font-weight: 700;">${formatCurrency(budget)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #9fa8da; margin-bottom: 4px;">Anv√§nt</div>
                                <div style="font-size: 18px; font-weight: 700;">${formatCurrency(spent)}</div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(159, 168, 218, 0.1); text-align: center;">
                            <div style="font-size: 12px; color: ${statusColor}; margin-bottom: 8px; font-weight: 600;">${isOverBudget ? '√ñVERSTIGER BUDGET' : 'KVAR ATT ANV√ÑNDA'}</div>
                            <div style="font-size: 24px; font-weight: 700; color: ${statusColor};">${formatCurrency(Math.abs(remaining))}</div>
                        </div>
                    </div>

                    ${state.editingItem && state.editingItem.key === key ? `
                        <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 24px; display: flex; gap: 10px; align-items: flex-end;">
                            <input type="text" id="editName" value="${state.editingItem.name}" placeholder="Namn" style="flex: 0.5; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 13px;">
                            <input type="number" id="editAmount" value="${state.editingItem.amount}" placeholder="Belopp" style="flex: 0.3; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 13px; min-width: 80px;" min="1">
                            <button type="button" class="primary-button" style="padding: 10px 18px; font-size: 13px; margin: 0;" onclick="saveEditingItem('${key}')">Uppdatera</button>
                            <button type="button" style="background: rgba(159, 168, 218, 0.1); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px 16px; color: #9fa8da; cursor: pointer; font-size: 13px; font-weight: 600;" onclick="cancelEditing()">Avbryt</button>
                        </div>
                    ` : `
                        <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 24px; display: flex; gap: 10px; align-items: flex-end;">
                            <input type="text" id="expenseName" placeholder="Namn" style="flex: 0.5; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 13px;">
                            <input type="number" id="expenseAmount" placeholder="Belopp" style="flex: 0.3; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 13px; min-width: 80px;" min="1">
                            <button type="button" class="primary-button" style="padding: 10px 18px; font-size: 13px; margin: 0;" onclick="addExpenseQuick('${key}')">L√§gg till</button>
                        </div>
                    `}

                    <h3 style="font-size: 14px; color: #9fa8da; margin-bottom: 16px; font-weight: 600; text-transform: uppercase; margin-top: 32px;">Sparade utgifter (${cat.items.length})</h3>
                    <div style="margin-bottom: 32px;">
                        ${cat.items.map(item => `
                            <div class="expense-item" style="align-items: center;">
                                <span class="expense-name">${item.name}</span>
                                <span class="expense-amount">${formatCurrency(item.amount)}</span>
                                <button type="button" style="background: none; border: none; cursor: pointer; font-size: 16px; padding: 6px; color: #667eea; opacity: 0.7; transition: all 0.2s ease;" onclick="editExpense('${key}', ${item.id})" onmouseover="this.style.opacity='1';" onmouseout="this.style.opacity='0.7';">‚úèÔ∏è</button>
                                <button class="delete-button" onclick="deleteExpense('${key}', ${item.id})">üóëÔ∏è</button>
                            </div>
                        `).join('')}
                    </div>

                    <button class="primary-button" onclick="goTo('budget')" style="width: 100%;">‚úì Klart</button>
                </div>
            `;
            if (!state.editingItem || state.editingItem.key !== key) {
                document.getElementById('expenseName')?.focus();
            } else {
                document.getElementById('editName')?.focus();
            }
        }

        function addExpenseQuick(key) {
            const nameInput = document.getElementById('expenseName');
            const amountInput = document.getElementById('expenseAmount');
            
            if (!nameInput || !amountInput) return;
            
            const name = nameInput.value.trim();
            const amount = parseFloat(amountInput.value);
            
            if (!name || !amount || amount <= 0 || isNaN(amount)) {
                alert('Fyll i ett giltigt namn och belopp');
                return;
            }

            if (!state.currentMonth || !state.currentMonth.categories[key]) {
                alert('Fel: Kategorin hittades inte');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            
            const newExpense = {
                id: Date.now() + Math.floor(Math.random() * 10000),
                name: name,
                amount: amount,
                date: today // Spara datum f√∂r streak-funktionen
            };
            
            state.currentMonth.categories[key].items.push(newExpense);
            
            // Bryt streak - registrera att en utgift lades till idag
            state.noSpendStreak.lastExpenseDate = today;
            state.noSpendStreak.streakStartDate = null; // √Öterst√§ll streak
            
            saveState();
            render();
            
            setTimeout(() => {
                const newNameInput = document.getElementById('expenseName');
                if (newNameInput) {
                    newNameInput.focus();
                }
            }, 0);
        }

        // HANDLERS
        function goTo(view) { state.view = view; saveState(); render(); }
        function goToCategory(key) { state.selectedCategory = { key, ...state.currentMonth.categories[key] }; goTo('category'); }
        
        function resetForNewMonth() {
            state.currentMonth = null;
            state.selectedCategory = null;
            state.showExtraIncomeForm = false;
            state.pendingIncome = 0;
            state.pendingMonth = new Date().getMonth() + 1;
            state.pendingYear = new Date().getFullYear();
            state.totalResultView = 'month';
            goTo('createIncome');
        }

        function selectBudgetModel(model) {
            state.budgetModel = model;
            if (model === 'recommended') {
                state.customPercentages = { fasta: 50, nojen: 30, sparande: 20 };
            } else if (model === 'simple') {
                state.customPercentages = { fasta: 0, nojen: 0, sparande: 0 };
            }
        }

        function updateCustomPercentage(category, value) {
            state.customPercentages[category] = Math.max(0, Math.min(100, parseInt(value) || 0));
            render();
        }

        function createBudgetWithDate() {
            const income = state.pendingIncome;
            const month = state.pendingMonth;
            const year = state.pendingYear;
            
            if (!income || income <= 0) {
                alert('Ange en giltig inkomst');
                return;
            }

            const monthNames = ['', 'Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni', 'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'];
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            const displayDate = month > 0 ? `${monthNames[month]} ${year}` : `${year}`;

            let newMonth;
            
            if (state.budgetModel === 'simple') {
                // FIX: Spara budgetModel med m√•naden
                newMonth = {
                    monthKey, displayDate, income, extraIncome: 0,
                    budgetModel: 'simple', // FIX: Spara modellen
                    categories: {
                        utgifter: { name: 'Utgifter', percentage: 0, budget: income, items: [] }
                    }
                };
            } else {
                // FIX: Spara budgetModel med m√•naden
                newMonth = {
                    monthKey, displayDate, income, extraIncome: 0,
                    budgetModel: state.budgetModel, // FIX: Spara modellen
                    customPercentages: { ...state.customPercentages }, // FIX: Spara procentsatserna
                    categories: {
                        fasta: { name: t('fixedCosts'), percentage: state.customPercentages.fasta, budget: income * (state.customPercentages.fasta / 100), items: [] },
                        nojen: { name: t('fun'), percentage: state.customPercentages.nojen, budget: income * (state.customPercentages.nojen / 100), items: [] },
                        sparande: { name: t('savings'), percentage: state.customPercentages.sparande, budget: income * (state.customPercentages.sparande / 100), items: [] }
                    }
                };
            }

            if (!state.months) {
                state.months = [];
            }

            const existingIndex = state.months.findIndex(m => m.monthKey === monthKey);
            if (existingIndex >= 0) {
                state.months[existingIndex] = newMonth;
            } else {
                state.months.push(newMonth);
                state.months.sort((a, b) => a.monthKey.localeCompare(b.monthKey));
            }

            state.currentMonth = newMonth;
            state.priceToTime.incomeType = 'monthly';
            state.priceToTime.incomeAmount = income;
            saveState();
            goTo('budget');
        }

        function toggleExtraIncome() {
            state.showExtraIncomeForm = !state.showExtraIncomeForm;
            render();
            if (state.showExtraIncomeForm) {
                setTimeout(() => {
                    const input = document.getElementById('extraIncomeInput');
                    if (input) input.focus();
                }, 100);
            }
        }

        function removeExtraIncome() {
            // FIX: Uppdatera endast currentMonth, inte en separat state.extraIncome
            if (state.currentMonth) {
                state.currentMonth.extraIncome = 0;
            }
            state.showExtraIncomeForm = false;
            saveState();
            render();
        }

        function cancelExtraIncome() {
            state.showExtraIncomeForm = false;
            render();
        }

        // FIX: Uppdaterad updateMainIncome som fungerar f√∂r b√•de simple och percentage mode
        function updateMainIncome(newIncome) {
            const income = parseFloat(newIncome);
            if (income && income > 0 && state.currentMonth) {
                state.currentMonth.income = income;
                
                // FIX: Uppdatera budget baserat p√• budgetmodellen
                const isSimple = isMonthSimpleMode(state.currentMonth);
                
                if (isSimple) {
                    // I simple mode, s√§tt utgifter-budget till hela inkomsten
                    if (state.currentMonth.categories.utgifter) {
                        const extraIncome = getExtraIncome(state.currentMonth);
                        state.currentMonth.categories.utgifter.budget = income + extraIncome;
                    }
                } else {
                    // I percentage mode, uppdatera varje kategori baserat p√• procent
                    const extraIncome = getExtraIncome(state.currentMonth);
                    const totalIncome = income + extraIncome;
                    
                    Object.keys(state.currentMonth.categories).forEach(key => {
                        const cat = state.currentMonth.categories[key];
                        cat.budget = totalIncome * (cat.percentage / 100);
                    });
                }
                
                saveState();
                render();
            }
        }

        // FIX: Uppdaterad saveExtraIncome som sparar till currentMonth
        function saveExtraIncome() {
            const input = document.getElementById('extraIncomeInput');
            if (input && state.currentMonth) {
                const value = parseFloat(input.value);
                if (value > 0) {
                    state.currentMonth.extraIncome = value;
                    state.showExtraIncomeForm = false;
                    
                    // FIX: Uppdatera budgetar baserat p√• ny total inkomst
                    const isSimple = isMonthSimpleMode(state.currentMonth);
                    const totalIncome = state.currentMonth.income + value;
                    
                    if (isSimple) {
                        if (state.currentMonth.categories.utgifter) {
                            state.currentMonth.categories.utgifter.budget = totalIncome;
                        }
                    } else {
                        Object.keys(state.currentMonth.categories).forEach(key => {
                            const cat = state.currentMonth.categories[key];
                            cat.budget = totalIncome * (cat.percentage / 100);
                        });
                    }
                    
                    saveState();
                    render();
                } else {
                    input.focus();
                }
            }
        }

        function addExpense(key, e) {
            e.preventDefault();
            const name = document.getElementById('expenseName').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            if (!name || !amount) return;
            
            const today = new Date().toISOString().split('T')[0];
            state.currentMonth.categories[key].items.push({ 
                id: Date.now(), 
                name, 
                amount,
                date: today 
            });
            
            // Bryt streak
            state.noSpendStreak.lastExpenseDate = today;
            state.noSpendStreak.streakStartDate = null;
            
            saveState();
            goTo('category');
        }

        function startEditingItem(key, id, name, amount) {
            state.editingItem = { key, id, name, amount };
            render();
        }

        function editExpense(key, id) {
            if (!state.currentMonth || !state.currentMonth.categories[key]) return;
            
            const item = state.currentMonth.categories[key].items.find(i => i.id === id);
            if (item) {
                state.editingItem = { key, id, name: item.name, amount: item.amount };
                render();
            }
        }

        function saveEditingItem(key) {
            const nameInput = document.getElementById('editName');
            const amountInput = document.getElementById('editAmount');
            
            if (!nameInput || !amountInput) return;
            
            const name = nameInput.value.trim();
            const amount = parseFloat(amountInput.value);
            
            if (!name || !amount || amount <= 0 || isNaN(amount)) {
                alert('Fyll i ett giltigt namn och belopp');
                return;
            }

            if (!state.currentMonth || !state.currentMonth.categories[key]) {
                alert('Fel: Kategorin hittades inte');
                return;
            }

            const item = state.currentMonth.categories[key].items.find(i => i.id === state.editingItem.id);
            if (item) {
                item.name = name;
                item.amount = amount;
                state.editingItem = null;
                saveState();
                render();
            } else {
                alert('Fel: Utgiften hittades inte');
            }
        }

        function cancelEditing() {
            state.editingItem = null;
            render();
        }

        function saveMonthAndGo() {
            if (!state.currentMonth) {
                alert('Ingen m√•nad att spara!');
                return;
            }
            
            if (!state.months) {
                state.months = [];
            }
            
            const existingIndex = state.months.findIndex(m => m.monthKey === state.currentMonth.monthKey);
            if (existingIndex >= 0) {
                state.months[existingIndex] = { ...state.currentMonth };
            } else {
                state.months.push({ ...state.currentMonth });
                state.months.sort((a, b) => a.monthKey.localeCompare(b.monthKey));
            }
            
            saveState();
            alert(`‚úÖ ${state.currentMonth.displayDate} har sparats!`);
            goTo('totalResult');
        }

        function deleteExpense(key, id) {
            state.currentMonth.categories[key].items = state.currentMonth.categories[key].items.filter(i => i.id !== id);
            saveState();
            render();
        }

        function saveExpenseTemplate() {
            if (!state.currentMonth) return;
            let template = {};
            Object.entries(state.currentMonth.categories).forEach(([key, cat]) => {
                template[key] = cat.items.map(item => ({ ...item }));
            });
            state.savedExpenseTemplate = template;
            saveState();
        }

        function applyExpenseTemplate() {
            if (!state.savedExpenseTemplate || !state.currentMonth) return;
            Object.entries(state.savedExpenseTemplate).forEach(([key, items]) => {
                if (state.currentMonth.categories[key]) {
                    state.currentMonth.categories[key].items = items.map(item => ({
                        ...item,
                        id: Date.now() + Math.random()
                    }));
                }
            });
            saveState();
        }

        function updateExpenseName(key, id, newName) {
            const item = state.currentMonth.categories[key].items.find(i => i.id === id);
            if (item && newName.trim()) {
                item.name = newName;
                saveState();
                render();
            }
        }

        function updateExpenseAmount(key, id, newAmount) {
            const item = state.currentMonth.categories[key].items.find(i => i.id === id);
            if (item && parseFloat(newAmount) > 0) {
                item.amount = parseFloat(newAmount);
                saveState();
                render();
            }
        }

        function moveExpense(fromKey, id, toKey) {
            if (fromKey === toKey) return;
            
            const item = state.currentMonth.categories[fromKey].items.find(i => i.id === id);
            if (item) {
                state.currentMonth.categories[fromKey].items = state.currentMonth.categories[fromKey].items.filter(i => i.id !== id);
                state.currentMonth.categories[toKey].items.push(item);
                saveState();
                render();
            }
        }

        function saveSettings() { saveState(); goTo('profile'); }

        // Radera m√•nad funktioner
        function confirmDeleteMonth(monthKey, displayDate) {
            const modal = document.getElementById('deleteModal');
            const modalText = document.getElementById('deleteModalText');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            modalText.textContent = `√Ñr du s√§ker p√• att du vill radera "${displayDate}"? Detta g√•r inte att √•ngra.`;
            confirmBtn.setAttribute('onclick', `deleteMonth('${monthKey}')`);
            modal.style.display = 'flex';
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }
        
        function showInfoModal(type) {
            const modal = document.getElementById('infoModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        function closeInfoModal() {
            const modal = document.getElementById('infoModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Mr. Monly - AI Ekonomi-r√•dgivare
        let aiChatHistory = [];
        
        // ‚ö†Ô∏è VIKTIGT: S√§tt din API-nyckel h√§r f√∂r att aktivera Mr. Monly
        // H√§mta din nyckel fr√•n: https://console.anthropic.com/
        const ANTHROPIC_API_KEY = ''; // L√§gg in din nyckel mellan citattecknen
        
        function openAIChat() {
            // H√§mta anv√§ndardata f√∂r Mr. Monly
            let expensesSummary = '';
            if (state.currentMonth) {
                const categories = state.currentMonth.categories;
                Object.entries(categories).forEach(([key, cat]) => {
                    if (cat.items && cat.items.length > 0) {
                        expensesSummary += cat.name + ': ';
                        expensesSummary += cat.items.map(i => i.name + ' ' + i.amount + ' kr').join(', ') + '. ';
                    }
                });
            }
            
            const modal = document.createElement('div');
            modal.id = 'aiChatModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%); padding: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(102, 126, 234, 0.3);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">üé©</div>
                            <div>
                                <div style="font-size: 16px; font-weight: 700; color: #e8eaf6;">Mr. Monly</div>
                                <div style="font-size: 11px; color: #81c784;">Din personliga ekonomir√•dgivare</div>
                            </div>
                        </div>
                        <button onclick="closeAIChat()" style="background: none; border: none; color: #9fa8da; font-size: 24px; cursor: pointer;">‚úï</button>
                    </div>
                    
                    <div id="aiChatMessages" style="flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px;">
                        <div style="background: rgba(102, 126, 234, 0.15); border-radius: 12px 12px 12px 0; padding: 14px; max-width: 90%;">
                            <div style="font-size: 13px; color: #e8eaf6; line-height: 1.6;">
                                Hej, jag √§r <strong>Mr. Monly</strong> üëã
                                <br><br>
                                Jag hj√§lper dig att f√• full kontroll p√• din ekonomi ‚Äì utan kr√•ngel.
                                <br><br>
                                ${state.currentMonth ? `Jag ser att du har registrerat utgifter f√∂r <strong>${state.currentMonth.displayDate}</strong>. Vill du att jag analyserar dem och ger dig konkreta tips p√• hur du kan spara mer?` : 'Vill du b√∂rja med att ber√§tta om dina utgifter, eller ska vi prata om dina ekonomiska m√•l f√∂rst?'}
                                <br><br>
                                üí∞ <strong>Analysera utgifter</strong> - Hitta besparingar<br>
                                üéØ <strong>S√§tta m√•l</strong> - Sparande, bostad, trygghet<br>
                                üìä <strong>Budgetr√•d</strong> - Optimera din ekonomi<br>
                                üß† <strong>Pengapsykologi</strong> - B√§ttre vanor
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 12px; background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%); border-top: 1px solid rgba(102, 126, 234, 0.3); padding-bottom: max(12px, env(safe-area-inset-bottom));">
                        ${!ANTHROPIC_API_KEY ? `
                            <div style="background: rgba(255, 152, 0, 0.2); border: 1px solid rgba(255, 152, 0, 0.4); border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                                <div style="font-size: 11px; color: #ff9800; line-height: 1.4;">
                                    ‚ö†Ô∏è <strong>API-nyckel saknas!</strong><br>
                                    F√∂r att aktivera Mr. Monly, √∂ppna filen och l√§gg in din Anthropic API-nyckel i variabeln <code>ANTHROPIC_API_KEY</code>.<br>
                                    <a href="https://console.anthropic.com/" target="_blank" style="color: #667eea;">H√§mta nyckel h√§r ‚Üí</a>
                                </div>
                            </div>
                        ` : ''}
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="aiChatInput" placeholder="St√§ll en fr√•ga till Mr. Monly..." onkeypress="if(event.key==='Enter')sendAIMessage()" style="flex: 1; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 20px; padding: 12px 16px; color: #e8eaf6; font-family: inherit; font-size: 14px;" ${!ANTHROPIC_API_KEY ? 'disabled' : ''}>
                            <button onclick="sendAIMessage()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 50%; width: 44px; height: 44px; color: white; font-size: 18px; cursor: pointer; opacity: ${!ANTHROPIC_API_KEY ? '0.5' : '1'};" ${!ANTHROPIC_API_KEY ? 'disabled' : ''}>‚û§</button>
                        </div>
                        <div style="display: flex; gap: 6px; margin-top: 10px; overflow-x: auto; padding-bottom: 4px;">
                            <button onclick="askQuickQuestion('Analysera mina utgifter och ge mig konkreta spartips')" style="flex-shrink: 0; background: rgba(102, 126, 234, 0.2); border: none; border-radius: 16px; padding: 8px 12px; color: #a8b8f0; font-size: 11px; cursor: pointer;" ${!ANTHROPIC_API_KEY ? 'disabled' : ''}>üìä Analysera utgifter</button>
                            <button onclick="askQuickQuestion('Vilka prenumerationer och abonnemang borde jag se √∂ver?')" style="flex-shrink: 0; background: rgba(102, 126, 234, 0.2); border: none; border-radius: 16px; padding: 8px 12px; color: #a8b8f0; font-size: 11px; cursor: pointer;" ${!ANTHROPIC_API_KEY ? 'disabled' : ''}>üì± Prenumerationer</button>
                            <button onclick="askQuickQuestion('Hur mycket borde jag spara varje m√•nad?')" style="flex-shrink: 0; background: rgba(102, 126, 234, 0.2); border: none; border-radius: 16px; padding: 8px 12px; color: #a8b8f0; font-size: 11px; cursor: pointer;" ${!ANTHROPIC_API_KEY ? 'disabled' : ''}>üí∞ Sparande</button>
                            <button onclick="askQuickQuestion('Hj√§lp mig s√§tta ekonomiska m√•l')" style="flex-shrink: 0; background: rgba(102, 126, 234, 0.2); border: none; border-radius: 16px; padding: 8px 12px; color: #a8b8f0; font-size: 11px; cursor: pointer;" ${!ANTHROPIC_API_KEY ? 'disabled' : ''}>üéØ S√§tta m√•l</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            if (ANTHROPIC_API_KEY) {
                document.getElementById('aiChatInput').focus();
            }
        }
        
        function closeAIChat() {
            const modal = document.getElementById('aiChatModal');
            if (modal) modal.remove();
            aiChatHistory = []; // Rensa historik n√§r chatten st√§ngs
        }
        
        function askQuickQuestion(question) {
            if (!ANTHROPIC_API_KEY) return;
            document.getElementById('aiChatInput').value = question;
            sendAIMessage();
        }
        
        async function sendAIMessage() {
            if (!ANTHROPIC_API_KEY) {
                alert('Du m√•ste l√§gga in din Anthropic API-nyckel f√∂r att anv√§nda Mr. Monly. √ñppna HTML-filen och hitta variabeln ANTHROPIC_API_KEY.');
                return;
            }
            
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            if (!message) return;
            
            input.value = '';
            
            // L√§gg till anv√§ndarens meddelande
            const messagesDiv = document.getElementById('aiChatMessages');
            messagesDiv.innerHTML += `
                <div style="background: rgba(102, 126, 234, 0.3); border-radius: 12px 12px 0 12px; padding: 12px; max-width: 85%; align-self: flex-end;">
                    <div style="font-size: 13px; color: #e8eaf6;">${message}</div>
                </div>
            `;
            
            // Visa laddningsindikator
            const loadingId = 'loading-' + Date.now();
            messagesDiv.innerHTML += `
                <div id="${loadingId}" style="background: rgba(102, 126, 234, 0.15); border-radius: 12px 12px 12px 0; padding: 12px; max-width: 85%;">
                    <div style="font-size: 13px; color: #9fa8da;">üé© Mr. Monly t√§nker...</div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Bygg detaljerad anv√§ndarkontext
            let userContext = '';
            if (state.currentMonth) {
                const income = state.currentMonth.income;
                const extraIncome = state.currentMonth.extraIncome || 0;
                const totalIncome = income + extraIncome;
                
                let totalSpent = 0;
                let expenseDetails = [];
                
                Object.entries(state.currentMonth.categories).forEach(([key, cat]) => {
                    if (cat.items && cat.items.length > 0) {
                        const catTotal = cat.items.reduce((s, i) => s + i.amount, 0);
                        totalSpent += catTotal;
                        cat.items.forEach(item => {
                            expenseDetails.push(item.name + ': ' + item.amount + ' kr' + (item.expenseType ? ' (' + item.expenseType + ')' : ''));
                        });
                    }
                });
                
                const remaining = totalIncome - totalSpent;
                
                userContext = `
ANV√ÑNDARENS EKONOMISKA DATA (${state.currentMonth.displayDate}):
- M√•nadsinkomst: ${income} kr
${extraIncome > 0 ? '- Extra inkomst: ' + extraIncome + ' kr' : ''}
- Total inkomst: ${totalIncome} kr
- Totala utgifter: ${totalSpent} kr
- Kvar att spendera: ${remaining} kr
- Sparkvot: ${totalIncome > 0 ? Math.round((remaining / totalIncome) * 100) : 0}%

REGISTRERADE UTGIFTER:
${expenseDetails.length > 0 ? expenseDetails.join('\n') : 'Inga utgifter registrerade √§nnu.'}
`;
            }
            
            if (state.salaryAfterTax.grossSalary) {
                userContext += `\nBRUTTOL√ñN: ${state.salaryAfterTax.grossSalary} kr/m√•n`;
            }
            if (state.salaryAfterTax.municipality) {
                userContext += `\nKOMMUN: ${state.salaryAfterTax.municipality}`;
            }
            
            // Mr. Monly's system prompt
            const systemPrompt = `Roll & Identitet
Du √§r Mr. Monly, en extremt kunnig, pedagogisk och personlig ekonomisk r√•dgivare. Ditt m√•l √§r att hj√§lpa anv√§ndaren att spara mer pengar, fatta b√§ttre ekonomiska beslut och bygga l√•ngsiktig ekonomisk trygghet, anpassat efter deras verkliga liv.
Du pratar enkelt, tydligt och m√§nskligt ‚Äì aldrig som en bankrobot. Du √§r √§rlig, ibland rak, men alltid hj√§lpsam och st√∂ttande.

Din expertis
Du √§r expert p√•:
‚Ä¢ Privatekonomi
‚Ä¢ Budgetering & kassafl√∂de
‚Ä¢ Sparande (kort & l√•ng sikt)
‚Ä¢ Investeringar (l√•grisk ‚Üí h√∂gre risk)
‚Ä¢ Skulder, r√§ntor, krediter
‚Ä¢ Abonnemang & on√∂diga utgifter
‚Ä¢ Psykologi kring pengar
‚Ä¢ Ekonomiska vanor & beteenden

Du f√∂rst√•r svensk ekonomi, vardagskostnader, l√∂ner, skatter, boende, inflation och levnadskostnader.

Hur du arbetar
1. Analysera anv√§ndarens registrerade utgifter
   ‚Ä¢ Identifiera m√∂nster
   ‚Ä¢ Uppt√§ck on√∂diga kostnader
   ‚Ä¢ J√§mf√∂r fasta vs r√∂rliga utgifter
   ‚Ä¢ Visa vad som kan f√∂rb√§ttras, minskas eller optimeras

2. Ge konkreta r√•d
   ‚Ä¢ Inte generella tips
   ‚Ä¢ Alltid anpassade efter anv√§ndarens faktiska data
   ‚Ä¢ Visa exakt vad som kan √§ndras och vad det ger i pengar per m√•nad/√•r

3. St√§ll smarta f√∂ljdfr√•gor
   ‚Ä¢ Fr√•ga om m√•l (sparande, resor, bostad, trygghet)
   ‚Ä¢ Fr√•ga om riskniv√•
   ‚Ä¢ Fr√•ga om livssituation (ensam, familj, boende, jobb)
   ‚Ä¢ Fr√•ga om stressniv√• kring ekonomi

4. Var proaktiv
   ‚Ä¢ F√∂resl√• f√∂rb√§ttringar innan anv√§ndaren ber om dem
   ‚Ä¢ Uppm√§rksamma varningssignaler (f√∂r lite sparande, h√∂ga fasta kostnader)
   ‚Ä¢ F√∂resl√• sm√• steg som √§r l√§tta att genomf√∂ra

Ditt s√§tt att prata
‚Ä¢ V√§nlig men professionell
‚Ä¢ Aldrig d√∂mande
‚Ä¢ Motiverande
‚Ä¢ Ibland lite humor, men alltid respektfull

Exempel p√• ton:
"H√§r finns faktiskt en enkel vinst ‚Äì om du √§ndrar X sparar du ca 1 200 kr/m√•nad utan att leva sn√•lare."

Regler
‚Ä¢ Du ger inte juridisk r√•dgivning
‚Ä¢ Du lovar aldrig garanterad avkastning
‚Ä¢ Du anpassar alltid r√•d efter anv√§ndarens verklighet
‚Ä¢ Du f√∂rklarar sv√•ra begrepp enkelt
‚Ä¢ Svara p√• svenska
‚Ä¢ H√•ll svaren lagom l√•nga men informativa

${userContext ? 'ANV√ÑNDARDATA ATT ANALYSERA:\n' + userContext : ''}`;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-api-key': ANTHROPIC_API_KEY,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1500,
                        system: systemPrompt,
                        messages: [
                            ...aiChatHistory,
                            { role: 'user', content: message }
                        ]
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || 'API-fel');
                }
                
                const aiResponse = data.content?.[0]?.text || 'Tyv√§rr kunde jag inte svara just nu. F√∂rs√∂k igen!';
                
                // Spara i historik
                aiChatHistory.push({ role: 'user', content: message });
                aiChatHistory.push({ role: 'assistant', content: aiResponse });
                
                // Ta bort laddning och visa svar
                document.getElementById(loadingId).remove();
                messagesDiv.innerHTML += `
                    <div style="background: rgba(102, 126, 234, 0.15); border-radius: 12px 12px 12px 0; padding: 14px; max-width: 90%;">
                        <div style="font-size: 13px; color: #e8eaf6; line-height: 1.6; white-space: pre-wrap;">${aiResponse}</div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Mr. Monly error:', error);
                document.getElementById(loadingId).remove();
                messagesDiv.innerHTML += `
                    <div style="background: rgba(239, 83, 80, 0.15); border-radius: 12px 12px 12px 0; padding: 14px; max-width: 90%;">
                        <div style="font-size: 13px; color: #ef5350; line-height: 1.5;">
                            <strong>Ojd√•!</strong> ${error.message || 'Kunde inte ansluta till Mr. Monly.'}
                            <br><br>
                            <strong>Vanliga orsaker:</strong><br>
                            ‚Ä¢ API-nyckeln √§r felaktig eller saknas<br>
                            ‚Ä¢ Du har inte tillr√§ckligt med credits<br>
                            ‚Ä¢ N√§tverksproblem
                            <br><br>
                            <a href="https://console.anthropic.com/" target="_blank" style="color: #667eea;">Kontrollera din API-nyckel ‚Üí</a>
                        </div>
                    </div>
                `;
            }
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function deleteMonth(monthKey) {
            // Ta bort m√•naden fr√•n months array
            state.months = state.months.filter(m => m.monthKey !== monthKey);
            
            // Om vi raderade currentMonth, v√§lj en annan
            if (state.currentMonth && state.currentMonth.monthKey === monthKey) {
                if (state.months.length > 0) {
                    state.currentMonth = state.months[state.months.length - 1];
                } else {
                    state.currentMonth = null;
                }
            }
            
            // Ta bort streak-data f√∂r denna m√•nad
            if (state.noSpendStreak && state.noSpendStreak.savedDays) {
                state.noSpendStreak.savedDays = state.noSpendStreak.savedDays.filter(
                    d => d.monthKey !== monthKey
                );
            }
            
            saveState();
            closeDeleteModal();
            
            // Om inga m√•nader kvar, g√• till start
            if (state.months.length === 0) {
                goTo('start');
            } else {
                render();
            }
        }

        // FIX: selectMonth beh√•ller m√•nadens egen budgetModel
        function selectMonth(monthKey) {
            const month = state.months.find(m => m.monthKey === monthKey);
            if (month) { 
                state.currentMonth = month;
                // FIX: S√§tt inte state.budgetModel - l√•t m√•naden anv√§nda sin sparade modell
                goTo('budget'); 
            }
        }

        const app = document.getElementById('app');
        
        loadState();
        
        if (!state.months) {
            state.months = [];
        }
        
        // Initiera noSpendStreak om det inte finns
        if (!state.noSpendStreak) {
            state.noSpendStreak = {
                lastExpenseDate: null,
                streakStartDate: null,
                savedDays: [],
                lastCheckedDate: null
            };
        }
        if (!state.noSpendStreak.savedDays) {
            state.noSpendStreak.savedDays = [];
        }
        
        // Initiera salaryAfterTax om det inte finns
        if (!state.salaryAfterTax) {
            state.salaryAfterTax = {
                incomeType: 'monthly',
                grossSalary: 0,
                hourlyRate: 0,
                hoursWorked: 160,
                municipality: '',
                birthYear: 1990,
                churchMember: false
            };
        }
        
        // Initiera notifications om det inte finns
        if (!state.notifications) {
            state.notifications = {
                enabled: false,
                newPeriodReminder: true,
                noSpendCelebration: true,
                reminderTime: 'evening',
                lastShownDate: null
            };
        }
        
        // Initiera breakDay om det inte finns
        if (!state.breakDay) {
            state.breakDay = 25;
        }
        
        // S√§tt budgetModel till simple som standard
        if (!state.budgetModel || state.budgetModel === 'recommended') {
            state.budgetModel = 'simple';
        }
        
        if (state.months.length === 0) {
            state.view = 'start';
        } else {
            // FIX: V√§lj senaste m√•naden (sista i sorterad array)
            state.currentMonth = state.months[state.months.length - 1];
            state.view = 'budget';
        }
        
        render();
    </script>
</body>
</html>
