<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monly - Din personliga budgetapp</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { touch-action: manipulation; -webkit-text-size-adjust: 100%; }
        input, select, button { font-size: 16px !important; } /* F√∂rhindrar iOS auto-zoom p√• inputs */
        input.large-input { font-size: 48px !important; } /* Undantag f√∂r stora inkomst-inputs */
        body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%); color: #e8eaf6; min-height: 100vh; padding: 20px; }
        .app { max-width: 480px; margin: 0 auto; min-height: 100vh; }
        .view-header { display: flex; justify-content: center; align-items: center; margin-bottom: 32px; position: relative; }
        .view-header h2 { font-size: 24px; font-weight: 700; color: #e8eaf6; text-align: center; }
        .view-header-left { position: absolute; left: 0; }
        .view-header-right { position: absolute; right: 0; padding-right: 0; }
        .icon-button { background: none; border: none; color: #667eea; cursor: pointer; padding: 8px; font-size: 18px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .icon-button:hover { background: rgba(102, 126, 234, 0.1); }
        .primary-button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px 32px; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin-bottom: 12px; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4); transition: all 0.3s ease; }
        .primary-button:hover { transform: translateY(-4px); }
        .primary-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .secondary-button { background: rgba(159, 168, 218, 0.1); color: #667eea; border: 2px solid rgba(159, 168, 218, 0.2); padding: 14px 28px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-bottom: 12px; }
        .secondary-button:hover { background: rgba(159, 168, 218, 0.15); }
        .start-view { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 40px); gap: 32px; }
        .logo { font-size: 64px; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
        .tagline { font-size: 16px; color: #9fa8da; }
        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; font-size: 14px; color: #9fa8da; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select { background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 12px; padding: 12px; font-size: 15px; color: #e8eaf6; font-family: inherit; width: 100%; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        /* Hide number input spinners */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        select { background: rgba(10, 14, 39, 0.6) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E") no-repeat right 8px center; padding-right: 28px; }
        .flex-row { display: flex; gap: 12px; }
        .flex-row input, .flex-row select { flex: 1; }
        
        .category-card { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 20px; padding: 24px; margin-bottom: 16px; cursor: pointer; transition: all 0.3s ease; }
        .category-card:hover { transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3); }
        .category-card.utgifter { cursor: default; }
        .category-card.utgifter:hover { transform: none; box-shadow: none; }
        .category-card.fasta { border-color: rgba(244, 67, 54, 0.3); }
        .category-card.nojen { border-color: rgba(255, 152, 0, 0.3); }
        .category-card.sparande { border-color: rgba(76, 175, 80, 0.3); }
        .category-card h3 { font-size: 18px; font-weight: 700; color: #e8eaf6; margin-bottom: 8px; }
        .category-card .percentage { font-size: 14px; color: #9fa8da; font-weight: 600; margin-bottom: 12px; }
        .category-card .budget-amount { font-size: 32px; font-weight: 800; color: #e8eaf6; margin-bottom: 16px; }
        .category-card .remaining { display: flex; justify-content: space-between; font-size: 16px; font-weight: 700; padding-top: 12px; border-top: 1px solid rgba(159, 168, 218, 0.1); }
        .category-card .remaining.negative { color: #e57373; }
        .category-card .remaining:not(.negative) { color: #81c784; }
        
        .income-display { background: rgba(102, 126, 234, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        .income-display-label { font-size: 12px; color: #9fa8da; }
        .income-display-amount { font-size: 24px; font-weight: 700; color: #667eea; }
        
        .summary-bars { display: flex; gap: 12px; margin-bottom: 24px; }
        .summary-bar { flex: 1; border-radius: 12px; padding: 16px; background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); }
        .summary-bar-label { font-size: 12px; color: #9fa8da; margin-bottom: 8px; }
        .summary-bar-amount { font-size: 18px; font-weight: 700; }
        
        .menu-button { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 20px; display: flex; align-items: center; gap: 16px; cursor: pointer; font-size: 16px; font-weight: 600; color: #e8eaf6; margin-bottom: 12px; transition: all 0.2s ease; width: 100%; }
        .menu-button:hover { background: rgba(159, 168, 218, 0.1); transform: translateX(4px); }
        
        .total-card { background: rgba(159, 168, 218, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .total-card h3 { font-size: 12px; color: #9fa8da; text-transform: uppercase; margin-bottom: 8px; font-weight: 600; }
        .total-card-amount { font-size: 18px; font-weight: 700; }
        .total-card.fasta { border-left: 4px solid rgba(244, 67, 54, 0.5); }
        .total-card.nojen { border-left: 4px solid rgba(255, 193, 7, 0.5); }
        .total-card.sparande { border-left: 4px solid rgba(76, 175, 80, 0.5); }
        
        .special-box { background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.1) 100%); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 16px; padding: 20px; margin-bottom: 24px; }
        .special-box-amount { font-size: 28px; font-weight: 700; color: #667eea; margin: 12px 0; }
        
        .expense-item { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 14px; padding: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .expense-item[style*="flex-direction"] { align-items: flex-start; }
        .expense-name { flex: 1; font-size: 15px; font-weight: 600; }
        .expense-amount { font-size: 14px; font-weight: 700; color: #667eea; margin: 0 12px; }
        .delete-button { background: none; border: none; color: #ef5350; cursor: pointer; font-size: 20px; padding: 8px; opacity: 1; transition: all 0.2s ease; font-weight: bold; }
        .delete-button:hover { opacity: 1; transform: scale(1.25); color: #ff1744; }
        
        .history-month { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 24px; margin-bottom: 16px; transition: all 0.3s ease; }
        .history-month h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #e8eaf6; }
        .history-month-stats { font-size: 14px; color: #9fa8da; }
        
        .budget-option { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 12px; padding: 16px; color: #e8eaf6; cursor: pointer; transition: all 0.2s ease; }
        .budget-option:hover { background: rgba(159, 168, 218, 0.1); }
        .budget-option.active { background: rgba(102, 126, 234, 0.3); border-color: rgba(102, 126, 234, 0.6); }
        .budget-option-title { font-weight: 600; margin-bottom: 4px; font-size: 15px; }
        .budget-option-desc { font-size: 13px; color: #9fa8da; }
    </style>
</head>
<body>
    <div class="app" id="app"></div>

    <script>
        const languages = {
            sv: {
                appName: 'Monly', tagline: 'Enkel privatekonomi f√∂r alla', createFirst: 'üìÖ Starta budgetering',
                income: 'M√•nadsinkomst', next: 'B√∂rja budgetera', back: 'Tillbaka', myProfile: 'Min profil',
                account: 'Konto', history: 'Historik', totalResult: 'Totalt resultat', editExpenses: 'Redigera utgifter',
                language: 'Spr√•k', currency: 'Valuta', name: 'Namn', fixedCosts: 'Fasta kostnader',
                fun: 'N√∂jen', savings: 'Sparande', remaining: 'Kvar', used: 'Anv√§nt', leftToUse: 'Kvar att anv√§nda',
                forFunAndEntertainment: 'f√∂r n√∂je och underh√•llning', addExpense: 'L√§gg till utgift', 
                noExpenses: 'Inga poster √§nnu', totalIncome: 'Total inkomst', totalExpenses: 'Totala utgifter',
                totalSavings: 'Totalt sparande', totalUsed: 'Totalt anv√§nt', totalRemaining: 'Totalt kvar',
                extraIncome: 'Extra inkomst'
            },
            en: {
                appName: 'Monly', tagline: 'Easy personal finance for everyone', createFirst: 'üìÖ Start budgeting',
                income: 'Monthly income', next: 'Start budgeting', back: 'Back', myProfile: 'My profile',
                account: 'Account', history: 'History', totalResult: 'Total result', editExpenses: 'Edit expenses',
                language: 'Language', currency: 'Currency', name: 'Name', fixedCosts: 'Fixed costs',
                fun: 'Fun', savings: 'Savings', remaining: 'Remaining', used: 'Used', leftToUse: 'Left to use',
                forFunAndEntertainment: 'for fun and entertainment', addExpense: 'Add expense', 
                noExpenses: 'No items yet', totalIncome: 'Total income', totalExpenses: 'Total expenses',
                totalSavings: 'Total savings', totalUsed: 'Total used', totalRemaining: 'Total remaining',
                extraIncome: 'Extra income'
            }
        };

        const state = {
            view: 'start', language: 'sv', currency: 'SEK', userName: '',
            currentMonth: null, // { monthKey, displayDate, income, extraIncome, budgetModel, categories }
            months: [], // Array of all saved months
            selectedCategory: null, accounts: [], currentAccountId: null,
            showExtraIncomeForm: false, budgetModel: 'recommended',
            customPercentages: { fasta: 50, nojen: 30, sparande: 20 },
            priceToTime: { incomeType: 'monthly', incomeAmount: 0, price: 0 },
            pendingIncome: 0, pendingMonth: new Date().getMonth() + 1, pendingYear: new Date().getFullYear(),
            savedExpenseTemplate: null,
            editingItem: null, // { key, id, name, amount }
            totalResultView: 'month', // 'month' or 'year'
            noSpendStreak: {
                lastExpenseDate: null, // Senaste datum en utgift lades till
                streakStartDate: null, // N√§r nuvarande streak b√∂rjade
                savedDays: [], // Array av {date, amount} f√∂r varje sparad dag
                lastCheckedDate: null // Senaste datum vi uppdaterade streaken
            },
            salaryAfterTax: {
                incomeType: 'monthly', // 'monthly' eller 'hourly'
                grossSalary: 0,
                hourlyRate: 0,
                hoursWorked: 160,
                municipality: '',
                birthYear: 1990,
                churchMember: false
            }
        };

        const currencies = {
            'SEK': 'Svenska kronor', 'EUR': 'Euro', 'USD': 'US Dollar', 'GBP': 'British Pound',
            'NOK': 'Norska kronor', 'DKK': 'Danska kronor'
        };

        function t(key) { return languages[state.language][key] || key; }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('sv-SE', { style: 'currency', currency: state.currency, minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        }

        function loadState() {
            const saved = localStorage.getItem('monly_data');
            if (saved) Object.assign(state, JSON.parse(saved));
        }

        function saveState() { localStorage.setItem('monly_data', JSON.stringify(state)); }

        // FIX: Hj√§lpfunktion f√∂r att f√• antalet dagar i en m√•nad baserat p√• monthKey
        function getDaysInMonth(monthKey) {
            if (!monthKey) return 30;
            const parts = monthKey.split('-');
            if (parts.length !== 2) return 30;
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            return new Date(year, month, 0).getDate();
        }

        // FIX: Hj√§lpfunktion f√∂r att kolla om en m√•nad anv√§nder simple mode
        function isMonthSimpleMode(month) {
            if (!month) return false;
            // Kolla om m√•naden har en sparad budgetModel
            if (month.budgetModel) {
                return month.budgetModel === 'simple';
            }
            // Fallback: kolla om utgifter-kategorin finns (indikerar simple mode)
            return month.categories && month.categories.utgifter !== undefined;
        }

        // FIX: Hj√§lpfunktion f√∂r att f√• extra inkomst fr√•n m√•naden
        function getExtraIncome(month) {
            return (month && month.extraIncome) ? month.extraIncome : 0;
        }

        function render() {
            switch(state.view) {
                case 'start': renderStart(); break;
                case 'createIncome': renderCreateIncome(); break;
                case 'budget': renderBudget(); break;
                case 'profile': renderProfile(); break;
                case 'accountSettings': renderAccountSettings(); break;
                case 'priceToTime': renderPriceToTime(); break;
                case 'noSpendStreak': renderNoSpendStreak(); break;
                case 'salaryAfterTax': renderSalaryAfterTax(); break;
                case 'totalResult': renderTotalResult(); break;
                case 'history': renderHistory(); break;
                case 'editExpenses': renderEditExpenses(); break;
                case 'category': renderCategory(); break;
            }
        }

        function renderStart() {
            app.innerHTML = `
                <div class="start-view">
                    <div style="text-align: center;">
                        <div class="logo">${t('appName')}</div>
                        <div class="tagline">${t('tagline')}</div>
                    </div>
                    <button class="primary-button" onclick="goTo('createIncome')">${t('createFirst')}</button>
                </div>
            `;
        }

        function renderCreateIncome() {
            const monthNames = ['', 'Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni', 'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'];
            const currentYear = new Date().getFullYear();
            const years = [currentYear - 1, currentYear, currentYear + 1];

            // FIX: Tillbaka-knappen g√•r till budget om det finns m√•nader, annars start
            const backView = state.months && state.months.length > 0 ? 'budget' : 'start';

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('${backView}')">‚Üê</button>
                        </div>
                        <h2>Ny m√•nad</h2>
                        <div class="view-header-right"></div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 20px; padding: 28px; margin-bottom: 32px;">
                        <div style="font-size: 12px; color: #9fa8da; text-transform: uppercase; font-weight: 600; margin-bottom: 12px;">M√•nadsinkomst</div>
                        <input type="number" id="incomeInput" class="large-input" placeholder="0" value="${state.pendingIncome}" oninput="state.pendingIncome = parseFloat(this.value) || 0;" onfocus="if(this.value === '0') this.value = ''" required min="1" style="background: none; border: none; outline: none; font-size: 48px; font-weight: 800; color: #667eea; width: 100%; padding: 0; font-family: inherit; margin-bottom: 12px;">
                        <div style="font-size: 14px; color: #9fa8da;">${state.currency}</div>
                    </div>

                    <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 20px; margin-bottom: 32px;">
                        <h3 style="font-size: 12px; color: #9fa8da; margin-bottom: 16px; font-weight: 600; text-transform: uppercase;">V√§lj m√•nad & √•r</h3>
                        <div style="display: flex; gap: 12px;">
                            <select id="monthSelect" onchange="state.pendingMonth = parseInt(this.value);" style="flex: 1; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 14px;">
                                ${monthNames.map((m, i) => `<option value="${i}" ${i === state.pendingMonth ? 'selected' : ''}>${m}</option>`).join('')}
                            </select>
                            <select id="yearSelect" onchange="state.pendingYear = parseInt(this.value);" style="width: 100px; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 14px;">
                                ${years.map(y => `<option value="${y}" ${y === state.pendingYear ? 'selected' : ''}>${y}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <h3 style="font-size: 14px; color: #9fa8da; margin-bottom: 16px; font-weight: 600;">Budgetf√∂rdelning</h3>

                    <div class="budget-option ${state.budgetModel === 'simple' ? 'active' : ''}" onclick="selectBudgetModel('simple'); render()">
                        <div class="budget-option-title">Enkel √∂versikt</div>
                        <div class="budget-option-desc">Utgifter & Kvar i pl√•nboken - utan %-basering</div>
                    </div>

                    <div class="budget-option ${state.budgetModel === 'recommended' ? 'active' : ''}" onclick="selectBudgetModel('recommended'); render()" style="margin-top: 12px;">
                        <div class="budget-option-title">Rekommenderad (50/30/20)</div>
                        <div class="budget-option-desc">Fasta: 50% | N√∂jen: 30% | Sparande: 20%</div>
                    </div>

                    <div class="budget-option ${state.budgetModel === 'custom' ? 'active' : ''}" onclick="selectBudgetModel('custom'); render()" style="margin-top: 12px;">
                        <div class="budget-option-title">Egen % f√∂rdelning</div>
                        <div class="budget-option-desc">Du v√§ljer sj√§lv hur du vill f√∂rdela</div>
                    </div>

                    ${state.budgetModel === 'custom' ? `
                        <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 20px; margin-top: 16px; margin-bottom: 24px;">
                            <h3 style="font-size: 14px; color: #9fa8da; margin-bottom: 16px; font-weight: 600;">Ange dina egna procentsatser</h3>
                            
                            <div class="form-group">
                                <label>Fasta kostnader (%)</label>
                                <input type="number" id="customFasta" value="${state.customPercentages.fasta}" min="0" max="100" oninput="updateCustomPercentage('fasta', this.value)">
                            </div>

                            <div class="form-group">
                                <label>N√∂jen (%)</label>
                                <input type="number" id="customNojen" value="${state.customPercentages.nojen}" min="0" max="100" oninput="updateCustomPercentage('nojen', this.value)">
                            </div>

                            <div class="form-group">
                                <label>Sparande (%)</label>
                                <input type="number" id="customSparande" value="${state.customPercentages.sparande}" min="0" max="100" oninput="updateCustomPercentage('sparande', this.value)">
                            </div>

                            <div style="background: rgba(102, 126, 234, 0.2); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 12px; text-align: center;">
                                <div style="font-size: 12px; color: #9fa8da; margin-bottom: 4px;">Totalt</div>
                                <div style="font-size: 18px; font-weight: 700; color: ${(state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande) === 100 ? '#81c784' : '#e57373'};">${state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande}%</div>
                            </div>
                        </div>
                    ` : ''}

                    <button type="button" class="primary-button" onclick="createBudgetWithDate()" style="margin-top: 48px;" ${state.budgetModel === 'custom' && (state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande) !== 100 ? 'disabled' : ''}>B√∂rja budgetera</button>
                </div>
            `;
            document.getElementById('incomeInput').focus();
        }

        function renderBudget() {
            if (!state.currentMonth) return;
            const month = state.currentMonth;
            
            // FIX: Anv√§nd m√•nadens sparade budgetModel ist√§llet f√∂r global state
            const isSimpleMode = isMonthSimpleMode(month);
            
            // FIX: H√§mta extra inkomst fr√•n m√•naden direkt
            const extraIncome = getExtraIncome(month);

            let categoryHtml = '';
            let totalSpent = 0;

            if (isSimpleMode) {
                // Simple mode: Utgifter and Kvar i pl√•nboken
                const utgifter = month.categories.utgifter || { name: 'Utgifter', items: [] };
                const spent = utgifter.items.reduce((sum, item) => sum + item.amount, 0);
                totalSpent = spent;
                const totalIncome = month.income + extraIncome;
                const remaining = totalIncome - spent;
                const warningThreshold = totalIncome * 0.1; // 10% warning
                const isWarning = remaining >= 0 && remaining <= warningThreshold;
                
                // FIX: Anv√§nd m√•nadens dagar ist√§llet f√∂r nuvarande datum
                const daysInMonth = getDaysInMonth(month.monthKey);
                const dailyBudget = Math.round(remaining / daysInMonth);
                
                let dailyColor = '#81c784';
                let psychoText = 'Okej, jag kan ta en lunch idag';
                
                if (remaining < 0) {
                    dailyColor = '#e57373';
                    psychoText = 'Fyfan, nu √§r jag fattig...';
                } else if (isWarning) {
                    dailyColor = '#ffa726';
                    psychoText = 'Aj aj nu blir det matl√•dor';
                }

                categoryHtml = `
                    <div class="category-card utgifter">
                        <h3>${utgifter.name}</h3>
                        <div class="budget-amount">${formatCurrency(spent)}</div>
                        <div class="remaining ${remaining < 0 ? 'negative' : ''}" style="color: ${dailyColor};">
                            <span style="color: ${dailyColor};">Kvar i pl√•nboken:</span>
                            <span style="color: ${dailyColor}; font-weight: 700;">${formatCurrency(remaining)}</span>
                        </div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(159, 168, 218, 0.1); text-align: center;">
                            <div style="font-size: 14px; color: #9fa8da; margin-bottom: 6px;">üí∞ Daglig budget</div>
                            <div style="font-size: 32px; font-weight: 800; color: ${dailyColor};">${formatCurrency(Math.max(0, dailyBudget))}</div>
                            <div style="font-size: 13px; color: ${dailyColor}; margin-top: 6px;">${psychoText}</div>
                        </div>
                        <button type="button" style="background: rgba(102, 126, 234, 0.15); border: none; border-radius: 12px; padding: 12px; color: #c5caf5; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; margin-top: 16px; transition: all 0.2s ease;" onmouseover="this.style.background = 'rgba(102, 126, 234, 0.25)'" onmouseout="this.style.background = 'rgba(102, 126, 234, 0.15)'" onclick="goToCategory('utgifter')">
                            ‚ûï L√§gg till utgift
                        </button>
                    </div>
                `;
            } else {
                // Percentage-based mode: Fasta, N√∂jen, Sparande
                // FIX: Inkludera extraIncome i totalBudget f√∂r procentbaserade l√§gen
                const totalIncome = month.income + extraIncome;
                totalSpent = Object.values(month.categories).reduce((sum, cat) => sum + cat.items.reduce((s, item) => s + item.amount, 0), 0);

                for (const [key, cat] of Object.entries(month.categories)) {
                    const spent = cat.items.reduce((sum, item) => sum + item.amount, 0);
                    // FIX: Ber√§kna budget baserat p√• totalIncome (inkl extra) och sparad procent
                    const budget = totalIncome * (cat.percentage / 100);
                    const remaining = budget - spent;
                    
                    categoryHtml += `
                        <div class="category-card ${key}">
                            <h3>${cat.name}</h3>
                            <div class="percentage">${cat.percentage}%</div>
                            <div class="budget-amount">${formatCurrency(budget)}</div>
                            <div class="remaining ${remaining < 0 ? 'negative' : ''}">
                                <span>${t('remaining')}:</span>
                                <span>${formatCurrency(remaining)}</span>
                            </div>
                            <button type="button" style="background: rgba(102, 126, 234, 0.4); border: 2px solid rgba(102, 126, 234, 0.5); border-radius: 12px; padding: 10px; color: #667eea; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; margin-top: 16px;" onclick="goToCategory('${key}')">
                                ‚ûï ${t('addExpense')}
                            </button>
                        </div>
                    `;
                }
            }

            const totalIncome = month.income + extraIncome;

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left"></div>
                        <h2>${month.displayDate} √ñversikt</h2>
                        <div class="view-header-right">
                            <button class="icon-button" onclick="goTo('profile')">üë§</button>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 20px; padding: 28px; margin-bottom: 32px;">
                        <div style="font-size: 12px; color: #9fa8da; text-transform: uppercase; font-weight: 600; margin-bottom: 12px;">${t('totalIncome')}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <input type="number" id="editableIncome" class="large-input" value="${month.income}" style="background: none; border: none; outline: none; font-size: 48px; font-weight: 800; color: #667eea; width: 100%; padding: 0; font-family: inherit;" onchange="updateMainIncome(this.value)">
                                <div style="font-size: 14px; color: #9fa8da; margin-top: 8px;">${state.currency}</div>
                            </div>
                            <button class="secondary-button" style="width: auto; margin: 0; padding: 12px 20px; font-size: 14px; height: fit-content;" onclick="document.getElementById('editableIncome').focus()">‚úèÔ∏è √Ñndra</button>
                        </div>
                        ${!state.showExtraIncomeForm && extraIncome === 0 ? `
                            <button class="primary-button" onclick="toggleExtraIncome()" style="margin-bottom: 0; background: rgba(102, 126, 234, 0.12); color: #a8b8f0; margin-top: 8px; box-shadow: none; border: none;">+ L√§gg till extra inkomst</button>
                        ` : ''}
                    </div>

                    ${state.showExtraIncomeForm ? `
                        <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 20px; padding: 16px; margin-bottom: 24px; display: flex; gap: 8px;">
                            <input type="number" id="extraIncomeInput" placeholder="Belopp" style="flex: 1; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit;">
                            <button type="button" class="secondary-button" style="width: auto; margin: 0; padding: 10px 16px;" onclick="saveExtraIncome()">L√§gg till</button>
                            <button type="button" class="secondary-button" style="width: auto; margin: 0; padding: 10px 16px;" onclick="cancelExtraIncome()">Avbryt</button>
                        </div>
                    ` : ''}

                    ${extraIncome > 0 ? `
                        <div style="background: rgba(76, 175, 80, 0.1); border: 2px solid rgba(76, 175, 80, 0.2); border-radius: 16px; padding: 16px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 12px; color: #81c784; margin-bottom: 4px; text-transform: uppercase; font-weight: 600;">Extra inkomst tillagd</div>
                                <div style="font-size: 18px; font-weight: 700; color: #81c784;">${formatCurrency(extraIncome)}</div>
                            </div>
                            <button type="button" class="delete-button" onclick="removeExtraIncome()">üóëÔ∏è</button>
                        </div>
                    ` : ''}

                    ${!isSimpleMode ? `
                        <div class="summary-bars">
                            <div class="summary-bar">
                                <div class="summary-bar-label">${t('totalUsed')}</div>
                                <div class="summary-bar-amount">${formatCurrency(totalSpent)}</div>
                            </div>
                            <div class="summary-bar">
                                <div class="summary-bar-label">${t('totalRemaining')}</div>
                                <div class="summary-bar-amount">${formatCurrency(Math.max(0, totalIncome - totalSpent))}</div>
                            </div>
                        </div>
                    ` : ''}

                    ${categoryHtml}

                    <button class="primary-button" onclick="saveMonthAndGo()" style="margin-top: 32px;">Spara m√•nad</button>
                </div>
            `;
        }

        function renderProfile() {
            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('budget')">‚Üê</button>
                        </div>
                        <h2>${t('myProfile')}</h2>
                        <div class="view-header-right"></div>
                    </div>
                    <button class="menu-button" onclick="goTo('accountSettings')">‚öôÔ∏è ${t('account')}</button>
                    <button class="menu-button" onclick="goTo('priceToTime')">üí∞ Pris i tid</button>
                    <button class="menu-button" onclick="goTo('noSpendStreak')">üî• No-spend streak</button>
                    <button class="menu-button" onclick="goTo('salaryAfterTax')">üíµ L√∂n efter skatt</button>
                    <button class="menu-button" onclick="goTo('totalResult')">üìä ${t('totalResult')}</button>
                    <button class="menu-button" onclick="goTo('history')">üìÖ ${t('history')}</button>
                    <button class="menu-button" onclick="goTo('editExpenses')">‚úèÔ∏è ${t('editExpenses')}</button>
                </div>
            `;
        }

        function renderAccountSettings() {
            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('profile')">‚Üê</button>
                        </div>
                        <h2>${t('account')}</h2>
                        <div class="view-header-right"></div>
                    </div>
                    <div class="form-group">
                        <label>${t('name')}</label>
                        <input type="text" id="userName" value="${state.userName}" oninput="state.userName = this.value" placeholder="${t('name')}">
                    </div>
                    <div class="form-group">
                        <label>${t('language')}</label>
                        <select onchange="state.language = this.value; render()">
                            <option value="sv" ${state.language === 'sv' ? 'selected' : ''}>Svenska</option>
                            <option value="en" ${state.language === 'en' ? 'selected' : ''}>English</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>${t('currency')}</label>
                        <select onchange="state.currency = this.value; render()">
                            ${Object.entries(currencies).map(([code, name]) => `<option value="${code}" ${state.currency === code ? 'selected' : ''}>${code} (${name})</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(159, 168, 218, 0.1);">
                        <h3 style="font-size: 14px; color: #9fa8da; margin-bottom: 16px; font-weight: 600; text-transform: uppercase;">Budgetf√∂rdelning f√∂r nya m√•nader</h3>

                        <div class="budget-option ${state.budgetModel === 'simple' ? 'active' : ''}" onclick="selectBudgetModel('simple'); saveSettings();">
                            <div class="budget-option-title">Enkel √∂versikt</div>
                            <div class="budget-option-desc">Utgifter & Kvar i pl√•nboken - utan %-basering</div>
                        </div>

                        <div class="budget-option ${state.budgetModel === 'recommended' ? 'active' : ''}" onclick="selectBudgetModel('recommended'); saveSettings();" style="margin-top: 12px;">
                            <div class="budget-option-title">Rekommenderad (50/30/20)</div>
                            <div class="budget-option-desc">Fasta: 50% | N√∂jen: 30% | Sparande: 20%</div>
                        </div>

                        <div class="budget-option ${state.budgetModel === 'custom' ? 'active' : ''}" onclick="selectBudgetModel('custom');" style="margin-top: 12px;">
                            <div class="budget-option-title">Egen % f√∂rdelning</div>
                            <div class="budget-option-desc">Du v√§ljer sj√§lv hur du vill f√∂rdela</div>
                        </div>

                        ${state.budgetModel === 'custom' ? `
                            <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 20px; margin-top: 16px;">
                                <div class="form-group">
                                    <label>Fasta kostnader (%)</label>
                                    <input type="number" id="customFasta2" value="${state.customPercentages.fasta}" min="0" max="100" oninput="updateCustomPercentage('fasta', this.value)">
                                </div>

                                <div class="form-group">
                                    <label>N√∂jen (%)</label>
                                    <input type="number" id="customNojen2" value="${state.customPercentages.nojen}" min="0" max="100" oninput="updateCustomPercentage('nojen', this.value)">
                                </div>

                                <div class="form-group">
                                    <label>Sparande (%)</label>
                                    <input type="number" id="customSparande2" value="${state.customPercentages.sparande}" min="0" max="100" oninput="updateCustomPercentage('sparande', this.value)">
                                </div>

                                <div style="background: rgba(102, 126, 234, 0.2); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 12px; text-align: center;">
                                    <div style="font-size: 12px; color: #9fa8da; margin-bottom: 4px;">Totalt</div>
                                    <div style="font-size: 18px; font-weight: 700; color: ${(state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande) === 100 ? '#81c784' : '#e57373'};">${state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande}%</div>
                                </div>

                                <button type="button" class="primary-button" onclick="saveSettings()" style="margin-top: 16px;" ${(state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande) !== 100 ? 'disabled' : ''}>Spara √§ndringar</button>
                            </div>
                        ` : ''}
                    </div>

                    <button class="primary-button" onclick="saveSettings()" style="margin-top: 32px;">${t('next')}</button>
                </div>
            `;
        }

        function renderTotalResult() {
            if (!state.currentMonth) return;
            
            // FIX: Anv√§nd m√•nadens sparade budgetModel
            const isSimpleMode = isMonthSimpleMode(state.currentMonth);
            const extraIncome = getExtraIncome(state.currentMonth);

            // Calculate month data
            let monthCardHtml = '';
            if (isSimpleMode) {
                const utgifterSpent = state.currentMonth.categories.utgifter?.items.reduce((sum, item) => sum + item.amount, 0) || 0;
                const totalIncome = state.currentMonth.income + extraIncome;
                const remaining = totalIncome - utgifterSpent;
                
                monthCardHtml = `
                    <div class="total-card utgifter">
                        <h3>Utgifter</h3>
                        <div class="total-card-amount">${formatCurrency(utgifterSpent)}</div>
                    </div>

                    <div class="special-box">
                        <h3 style="font-size: 14px; font-weight: 700; color: #e8eaf6;">üí∞ Kvar i pl√•nboken</h3>
                        <div class="special-box-amount">${formatCurrency(Math.max(0, remaining))}</div>
                        <p style="font-size: 12px; color: #9fa8da;">Du kan spendera detta fritt denna m√•nad</p>
                    </div>
                `;
            } else {
                const totalIncome = state.currentMonth.income + extraIncome;
                const fataSpent = state.currentMonth.categories.fasta?.items.reduce((sum, item) => sum + item.amount, 0) || 0;
                const nojenSpent = state.currentMonth.categories.nojen?.items.reduce((sum, item) => sum + item.amount, 0) || 0;
                const sparandeSpent = state.currentMonth.categories.sparande?.items.reduce((sum, item) => sum + item.amount, 0) || 0;
                const leftToUse = totalIncome - (fataSpent + sparandeSpent);

                monthCardHtml = `
                    <div class="total-card fasta">
                        <h3>Fasta kostnader</h3>
                        <div class="total-card-amount">${formatCurrency(fataSpent)}</div>
                    </div>

                    <div class="total-card nojen">
                        <h3>N√∂jen</h3>
                        <div class="total-card-amount">${formatCurrency(nojenSpent)}</div>
                    </div>

                    <div class="total-card sparande">
                        <h3>Sparande</h3>
                        <div class="total-card-amount">${formatCurrency(sparandeSpent)}</div>
                    </div>

                    <div class="special-box">
                        <h3 style="font-size: 14px; font-weight: 700; color: #e8eaf6;">üí∞ ${t('leftToUse')}</h3>
                        <div class="special-box-amount">${formatCurrency(Math.max(0, leftToUse))}</div>
                        <p style="font-size: 12px; color: #9fa8da;">${t('forFunAndEntertainment')}</p>
                    </div>
                `;
            }

            // FIX: Calculate year data - hantera blandade budgetmodeller
            let yearCardHtml = '';
            if (state.months && state.months.length > 0) {
                // Ber√§kna totaler oavsett budgetmodell
                let yearTotalIncome = 0;
                let yearTotalSpent = 0;
                let yearFasta = 0;
                let yearNojen = 0;
                let yearSparande = 0;
                let yearUtgifter = 0;

                state.months.forEach(month => {
                    const monthExtra = getExtraIncome(month);
                    yearTotalIncome += (month.income || 0) + monthExtra;
                    
                    if (isMonthSimpleMode(month)) {
                        const spent = month.categories.utgifter?.items.reduce((s, item) => s + item.amount, 0) || 0;
                        yearUtgifter += spent;
                        yearTotalSpent += spent;
                    } else {
                        const fSpent = month.categories.fasta?.items.reduce((s, item) => s + item.amount, 0) || 0;
                        const nSpent = month.categories.nojen?.items.reduce((s, item) => s + item.amount, 0) || 0;
                        const sSpent = month.categories.sparande?.items.reduce((s, item) => s + item.amount, 0) || 0;
                        yearFasta += fSpent;
                        yearNojen += nSpent;
                        yearSparande += sSpent;
                        yearTotalSpent += fSpent + nSpent + sSpent;
                    }
                });

                const yearRemaining = yearTotalIncome - yearTotalSpent;

                // Visa alltid en kombinerad vy f√∂r √•ret
                yearCardHtml = `
                    ${yearFasta > 0 || yearNojen > 0 || yearSparande > 0 ? `
                        <div class="total-card fasta">
                            <h3>Fasta kostnader (Helt √•r)</h3>
                            <div class="total-card-amount">${formatCurrency(yearFasta)}</div>
                        </div>

                        <div class="total-card nojen">
                            <h3>N√∂jen (Helt √•r)</h3>
                            <div class="total-card-amount">${formatCurrency(yearNojen)}</div>
                        </div>

                        <div class="total-card sparande">
                            <h3>Sparande (Helt √•r)</h3>
                            <div class="total-card-amount">${formatCurrency(yearSparande)}</div>
                        </div>
                    ` : ''}

                    ${yearUtgifter > 0 ? `
                        <div class="total-card" style="border-left: 4px solid rgba(159, 168, 218, 0.5);">
                            <h3>Utgifter - enkel modell (Helt √•r)</h3>
                            <div class="total-card-amount">${formatCurrency(yearUtgifter)}</div>
                        </div>
                    ` : ''}

                    <div class="special-box">
                        <h3 style="font-size: 14px; font-weight: 700; color: #e8eaf6;">üí∞ Kvar (Helt √•r)</h3>
                        <div class="special-box-amount">${formatCurrency(Math.max(0, yearRemaining))}</div>
                        <p style="font-size: 12px; color: #9fa8da;">Total inkomst: ${formatCurrency(yearTotalIncome)}</p>
                    </div>
                `;
            }

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('profile')">‚Üê</button>
                        </div>
                        <h2>${t('totalResult')}</h2>
                        <div class="view-header-right"></div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-bottom: 24px;">
                        <button class="primary-button" style="flex: 1; padding: 10px; font-size: 13px; ${state.totalResultView === 'month' ? '' : 'background: rgba(102, 126, 234, 0.2); color: #a8b8f0;'}" onclick="state.totalResultView = 'month'; render();">üìä ${state.currentMonth.displayDate}</button>
                        <button class="primary-button" style="flex: 1; padding: 10px; font-size: 13px; ${state.totalResultView === 'year' ? '' : 'background: rgba(102, 126, 234, 0.2); color: #a8b8f0;'}" onclick="state.totalResultView = 'year'; render();">üìà Helt √•r</button>
                    </div>

                    ${state.totalResultView === 'month' ? monthCardHtml : yearCardHtml}

                    <button class="primary-button" onclick="resetForNewMonth()" style="margin-top: 32px; width: 100%;">Starta ny m√•nad</button>
                </div>
            `;
        }

        function renderPriceToTime() {
            const hourlyIncome = calculateHourlyIncome();
            const hours = hourlyIncome > 0 && state.priceToTime.price > 0 ? state.priceToTime.price / hourlyIncome : 0;
            const totalMinutes = Math.round(hours * 60);
            const displayHours = Math.floor(hours);
            const displayMinutes = Math.round((hours - displayHours) * 60);

            let timeDisplay = '';
            if (totalMinutes < 1) {
                timeDisplay = '< 1 min';
            } else if (displayHours === 0) {
                timeDisplay = `${displayMinutes}m`;
            } else if (displayMinutes === 0) {
                timeDisplay = `${displayHours}h`;
            } else {
                timeDisplay = `${displayHours}h ${displayMinutes}m`;
            }
            
            // H√§mta senaste m√•nadens inkomst f√∂r info
            const latestMonth = getLatestMonth();
            const latestIncome = latestMonth ? latestMonth.income : 0;

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('profile')">‚Üê</button>
                        </div>
                        <h2>Pris i tid</h2>
                        <div class="view-header-right">
                            <button class="icon-button" onclick="showInfoModal('priceToTime')">?</button>
                        </div>
                    </div>

                    <p style="font-size: 15px; color: #9fa8da; margin-bottom: 28px; text-align: center; font-weight: 500;">Se den riktiga kostnaden i ditt k√∂p</p>

                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.08) 100%); border: 2px solid rgba(102, 126, 234, 0.25); border-radius: 20px; padding: 24px; margin-bottom: 28px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 18px;">
                            <div style="font-size: 24px;">üí∞</div>
                            <h3 style="font-size: 18px; font-weight: 700; color: #e8eaf6; margin: 0;">Din inkomst</h3>
                        </div>

                        <div style="display: flex; gap: 8px; margin-bottom: 18px;">
                            <button class="budget-option" style="flex: 1; padding: 10px; text-align: center; cursor: pointer; font-size: 14px; font-weight: 600; ${state.priceToTime.incomeType === 'hourly' ? 'border-color: #667eea; background: rgba(102, 126, 234, 0.2);' : ''}" onclick="state.priceToTime.incomeType = 'hourly'; render()">Timl√∏n</button>
                            <button class="budget-option" style="flex: 1; padding: 10px; text-align: center; cursor: pointer; font-size: 14px; font-weight: 600; ${state.priceToTime.incomeType === 'monthly' ? 'border-color: #667eea; background: rgba(102, 126, 234, 0.2);' : ''}" onclick="state.priceToTime.incomeType = 'monthly'; render()">M√•nadsinkomst</button>
                            <button class="budget-option" style="flex: 1; padding: 10px; text-align: center; cursor: pointer; font-size: 14px; font-weight: 600; ${state.priceToTime.incomeType === 'yearly' ? 'border-color: #667eea; background: rgba(102, 126, 234, 0.2);' : ''}" onclick="state.priceToTime.incomeType = 'yearly'; render()">√Örsinkomst</button>
                        </div>

                        <div style="margin-bottom: 12px;">
                            <label style="font-size: 14px; color: #9fa8da; display: block; margin-bottom: 10px; font-weight: 600;">Din inkomst</label>
                            <input type="number" id="incomeInput" value="${state.priceToTime.incomeAmount}" placeholder="0" onfocus="if(this.value === '0') this.value = ''" onchange="state.priceToTime.incomeAmount = parseFloat(this.value) || 0; render();" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 12px; padding: 16px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 18px; font-weight: 600;">
                        </div>
                        <div style="font-size: 14px; color: #81c784; font-weight: 600;">
                            ‚âà ${formatCurrency(hourlyIncome)} per timme
                        </div>
                    </div>

                    <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 24px; margin-bottom: 28px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 18px;">
                            <div style="font-size: 24px;">üõí</div>
                            <h3 style="font-size: 18px; font-weight: 700; color: #e8eaf6; margin: 0;">Pris att utv√§rdera</h3>
                        </div>
                        <input type="number" id="priceInput" value="${state.priceToTime.price}" placeholder="0" onfocus="if(this.value === '0') this.value = ''" onchange="state.priceToTime.price = parseFloat(this.value) || 0; render();" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(219, 112, 147, 0.3); border-radius: 12px; padding: 16px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 18px; font-weight: 600;">
                        <div style="font-size: 14px; color: #9fa8da; margin-top: 10px; font-weight: 600;">
                            ${state.currency} ${state.priceToTime.price.toFixed(0)}
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(255, 152, 0, 0.1) 0%, rgba(233, 30, 99, 0.05) 100%); border: 2px solid rgba(255, 152, 0, 0.2); border-radius: 16px; padding: 28px; text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 18px;">
                            <div style="font-size: 24px;">‚è±Ô∏è</div>
                            <h3 style="font-size: 18px; font-weight: 700; color: #e8eaf6; margin: 0;">Tidskostad</h3>
                        </div>
                        <div style="font-size: 56px; font-weight: 800; color: #ff9800; margin-bottom: 12px;">${timeDisplay}</div>
                        <div style="font-size: 16px; color: #9fa8da; margin-bottom: 10px; font-weight: 600;">${totalMinutes < 60 ? `${displayMinutes} minuter` : displayHours === 0 ? `${displayMinutes} minuter` : `${displayHours}h ${displayMinutes}m`}</div>
                        <div style="font-size: 15px; color: #9fa8da;">Det √§r ungef√§r hur l√§nge du beh√∂ver arbeta f√∂r detta k√∂p</div>
                    </div>
                </div>
                
                <!-- Info Modal -->
                <div id="infoModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 1000; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 20px; padding: 28px; max-width: 360px; width: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: 700; color: #e8eaf6;">‚ÑπÔ∏è Om Pris i tid</h3>
                            <button onclick="closeInfoModal()" style="background: none; border: none; color: #9fa8da; font-size: 24px; cursor: pointer; padding: 4px;">‚úï</button>
                        </div>
                        <div style="font-size: 14px; color: #9fa8da; line-height: 1.8;">
                            <p style="margin-bottom: 16px;"><strong style="color: #e8eaf6;">Vad √§r detta?</strong><br>
                            Ett verktyg som r√§knar om pengar till arbetstid. Ist√§llet f√∂r att t√§nka "kostar 500 kr" kan du t√§nka "kostar 2 timmar av mitt liv".</p>
                            
                            <p style="margin-bottom: 16px;"><strong style="color: #e8eaf6;">Hur ber√§knas det?</strong><br>
                            Din inkomst delas p√• arbetade timmar (ca 160h/m√•n eller 2080h/√•r) f√∂r att f√• timl√∂n. Sedan delas priset p√• timl√∂nen.</p>
                            
                            ${latestMonth ? `<p style="margin-bottom: 16px;"><strong style="color: #e8eaf6;">Din senaste m√•nadsinkomst:</strong><br>
                            <span style="color: #667eea; font-weight: 700;">${formatCurrency(latestIncome)}</span> (${latestMonth.displayDate})</p>` : ''}
                            
                            <p style="margin-bottom: 0;"><strong style="color: #ff9800;">üí° Visste du?</strong><br>
                            Studier visar att vi ofta underskattar hur mycket tid vi l√§gger p√• att tj√§na ihop till v√•ra k√∂p. Att t√§nka i tid kan hj√§lpa dig fatta b√§ttre beslut!</p>
                        </div>
                        <button onclick="closeInfoModal()" class="primary-button" style="margin-top: 24px; margin-bottom: 0;">F√∂rst√•tt!</button>
                    </div>
                </div>
            `;
        }

        function calculateHourlyIncome() {
            if (state.priceToTime.incomeAmount <= 0) return 0;
            
            switch(state.priceToTime.incomeType) {
                case 'hourly':
                    return state.priceToTime.incomeAmount;
                case 'monthly':
                    return (state.priceToTime.incomeAmount * 12) / (52 * 40);
                case 'yearly':
                    return state.priceToTime.incomeAmount / (52 * 40);
                default:
                    return 0;
            }
        }

        // No-spend streak hj√§lpfunktioner
        function getLatestMonth() {
            if (!state.months || state.months.length === 0) return null;
            // Returnera senaste m√•naden (sista i sorterad array)
            return state.months[state.months.length - 1];
        }
        
        function getStreakData() {
            const latestMonth = getLatestMonth();
            if (!latestMonth) return { dailyBudget: 0, streakDays: 0, totalSaved: 0, todaySaved: 0, remaining: 0, monthName: '' };
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Ber√§kna daglig budget baserat p√• kvar att anv√§nda i senaste m√•naden
            const extraIncome = getExtraIncome(latestMonth);
            const totalIncome = latestMonth.income + extraIncome;
            
            let totalSpent = 0;
            Object.values(latestMonth.categories).forEach(cat => {
                cat.items.forEach(item => {
                    totalSpent += item.amount;
                });
            });
            
            const remaining = totalIncome - totalSpent;
            const daysInMonth = getDaysInMonth(latestMonth.monthKey);
            const dailyBudget = Math.max(0, Math.round(remaining / daysInMonth));
            
            // Ber√§kna streak - antal dagar sedan senaste utgift
            let streakDays = 0;
            const lastExpenseDate = state.noSpendStreak.lastExpenseDate;
            
            if (!lastExpenseDate) {
                // Ingen utgift registrerad, r√§kna fr√•n streak-start
                if (state.noSpendStreak.streakStartDate) {
                    const startDate = new Date(state.noSpendStreak.streakStartDate);
                    streakDays = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                }
            } else {
                const lastExpense = new Date(lastExpenseDate);
                const daysSinceExpense = Math.floor((today - lastExpense) / (1000 * 60 * 60 * 24));
                
                // Om utgift var idag, streak = 0
                if (lastExpenseDate === todayStr) {
                    streakDays = 0;
                } else {
                    // Streak b√∂rjar dagen efter senaste utgift
                    streakDays = daysSinceExpense;
                    
                    // S√§tt streak startdatum om det inte finns
                    if (!state.noSpendStreak.streakStartDate && streakDays > 0) {
                        const nextDay = new Date(lastExpense);
                        nextDay.setDate(nextDay.getDate() + 1);
                        state.noSpendStreak.streakStartDate = nextDay.toISOString().split('T')[0];
                        saveState();
                    }
                }
            }
            
            // Uppdatera sparade dagar vid midnatt
            updateSavedDays(dailyBudget, todayStr, latestMonth.monthKey);
            
            const totalSaved = state.noSpendStreak.savedDays
                .filter(d => d.monthKey === latestMonth.monthKey)
                .reduce((sum, d) => sum + d.amount, 0);
            
            return {
                dailyBudget,
                streakDays,
                totalSaved,
                todaySaved: dailyBudget,
                remaining,
                monthName: latestMonth.displayDate,
                monthKey: latestMonth.monthKey
            };
        }
        
        function updateSavedDays(dailyBudget, todayStr, monthKey) {
            if (!state.noSpendStreak.savedDays) {
                state.noSpendStreak.savedDays = [];
            }
            
            const lastChecked = state.noSpendStreak.lastCheckedDate;
            
            // Om vi inte har kollat f√∂rut eller det √§r en ny dag
            if (lastChecked !== todayStr) {
                // L√§gg till alla dagar mellan lastChecked och ig√•r (inte idag, den √§r inte klar √§n)
                if (lastChecked && state.noSpendStreak.streakStartDate) {
                    const lastDate = new Date(lastChecked);
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    let checkDate = new Date(lastDate);
                    checkDate.setDate(checkDate.getDate() + 1);
                    
                    while (checkDate <= yesterday) {
                        const dateStr = checkDate.toISOString().split('T')[0];
                        
                        // Kolla att dagen inte redan finns och att vi hade en aktiv streak
                        const exists = state.noSpendStreak.savedDays.some(d => d.date === dateStr);
                        const wasInStreak = state.noSpendStreak.streakStartDate && 
                                           dateStr >= state.noSpendStreak.streakStartDate &&
                                           (!state.noSpendStreak.lastExpenseDate || dateStr > state.noSpendStreak.lastExpenseDate);
                        
                        if (!exists && wasInStreak) {
                            state.noSpendStreak.savedDays.push({
                                date: dateStr,
                                amount: dailyBudget,
                                monthKey: monthKey
                            });
                        }
                        
                        checkDate.setDate(checkDate.getDate() + 1);
                    }
                }
                
                state.noSpendStreak.lastCheckedDate = todayStr;
                saveState();
            }
        }

        function renderNoSpendStreak() {
            const latestMonth = getLatestMonth();
            if (!latestMonth) {
                goTo('budget');
                return;
            }
            
            const data = getStreakData();
            const today = new Date();
            const todayStr = today.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'long' });
            
            // Ber√§kna kommande dagar
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'short' });
            
            const dayAfter = new Date(today);
            dayAfter.setDate(dayAfter.getDate() + 2);
            const dayAfterStr = dayAfter.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'short' });
            
            // Streak f√§rg baserat p√• l√§ngd
            let streakColor = '#667eea';
            let streakEmoji = 'üî•';
            let motivationText = 'Varje dag utan utgift r√§knas!';
            
            if (data.streakDays >= 1) {
                streakColor = '#ff9800';
                motivationText = 'Bra start! Forts√§tt s√•!';
            }
            if (data.streakDays >= 3) {
                streakColor = '#ff5722';
                motivationText = 'Du √§r p√• g√•ng! üí™';
            }
            if (data.streakDays >= 7) {
                streakColor = '#f44336';
                streakEmoji = 'üî•üî•';
                motivationText = 'En hel vecka! Fantastiskt!';
            }
            if (data.streakDays >= 14) {
                streakEmoji = 'üî•üî•üî•';
                motivationText = 'Tv√• veckor! Du √§r unstoppable!';
            }
            if (data.streakDays >= 30) {
                streakEmoji = 'üëëüî•üëë';
                motivationText = 'LEGEND! En hel m√•nad!';
            }
            
            // Visa senaste sparade dagar
            const recentSaved = state.noSpendStreak.savedDays
                .filter(d => d.monthKey === data.monthKey)
                .sort((a, b) => b.date.localeCompare(a.date))
                .slice(0, 5);

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('profile')">‚Üê</button>
                        </div>
                        <h2>No-spend Streak</h2>
                        <div class="view-header-right">
                            <button class="icon-button" onclick="showInfoModal('noSpendStreak')">?</button>
                        </div>
                    </div>

                    <p style="font-size: 15px; color: #9fa8da; margin-bottom: 28px; text-align: center; font-weight: 500;">Spara pengar genom att inte spendera</p>

                    <!-- Streak Counter -->
                    <div style="background: linear-gradient(135deg, rgba(255, 152, 0, 0.15) 0%, rgba(244, 67, 54, 0.1) 100%); border: 2px solid ${streakColor}40; border-radius: 24px; padding: 32px; margin-bottom: 24px; text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 8px;">${streakEmoji}</div>
                        <div style="font-size: 72px; font-weight: 800; color: ${streakColor}; line-height: 1;">${data.streakDays}</div>
                        <div style="font-size: 18px; color: #9fa8da; margin-top: 8px; font-weight: 600;">${data.streakDays === 1 ? 'dag' : 'dagar'} i rad</div>
                        <div style="font-size: 14px; color: ${streakColor}; margin-top: 12px; font-weight: 600;">${motivationText}</div>
                    </div>

                    <!-- Totalt Sparat -->
                    <div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(56, 142, 60, 0.1) 100%); border: 2px solid rgba(76, 175, 80, 0.4); border-radius: 20px; padding: 24px; margin-bottom: 24px; text-align: center;">
                        <div style="font-size: 14px; color: #81c784; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">üí∞ Totalt sparat denna m√•nad</div>
                        <div style="font-size: 42px; font-weight: 800; color: #81c784;">${formatCurrency(data.totalSaved)}</div>
                        <div style="font-size: 13px; color: #9fa8da; margin-top: 8px;">Baserat p√• ${data.monthName}</div>
                    </div>

                    <!-- Kommande Dagar -->
                    <div style="background: rgba(102, 126, 234, 0.08); border: 2px solid rgba(102, 126, 234, 0.2); border-radius: 16px; padding: 20px; margin-bottom: 24px;">
                        <div style="font-size: 12px; color: #667eea; text-transform: uppercase; font-weight: 600; margin-bottom: 16px;">üéØ Kommande potential</div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                            <div>
                                <div style="font-size: 14px; font-weight: 600; color: #e8eaf6;">Idag</div>
                                <div style="font-size: 12px; color: #9fa8da; text-transform: capitalize;">${todayStr}</div>
                            </div>
                            <div style="font-size: 18px; font-weight: 700; color: #81c784;">+${formatCurrency(data.dailyBudget)}</div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                            <div>
                                <div style="font-size: 14px; font-weight: 600; color: #e8eaf6;">Imorgon</div>
                                <div style="font-size: 12px; color: #9fa8da; text-transform: capitalize;">${tomorrowStr}</div>
                            </div>
                            <div style="font-size: 18px; font-weight: 700; color: #81c784;">+${formatCurrency(data.dailyBudget * 2)}</div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0;">
                            <div>
                                <div style="font-size: 14px; font-weight: 600; color: #e8eaf6;">I √∂vermorgon</div>
                                <div style="font-size: 12px; color: #9fa8da; text-transform: capitalize;">${dayAfterStr}</div>
                            </div>
                            <div style="font-size: 18px; font-weight: 700; color: #81c784;">+${formatCurrency(data.dailyBudget * 3)}</div>
                        </div>
                    </div>

                    <!-- Senaste Sparade Dagar -->
                    ${recentSaved.length > 0 ? `
                        <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 20px; margin-bottom: 24px;">
                            <div style="font-size: 12px; color: #9fa8da; text-transform: uppercase; font-weight: 600; margin-bottom: 16px;">‚úÖ Senaste sparade dagar</div>
                            ${recentSaved.map(day => {
                                const date = new Date(day.date);
                                const dateStr = date.toLocaleDateString('sv-SE', { weekday: 'short', day: 'numeric', month: 'short' });
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                        <span style="font-size: 14px; color: #e8eaf6; text-transform: capitalize;">${dateStr}</span>
                                        <span style="font-size: 14px; font-weight: 700; color: #81c784;">+${formatCurrency(day.amount)}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <!-- Info Modal -->
                <div id="infoModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 1000; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 20px; padding: 28px; max-width: 360px; width: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: 700; color: #e8eaf6;">‚ÑπÔ∏è S√• fungerar det</h3>
                            <button onclick="closeInfoModal()" style="background: none; border: none; color: #9fa8da; font-size: 24px; cursor: pointer; padding: 4px;">‚úï</button>
                        </div>
                        <ul style="font-size: 14px; color: #9fa8da; line-height: 1.8; padding-left: 20px; margin: 0;">
                            <li>Streaken r√§knar dagar i rad utan nya utgifter</li>
                            <li style="margin-top: 8px;">Baseras alltid p√• senaste m√•naden: <strong style="color: #667eea;">${data.monthName}</strong></li>
                            <li style="margin-top: 8px;">Dagligt sparande = Kvar att anv√§nda (${formatCurrency(data.remaining)}) √∑ dagar i m√•naden</li>
                            <li style="margin-top: 8px;">Vid midnatt (00:00) l√§ggs dagens sparande till totalen</li>
                            <li style="margin-top: 8px;">N√§r du registrerar en utgift b√∂rjar streaken om fr√•n 0</li>
                        </ul>
                        <button onclick="closeInfoModal()" class="primary-button" style="margin-top: 24px; margin-bottom: 0;">F√∂rst√•tt!</button>
                    </div>
                </div>
            `;
        }

        // Svenska kommuner med skattesatser 2026
        const SWEDISH_MUNICIPALITIES = [
            {name: "Ale", tax: 32.80}, {name: "Alings√•s", tax: 32.84}, {name: "Alvesta", tax: 33.42}, {name: "Aneby", tax: 33.85},
            {name: "Arboga", tax: 33.12}, {name: "Arjeplog", tax: 34.08}, {name: "Arvidsjaur", tax: 33.85}, {name: "Arvika", tax: 33.69},
            {name: "Askersund", tax: 33.42}, {name: "Avesta", tax: 33.49}, {name: "Bengtsfors", tax: 34.04}, {name: "Berg", tax: 34.09},
            {name: "Bjurholm", tax: 34.63}, {name: "Bjuv", tax: 32.23}, {name: "Boden", tax: 33.71}, {name: "Bollebygd", tax: 32.66},
            {name: "Bolln√§s", tax: 33.12}, {name: "Borgholm", tax: 33.28}, {name: "Borl√§nge", tax: 33.41}, {name: "Bor√•s", tax: 32.59},
            {name: "Botkyrka", tax: 32.23}, {name: "Boxholm", tax: 32.52}, {name: "Brom√∂lla", tax: 33.14}, {name: "Br√§cke", tax: 34.39},
            {name: "Burl√∂v", tax: 32.14}, {name: "B√•stad", tax: 31.30}, {name: "Dals-Ed", tax: 34.34}, {name: "Danderyd", tax: 30.18},
            {name: "Degerfors", tax: 35.25}, {name: "Dorotea", tax: 35.65}, {name: "Eda", tax: 33.89}, {name: "Eker√∂", tax: 30.28},
            {name: "Eksj√∂", tax: 32.75}, {name: "Emmaboda", tax: 33.16}, {name: "Enk√∂ping", tax: 32.57}, {name: "Eskilstuna", tax: 32.52},
            {name: "Esl√∂v", tax: 32.04}, {name: "Essunga", tax: 32.73}, {name: "Fagersta", tax: 33.07}, {name: "Falkenberg", tax: 32.09},
            {name: "Falk√∂ping", tax: 32.78}, {name: "Falun", tax: 32.91}, {name: "Filipstad", tax: 34.10}, {name: "Finsp√•ng", tax: 33.02},
            {name: "Flen", tax: 33.22}, {name: "Forshaga", tax: 33.89}, {name: "F√§rgelanda", tax: 33.39}, {name: "Gagnef", tax: 33.21},
            {name: "Gislaved", tax: 32.55}, {name: "Gnesta", tax: 32.72}, {name: "Gnosj√∂", tax: 32.25}, {name: "Gotland", tax: 33.60},
            {name: "Grums", tax: 33.89}, {name: "Gr√§storp", tax: 32.73}, {name: "Gullsp√•ng", tax: 33.28}, {name: "G√§llivare", tax: 33.46},
            {name: "G√§vle", tax: 33.26}, {name: "G√∂teborg", tax: 32.40}, {name: "G√∂tene", tax: 33.23}, {name: "Habo", tax: 32.45},
            {name: "Hagfors", tax: 34.19}, {name: "Hallsberg", tax: 33.12}, {name: "Hallstahammar", tax: 33.07}, {name: "Halmstad", tax: 32.18},
            {name: "Hammar√∂", tax: 33.54}, {name: "Haninge", tax: 31.15}, {name: "Haparanda", tax: 33.71}, {name: "Heby", tax: 33.42},
            {name: "Hedemora", tax: 33.61}, {name: "Helsingborg", tax: 31.44}, {name: "Herrljunga", tax: 32.83}, {name: "Hjo", tax: 32.93},
            {name: "Hofors", tax: 33.56}, {name: "Huddinge", tax: 31.33}, {name: "Hudiksvall", tax: 33.02}, {name: "Hultsfred", tax: 33.16},
            {name: "Hylte", tax: 32.39}, {name: "H√•bo", tax: 32.22}, {name: "H√§llefors", tax: 34.05}, {name: "H√§rjedalen", tax: 34.09},
            {name: "H√§rn√∂sand", tax: 34.08}, {name: "H√§rryda", tax: 31.68}, {name: "H√§ssleholm", tax: 32.20}, {name: "H√∂gan√§s", tax: 31.11},
            {name: "H√∂gsby", tax: 33.71}, {name: "H√∂rby", tax: 32.23}, {name: "H√∂√∂r", tax: 31.87}, {name: "Jokkmokk", tax: 33.75},
            {name: "J√§rf√§lla", tax: 30.68}, {name: "J√∂nk√∂ping", tax: 32.55}, {name: "Kalix", tax: 33.71}, {name: "Kalmar", tax: 32.81},
            {name: "Karlsborg", tax: 32.48}, {name: "Karlshamn", tax: 32.64}, {name: "Karlskoga", tax: 33.47}, {name: "Karlskrona", tax: 32.84},
            {name: "Karlstad", tax: 33.19}, {name: "Katrineholm", tax: 32.62}, {name: "Kil", tax: 33.54}, {name: "Kinda", tax: 33.27},
            {name: "Kiruna", tax: 33.34}, {name: "Klippan", tax: 32.38}, {name: "Knivsta", tax: 31.82}, {name: "Kramfors", tax: 34.33},
            {name: "Kristianstad", tax: 32.41}, {name: "Kristinehamn", tax: 33.54}, {name: "Krokom", tax: 34.04}, {name: "Kumla", tax: 32.92},
            {name: "Kungsbacka", tax: 32.03}, {name: "Kungs√∂r", tax: 33.07}, {name: "Kung√§lv", tax: 32.55}, {name: "K√§vlinge", tax: 31.11},
            {name: "K√∂ping", tax: 33.07}, {name: "Laholm", tax: 32.59}, {name: "Landskrona", tax: 32.39}, {name: "Lax√•", tax: 33.94},
            {name: "Lekeberg", tax: 32.42}, {name: "Leksand", tax: 32.91}, {name: "Lerum", tax: 31.98}, {name: "Lessebo", tax: 33.46},
            {name: "Liding√∂", tax: 29.67}, {name: "Lidk√∂ping", tax: 32.53}, {name: "Lilla Edet", tax: 33.38}, {name: "Lindesberg", tax: 33.37},
            {name: "Link√∂ping", tax: 32.02}, {name: "Ljungby", tax: 32.68}, {name: "Ljusdal", tax: 33.67}, {name: "Ljusnarsberg", tax: 33.62},
            {name: "Lomma", tax: 30.74}, {name: "Ludvika", tax: 33.71}, {name: "Lule√•", tax: 33.23}, {name: "Lund", tax: 31.84},
            {name: "Lycksele", tax: 34.68}, {name: "Lysekil", tax: 33.43}, {name: "Malm√∂", tax: 32.42}, {name: "Malung-S√§len", tax: 33.56},
            {name: "Mal√•", tax: 34.68}, {name: "Mariestad", tax: 32.73}, {name: "Mark", tax: 32.63}, {name: "Markaryd", tax: 32.73},
            {name: "Mellerud", tax: 33.91}, {name: "Mj√∂lby", tax: 32.52}, {name: "Mora", tax: 33.16}, {name: "Motala", tax: 32.72},
            {name: "Mullsj√∂", tax: 32.80}, {name: "Munkedal", tax: 33.98}, {name: "Munkfors", tax: 34.29}, {name: "M√∂lndal", tax: 31.88},
            {name: "M√∂nster√•s", tax: 33.01}, {name: "M√∂rbyl√•nga", tax: 32.93}, {name: "Nacka", tax: 30.08}, {name: "Nora", tax: 33.17},
            {name: "Norberg", tax: 33.67}, {name: "Nordanstig", tax: 33.27}, {name: "Nordmaling", tax: 34.48}, {name: "Norrk√∂ping", tax: 32.52},
            {name: "Norrt√§lje", tax: 31.18}, {name: "Norsj√∂", tax: 34.73}, {name: "Nybro", tax: 33.31}, {name: "Nykvarn", tax: 30.98},
            {name: "Nyk√∂ping", tax: 32.47}, {name: "Nyn√§shamn", tax: 31.63}, {name: "N√§ssj√∂", tax: 33.30}, {name: "Ockelbo", tax: 33.46},
            {name: "Olofstr√∂m", tax: 33.04}, {name: "Orsa", tax: 33.26}, {name: "Orust", tax: 32.88}, {name: "Osby", tax: 33.46},
            {name: "Oskarshamn", tax: 33.06}, {name: "Ovan√•ker", tax: 33.22}, {name: "Oxel√∂sund", tax: 32.72}, {name: "Pajala", tax: 33.66},
            {name: "Partille", tax: 31.78}, {name: "Perstorp", tax: 32.33}, {name: "Pite√•", tax: 33.33}, {name: "Ragunda", tax: 34.49},
            {name: "Robertsfors", tax: 34.63}, {name: "Ronneby", tax: 33.04}, {name: "R√§ttvik", tax: 32.81}, {name: "Sala", tax: 33.07},
            {name: "Salem", tax: 30.73}, {name: "Sandviken", tax: 33.06}, {name: "Sigtuna", tax: 31.53}, {name: "Simrishamn", tax: 32.43},
            {name: "Sj√∂bo", tax: 32.29}, {name: "Skara", tax: 32.78}, {name: "Skellefte√•", tax: 33.08}, {name: "Skinnskatteberg", tax: 33.37},
            {name: "Skurup", tax: 32.09}, {name: "Sk√∂vde", tax: 32.58}, {name: "Smedjebacken", tax: 33.51}, {name: "Sollefte√•", tax: 34.33},
            {name: "Sollentuna", tax: 29.70}, {name: "Solna", tax: 29.63}, {name: "Sorsele", tax: 34.68}, {name: "Soten√§s", tax: 33.23},
            {name: "Staffanstorp", tax: 31.24}, {name: "Stenungsund", tax: 32.38}, {name: "Stockholm", tax: 30.33}, {name: "Storfors", tax: 34.09},
            {name: "Storuman", tax: 34.68}, {name: "Str√§ngn√§s", tax: 32.27}, {name: "Str√∂mstad", tax: 33.48}, {name: "Str√∂msund", tax: 34.39},
            {name: "Sundbyberg", tax: 30.63}, {name: "Sundsvall", tax: 33.48}, {name: "Sunne", tax: 33.84}, {name: "Surahammar", tax: 33.07},
            {name: "Sval√∂v", tax: 32.34}, {name: "Svedala", tax: 31.74}, {name: "Svenljunga", tax: 32.93}, {name: "S√§ffle", tax: 33.79},
            {name: "S√§ter", tax: 33.11}, {name: "S√§vsj√∂", tax: 32.70}, {name: "S√∂derhamn", tax: 33.42}, {name: "S√∂derk√∂ping", tax: 32.77},
            {name: "S√∂dert√§lje", tax: 31.58}, {name: "S√∂lvesborg", tax: 32.76}, {name: "Tanum", tax: 33.48}, {name: "Tibro", tax: 32.78},
            {name: "Tidaholm", tax: 32.83}, {name: "Tierp", tax: 32.67}, {name: "Timr√•", tax: 33.63}, {name: "Tingsryd", tax: 33.46},
            {name: "Tj√∂rn", tax: 32.68}, {name: "Tomelilla", tax: 32.54}, {name: "Torsby", tax: 34.09}, {name: "Tors√•s", tax: 33.46},
            {name: "Tranemo", tax: 32.53}, {name: "Tran√•s", tax: 32.60}, {name: "Trelleborg", tax: 32.19}, {name: "Trollh√§ttan", tax: 32.93},
            {name: "Trosa", tax: 31.72}, {name: "Tyres√∂", tax: 30.83}, {name: "T√§by", tax: 29.68}, {name: "T√∂reboda", tax: 33.08},
            {name: "Uddevalla", tax: 33.28}, {name: "Ulricehamn", tax: 32.58}, {name: "Ume√•", tax: 34.08}, {name: "Upplands V√§sby", tax: 30.98},
            {name: "Upplands-Bro", tax: 30.88}, {name: "Uppsala", tax: 32.77}, {name: "Uppvidinge", tax: 33.26}, {name: "Vadstena", tax: 33.02},
            {name: "Vaggeryd", tax: 32.50}, {name: "Valdemarsvik", tax: 33.57}, {name: "Vallentuna", tax: 30.23}, {name: "Vansbro", tax: 33.66},
            {name: "Vara", tax: 32.38}, {name: "Varberg", tax: 31.68}, {name: "Vaxholm", tax: 30.68}, {name: "Vellinge", tax: 29.69},
            {name: "Vetlanda", tax: 33.10}, {name: "Vilhelmina", tax: 35.00}, {name: "Vimmerby", tax: 33.16}, {name: "Vindeln", tax: 34.58},
            {name: "Ving√•ker", tax: 33.37}, {name: "V√•rg√•rda", tax: 32.88}, {name: "V√§nersborg", tax: 33.38}, {name: "V√§nn√§s", tax: 34.43},
            {name: "V√§rmd√∂", tax: 30.48}, {name: "V√§rnamo", tax: 32.45}, {name: "V√§stervik", tax: 33.36}, {name: "V√§ster√•s", tax: 32.57},
            {name: "V√§xj√∂", tax: 32.79}, {name: "Ydre", tax: 33.57}, {name: "Ystad", tax: 31.84}, {name: "√Öm√•l", tax: 33.78},
            {name: "√Önge", tax: 34.38}, {name: "√Öre", tax: 33.59}, {name: "√Örj√§ng", tax: 33.94}, {name: "√Ösele", tax: 35.10},
            {name: "√Östorp", tax: 32.24}, {name: "√Ötvidaberg", tax: 33.22}, {name: "√Ñlmhult", tax: 33.06}, {name: "√Ñlvdalen", tax: 33.26},
            {name: "√Ñlvkarleby", tax: 32.87}, {name: "√Ñlvsbyn", tax: 33.31}, {name: "√Ñngelholm", tax: 31.79}, {name: "√ñcker√∂", tax: 32.38},
            {name: "√ñdesh√∂g", tax: 33.17}, {name: "√ñrebro", tax: 32.72}, {name: "√ñrkelljunga", tax: 32.43}, {name: "√ñrnsk√∂ldsvik", tax: 34.03},
            {name: "√ñstersund", tax: 33.69}, {name: "√ñster√•ker", tax: 28.93}, {name: "√ñsthammar", tax: 32.82}, {name: "√ñstra G√∂inge", tax: 32.98},
            {name: "√ñverkalix", tax: 33.71}, {name: "√ñvertorne√•", tax: 33.71}
        ].sort((a, b) => a.name.localeCompare(b.name, 'sv'));

        // Prisbasbelopp 2026
        const PBB_2026 = 58800;
        const EMPLOYER_FEE = 0.3142; // 31.42%
        const STATE_TAX_RATE = 0.20; // 20%
        const STATE_TAX_THRESHOLD = 625800; // Skiktgr√§ns 2026 (ungef√§rlig)
        const BURIAL_FEE = 0.00293; // 0.293%
        const CHURCH_FEE_AVG = 0.01; // ca 1%

        function calculateGrundavdrag(yearlyIncome, birthYear) {
            const currentYear = new Date().getFullYear();
            const age = currentYear - birthYear;
            const isOver66 = age >= 66;
            
            // F√∂renklad ber√§kning av grundavdrag
            if (yearlyIncome <= 0) return 0;
            
            const pbb = PBB_2026;
            
            if (isOver66) {
                // F√∂rh√∂jt grundavdrag f√∂r 66+
                if (yearlyIncome <= 1.11 * pbb) return 0.99 * pbb;
                if (yearlyIncome <= 3.21 * pbb) return 0.77 * pbb + 0.2 * yearlyIncome;
                if (yearlyIncome <= 7.88 * pbb) return 1.415 * pbb;
                return 0.293 * pbb;
            } else {
                // Vanligt grundavdrag
                if (yearlyIncome <= 0.99 * pbb) return 0.423 * pbb;
                if (yearlyIncome <= 2.72 * pbb) return 0.423 * pbb + 0.2 * (yearlyIncome - 0.99 * pbb);
                if (yearlyIncome <= 3.11 * pbb) return 0.77 * pbb;
                if (yearlyIncome <= 7.88 * pbb) return 0.77 * pbb + 0.1 * (yearlyIncome - 3.11 * pbb);
                return 0.293 * pbb;
            }
        }

        function calculateJobbskatteavdrag(yearlyIncome, communalTax, birthYear) {
            const currentYear = new Date().getFullYear();
            const age = currentYear - birthYear;
            const isOver66 = age >= 66;
            
            const pbb = PBB_2026;
            const ga = calculateGrundavdrag(yearlyIncome, birthYear);
            const ki = communalTax / 100; // Kommunal skattesats som decimal
            
            // F√∂renklad jobbskatteavdragsber√§kning
            if (yearlyIncome <= 0) return 0;
            
            const ai = yearlyIncome; // Arbetsinkomst
            
            if (isOver66) {
                // F√∂rh√∂jt jobbskatteavdrag f√∂r 66+
                if (ai <= 1.0 * pbb) return (ai - ga) * ki;
                if (ai <= 3.0 * pbb) return (1.0 * pbb - ga + 0.35 * (ai - 1.0 * pbb)) * ki;
                if (ai <= 7.88 * pbb) return (1.0 * pbb - ga + 0.7 * pbb + 0.10 * (ai - 3.0 * pbb)) * ki;
                return (1.0 * pbb - ga + 0.7 * pbb + 0.488 * pbb) * ki;
            } else {
                // Vanligt jobbskatteavdrag (f√∂renklad 2026)
                if (ai <= 0.91 * pbb) return (ai - ga) * ki;
                if (ai <= 3.24 * pbb) return (0.91 * pbb - ga + 0.342 * (ai - 0.91 * pbb)) * ki;
                if (ai <= 8.08 * pbb) return (0.91 * pbb - ga + 0.797 * pbb + 0.128 * (ai - 3.24 * pbb)) * ki;
                return (0.91 * pbb - ga + 0.797 * pbb + 0.620 * pbb) * ki;
            }
        }

        function calculateSalaryAfterTax() {
            const s = state.salaryAfterTax;
            if (!s.municipality) return null;
            
            const muni = SWEDISH_MUNICIPALITIES.find(m => m.name === s.municipality);
            if (!muni) return null;
            
            // Ber√§kna bruttol√∂n per m√•nad
            let monthlyGross = 0;
            if (s.incomeType === 'monthly') {
                monthlyGross = s.grossSalary || 0;
            } else {
                monthlyGross = (s.hourlyRate || 0) * (s.hoursWorked || 0);
            }
            
            if (monthlyGross <= 0) return null;
            
            const yearlyGross = monthlyGross * 12;
            const communalTax = muni.tax;
            
            // Arbetsgivaravgifter
            const employerFee = monthlyGross * EMPLOYER_FEE;
            const totalEmployerCost = monthlyGross + employerFee;
            
            // Grundavdrag
            const yearlyGrundavdrag = calculateGrundavdrag(yearlyGross, s.birthYear);
            const monthlyGrundavdrag = yearlyGrundavdrag / 12;
            
            // Beskattningsbar inkomst
            const yearlyTaxableIncome = Math.max(0, yearlyGross - yearlyGrundavdrag);
            const monthlyTaxableIncome = yearlyTaxableIncome / 12;
            
            // Kommunalskatt
            const monthlyCommunalTax = monthlyTaxableIncome * (communalTax / 100);
            
            // Statlig skatt (om √∂ver skiktgr√§nsen)
            let monthlyStateTax = 0;
            if (yearlyGross > STATE_TAX_THRESHOLD) {
                const yearlyAboveThreshold = yearlyGross - STATE_TAX_THRESHOLD;
                monthlyStateTax = (yearlyAboveThreshold / 12) * STATE_TAX_RATE;
            }
            
            // Jobbskatteavdrag
            const yearlyJobbskatteavdrag = calculateJobbskatteavdrag(yearlyGross, communalTax, s.birthYear);
            const monthlyJobbskatteavdrag = yearlyJobbskatteavdrag / 12;
            
            // Begravningsavgift
            const monthlyBurialFee = monthlyTaxableIncome * BURIAL_FEE;
            
            // Kyrkoavgift
            const monthlyChurchFee = s.churchMember ? monthlyTaxableIncome * CHURCH_FEE_AVG : 0;
            
            // Total skatt f√∂re avdrag
            const totalTaxBeforeDeductions = monthlyCommunalTax + monthlyStateTax + monthlyBurialFee + monthlyChurchFee;
            
            // Slutlig skatt efter jobbskatteavdrag
            const finalTax = Math.max(0, totalTaxBeforeDeductions - monthlyJobbskatteavdrag);
            
            // Nettol√∂n
            const netSalary = monthlyGross - finalTax;
            
            // Skatteeffekt i procent
            const effectiveTaxRate = (finalTax / monthlyGross) * 100;
            
            return {
                monthlyGross: Math.round(monthlyGross),
                yearlyGross: Math.round(yearlyGross),
                employerFee: Math.round(employerFee),
                totalEmployerCost: Math.round(totalEmployerCost),
                grundavdrag: Math.round(monthlyGrundavdrag),
                taxableIncome: Math.round(monthlyTaxableIncome),
                communalTax: Math.round(monthlyCommunalTax),
                communalTaxRate: communalTax,
                stateTax: Math.round(monthlyStateTax),
                jobbskatteavdrag: Math.round(monthlyJobbskatteavdrag),
                burialFee: Math.round(monthlyBurialFee),
                churchFee: Math.round(monthlyChurchFee),
                totalTax: Math.round(finalTax),
                netSalary: Math.round(netSalary),
                effectiveTaxRate: effectiveTaxRate.toFixed(1),
                municipality: s.municipality
            };
        }

        function updateSalaryCalc() {
            const s = state.salaryAfterTax;
            
            if (s.incomeType === 'monthly') {
                s.grossSalary = parseFloat(document.getElementById('salaryInput')?.value) || 0;
            } else {
                s.hourlyRate = parseFloat(document.getElementById('hourlyInput')?.value) || 0;
                s.hoursWorked = parseFloat(document.getElementById('hoursInput')?.value) || 160;
            }
            
            s.municipality = document.getElementById('municipalitySelect')?.value || '';
            s.birthYear = parseInt(document.getElementById('birthYearInput')?.value) || 1990;
            s.churchMember = document.getElementById('churchCheckbox')?.checked || false;
            
            saveState();
            render();
        }

        function renderSalaryAfterTax() {
            const s = state.salaryAfterTax;
            const result = calculateSalaryAfterTax();
            
            const municipalityOptions = SWEDISH_MUNICIPALITIES.map(m => 
                `<option value="${m.name}" ${s.municipality === m.name ? 'selected' : ''}>${m.name} (${m.tax.toFixed(2)}%)</option>`
            ).join('');
            
            // Generera f√∂delse√•r (1940-2010)
            const birthYearOptions = [];
            for (let year = 2010; year >= 1940; year--) {
                birthYearOptions.push(`<option value="${year}" ${s.birthYear === year ? 'selected' : ''}>${year}</option>`);
            }

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('profile')">‚Üê</button>
                        </div>
                        <h2>L√∂n efter skatt</h2>
                        <div class="view-header-right">
                            <button class="icon-button" onclick="showInfoModal('salaryAfterTax')">?</button>
                        </div>
                    </div>

                    <p style="font-size: 15px; color: #9fa8da; margin-bottom: 24px; text-align: center; font-weight: 500;">Se vad du f√•r kvar efter skatt</p>

                    <!-- Inkomsttyp -->
                    <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                        <button class="budget-option" style="flex: 1; padding: 14px; text-align: center; ${s.incomeType === 'monthly' ? 'border-color: #667eea; background: rgba(102, 126, 234, 0.2);' : ''}" onclick="state.salaryAfterTax.incomeType = 'monthly'; render()">
                            <div style="font-weight: 700;">üí∞ M√•nadsl√∂n</div>
                        </button>
                        <button class="budget-option" style="flex: 1; padding: 14px; text-align: center; ${s.incomeType === 'hourly' ? 'border-color: #667eea; background: rgba(102, 126, 234, 0.2);' : ''}" onclick="state.salaryAfterTax.incomeType = 'hourly'; render()">
                            <div style="font-weight: 700;">‚è±Ô∏è Timl√∂n</div>
                        </button>
                    </div>

                    <!-- Inmatningsf√§lt -->
                    <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 20px; margin-bottom: 20px;">
                        ${s.incomeType === 'monthly' ? `
                            <div style="margin-bottom: 16px;">
                                <label style="font-size: 13px; color: #9fa8da; display: block; margin-bottom: 8px; font-weight: 600;">Bruttol√∂n per m√•nad (kr)</label>
                                <input type="number" id="salaryInput" value="${s.grossSalary || ''}" placeholder="35000" onchange="updateSalaryCalc()" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 14px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 18px; font-weight: 600;">
                            </div>
                        ` : `
                            <div style="margin-bottom: 16px;">
                                <label style="font-size: 13px; color: #9fa8da; display: block; margin-bottom: 8px; font-weight: 600;">Timl√∂n (kr)</label>
                                <input type="number" id="hourlyInput" value="${s.hourlyRate || ''}" placeholder="180" onchange="updateSalaryCalc()" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 14px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 18px; font-weight: 600;">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="font-size: 13px; color: #9fa8da; display: block; margin-bottom: 8px; font-weight: 600;">Antal timmar per m√•nad</label>
                                <input type="number" id="hoursInput" value="${s.hoursWorked || 160}" placeholder="160" onchange="updateSalaryCalc()" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 14px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 18px; font-weight: 600;">
                            </div>
                        `}
                        
                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 13px; color: #9fa8da; display: block; margin-bottom: 8px; font-weight: 600;">üìç Kommun</label>
                            <select id="municipalitySelect" onchange="updateSalaryCalc()" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 14px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 16px;">
                                <option value="">V√§lj kommun...</option>
                                ${municipalityOptions}
                            </select>
                        </div>

                        <div style="display: flex; gap: 12px;">
                            <div style="flex: 1;">
                                <label style="font-size: 13px; color: #9fa8da; display: block; margin-bottom: 8px; font-weight: 600;">üéÇ F√∂delse√•r</label>
                                <select id="birthYearInput" onchange="updateSalaryCalc()" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 14px; width: 100%; color: #e8eaf6; font-family: inherit; font-size: 16px;">
                                    ${birthYearOptions.join('')}
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 13px; color: #9fa8da; display: block; margin-bottom: 8px; font-weight: 600;">‚õ™ Svenska kyrkan</label>
                                <div style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <input type="checkbox" id="churchCheckbox" ${s.churchMember ? 'checked' : ''} onchange="updateSalaryCalc()" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #e8eaf6; font-size: 14px;">Medlem</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${result ? `
                        <!-- Nettol√∂n highlight -->
                        <div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(56, 142, 60, 0.1) 100%); border: 2px solid rgba(76, 175, 80, 0.4); border-radius: 20px; padding: 28px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 14px; color: #81c784; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">üíµ Din l√∂n efter skatt</div>
                            <div style="font-size: 48px; font-weight: 800; color: #81c784;">${formatCurrency(result.netSalary)}</div>
                            <div style="font-size: 14px; color: #9fa8da; margin-top: 8px;">per m√•nad i ${result.municipality}</div>
                        </div>

                        <!-- Skattesammanfattning -->
                        <div style="background: rgba(239, 83, 80, 0.08); border: 2px solid rgba(239, 83, 80, 0.2); border-radius: 16px; padding: 20px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 13px; color: #ef5350; text-transform: uppercase; font-weight: 600; margin-bottom: 6px;">üèõÔ∏è Total skatt</div>
                            <div style="font-size: 32px; font-weight: 800; color: #ef5350;">${formatCurrency(result.totalTax)}</div>
                            <div style="font-size: 14px; color: #9fa8da; margin-top: 6px;">Effektiv skattesats: ${result.effectiveTaxRate}%</div>
                        </div>

                        <!-- Detaljerad uppdelning -->
                        <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 20px; margin-bottom: 20px;">
                            <div style="font-size: 12px; color: #667eea; text-transform: uppercase; font-weight: 600; margin-bottom: 16px;">üìä S√• f√∂rdelas din l√∂n</div>
                            
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <span style="color: #9fa8da; font-size: 14px;">Bruttol√∂n</span>
                                <span style="color: #e8eaf6; font-size: 14px; font-weight: 700;">${formatCurrency(result.monthlyGross)}</span>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <span style="color: #9fa8da; font-size: 14px;">‚àí Kommunalskatt (${result.communalTaxRate}%)</span>
                                <span style="color: #ef5350; font-size: 14px; font-weight: 600;">‚àí${formatCurrency(result.communalTax)}</span>
                            </div>
                            
                            ${result.stateTax > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <span style="color: #9fa8da; font-size: 14px;">‚àí Statlig skatt (20%)</span>
                                <span style="color: #ef5350; font-size: 14px; font-weight: 600;">‚àí${formatCurrency(result.stateTax)}</span>
                            </div>
                            ` : ''}
                            
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <span style="color: #9fa8da; font-size: 14px;">‚àí Begravningsavgift</span>
                                <span style="color: #ef5350; font-size: 14px; font-weight: 600;">‚àí${formatCurrency(result.burialFee)}</span>
                            </div>
                            
                            ${result.churchFee > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <span style="color: #9fa8da; font-size: 14px;">‚àí Kyrkoavgift</span>
                                <span style="color: #ef5350; font-size: 14px; font-weight: 600;">‚àí${formatCurrency(result.churchFee)}</span>
                            </div>
                            ` : ''}
                            
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <span style="color: #9fa8da; font-size: 14px;">+ Jobbskatteavdrag</span>
                                <span style="color: #81c784; font-size: 14px; font-weight: 600;">+${formatCurrency(result.jobbskatteavdrag)}</span>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; margin-top: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; padding: 12px;">
                                <span style="color: #81c784; font-size: 15px; font-weight: 700;">= Nettol√∂n</span>
                                <span style="color: #81c784; font-size: 15px; font-weight: 700;">${formatCurrency(result.netSalary)}</span>
                            </div>
                        </div>

                        <!-- Arbetsgivarkostnad -->
                        <div style="background: rgba(102, 126, 234, 0.08); border: 2px solid rgba(102, 126, 234, 0.2); border-radius: 16px; padding: 20px;">
                            <div style="font-size: 12px; color: #667eea; text-transform: uppercase; font-weight: 600; margin-bottom: 16px;">üè¢ Arbetsgivarens kostnad</div>
                            
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <span style="color: #9fa8da; font-size: 14px;">Din bruttol√∂n</span>
                                <span style="color: #e8eaf6; font-size: 14px; font-weight: 600;">${formatCurrency(result.monthlyGross)}</span>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(159, 168, 218, 0.1);">
                                <span style="color: #9fa8da; font-size: 14px;">+ Arbetsgivaravgift (31,42%)</span>
                                <span style="color: #667eea; font-size: 14px; font-weight: 600;">+${formatCurrency(result.employerFee)}</span>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; margin-top: 8px; background: rgba(102, 126, 234, 0.15); border-radius: 8px; padding: 12px;">
                                <span style="color: #667eea; font-size: 15px; font-weight: 700;">= Total kostnad</span>
                                <span style="color: #667eea; font-size: 15px; font-weight: 700;">${formatCurrency(result.totalEmployerCost)}</span>
                            </div>
                        </div>
                    ` : `
                        <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 32px; text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üí∞</div>
                            <div style="font-size: 16px; color: #9fa8da;">Fyll i din l√∂n och kommun f√∂r att se din nettol√∂n</div>
                        </div>
                    `}
                </div>
                
                <!-- Info Modal -->
                <div id="infoModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 1000; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 20px; padding: 28px; max-width: 360px; width: 100%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: 700; color: #e8eaf6;">‚ÑπÔ∏è Om skatteber√§kningen</h3>
                            <button onclick="closeInfoModal()" style="background: none; border: none; color: #9fa8da; font-size: 24px; cursor: pointer; padding: 4px;">‚úï</button>
                        </div>
                        <div style="font-size: 14px; color: #9fa8da; line-height: 1.8;">
                            <p style="margin-bottom: 16px;"><strong style="color: #e8eaf6;">Vad ing√•r?</strong><br>
                            Ber√§kningen inkluderar kommunalskatt, statlig skatt, grundavdrag, jobbskatteavdrag, begravningsavgift och kyrkoavgift.</p>
                            
                            <p style="margin-bottom: 16px;"><strong style="color: #667eea;">Kommunalskatt</strong><br>
                            Varierar mellan 28,93% (√ñster√•ker) och 35,65% (Dorotea). Rikssnitt: 32,38%.</p>
                            
                            <p style="margin-bottom: 16px;"><strong style="color: #667eea;">Statlig skatt</strong><br>
                            20% p√• √•rsinkomst √∂ver ca 625 800 kr (ca 52 150 kr/m√•n).</p>
                            
                            <p style="margin-bottom: 16px;"><strong style="color: #81c784;">Jobbskatteavdrag</strong><br>
                            Minskar skatten med upp till ~4 400 kr/m√•n. St√∂rre f√∂r 66+.</p>
                            
                            <p style="margin-bottom: 16px;"><strong style="color: #ff9800;">Arbetsgivaravgift</strong><br>
                            31,42% ut√∂ver din l√∂n. Finansierar pension, sjukf√∂rs√§kring mm.</p>
                            
                            <p style="margin-bottom: 0;"><strong style="color: #9fa8da;">OBS!</strong><br>
                            Detta √§r en f√∂renklad ber√§kning. Exakta v√§rden kan variera beroende p√• individuella faktorer.</p>
                        </div>
                        <button onclick="closeInfoModal()" class="primary-button" style="margin-top: 24px; margin-bottom: 0;">F√∂rst√•tt!</button>
                    </div>
                </div>
            `;
        }

        function renderHistory() {
            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('profile')">‚Üê</button>
                        </div>
                        <h2>${t('history')}</h2>
                        <div class="view-header-right"></div>
                    </div>
                    
                    <p style="font-size: 13px; color: #9fa8da; margin-bottom: 24px; text-align: center; font-weight: 500;">H√§r finns det samtliga registrerade m√•nader</p>
                    
                    ${state.months && state.months.length > 0 ? state.months.map(month => {
                        const spent = Object.values(month.categories).reduce((sum, cat) => sum + cat.items.reduce((s, item) => s + item.amount, 0), 0);
                        const extraIncome = getExtraIncome(month);
                        const totalIncome = month.income + extraIncome;
                        const isSimple = isMonthSimpleMode(month);
                        const isCurrentMonth = state.currentMonth && state.currentMonth.monthKey === month.monthKey;
                        return `
                            <div class="history-month" style="cursor: default;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                    <div>
                                        <h3 style="margin-bottom: 4px;">${month.displayDate}</h3>
                                        <div style="font-size: 11px; color: #667eea; text-transform: uppercase;">${isSimple ? 'üìä Enkel modell' : 'üìà Procentmodell'}${isCurrentMonth ? ' ‚Ä¢ <span style="color: #81c784;">Aktiv</span>' : ''}</div>
                                    </div>
                                </div>
                                <div class="history-month-stats">
                                    <div style="margin-bottom: 8px;">
                                        <span style="color: #9fa8da; font-size: 12px;">INKOMST:</span> <span style="font-weight: 700; color: #667eea;">${formatCurrency(totalIncome)}</span>
                                        ${extraIncome > 0 ? `<span style="font-size: 11px; color: #81c784;"> (+${formatCurrency(extraIncome)} extra)</span>` : ''}
                                    </div>
                                    <div style="margin-bottom: 16px;">
                                        <span style="color: #9fa8da; font-size: 12px;">UTGIFTER:</span> <span style="font-weight: 700; color: #667eea;">${formatCurrency(spent)}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="selectMonth('${month.monthKey}')" style="flex: 1; background: rgba(102, 126, 234, 0.15); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 12px; color: #667eea; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease;">
                                        ‚úèÔ∏è Redigera
                                    </button>
                                    <button onclick="confirmDeleteMonth('${month.monthKey}', '${month.displayDate}')" style="flex: 1; background: rgba(239, 83, 80, 0.1); border: 2px solid rgba(239, 83, 80, 0.3); border-radius: 10px; padding: 12px; color: #ef5350; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease;">
                                        üóëÔ∏è Radera
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('') : '<p style="color: #9fa8da; text-align: center; padding: 32px 0;">Ingen historik √§nnu</p>'}
                </div>
                
                <!-- Delete Confirmation Modal -->
                <div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%); border: 2px solid rgba(239, 83, 80, 0.4); border-radius: 20px; padding: 28px; max-width: 340px; width: 100%; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                        <h3 style="font-size: 20px; font-weight: 700; color: #e8eaf6; margin-bottom: 12px;">Radera m√•nad?</h3>
                        <p id="deleteModalText" style="font-size: 14px; color: #9fa8da; margin-bottom: 24px;">√Ñr du s√§ker p√• att du vill radera denna m√•nad? Detta g√•r inte att √•ngra.</p>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeDeleteModal()" style="flex: 1; background: rgba(159, 168, 218, 0.1); border: 2px solid rgba(159, 168, 218, 0.3); border-radius: 12px; padding: 14px; color: #9fa8da; cursor: pointer; font-size: 15px; font-weight: 600;">
                                Avbryt
                            </button>
                            <button id="confirmDeleteBtn" onclick="" style="flex: 1; background: rgba(239, 83, 80, 0.2); border: 2px solid rgba(239, 83, 80, 0.5); border-radius: 12px; padding: 14px; color: #ef5350; cursor: pointer; font-size: 15px; font-weight: 700;">
                                Radera
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEditExpenses() {
            if (!state.currentMonth) return;
            let allExpenses = [];
            Object.entries(state.currentMonth.categories).forEach(([key, cat]) => {
                cat.items.forEach(item => {
                    allExpenses.push({ ...item, category: key, categoryName: cat.name });
                });
            });

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('profile')">‚Üê</button>
                        </div>
                        <h2>${t('editExpenses')}</h2>
                        <div class="view-header-right"></div>
                    </div>
                    ${allExpenses.length > 0 ? `
                        <div style="margin-bottom: 24px;">
                            ${allExpenses.map(expense => `
                                <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 14px; padding: 16px; margin-bottom: 12px;">
                                    <div style="font-size: 12px; color: #9fa8da; margin-bottom: 12px; text-transform: uppercase; font-weight: 600;">${expense.categoryName}</div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <label style="font-size: 12px; color: #9fa8da; margin-bottom: 4px; display: block;">Namn</label>
                                        <input type="text" value="${expense.name}" onchange="updateExpenseName('${expense.category}', ${expense.id}, this.value)" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 8px; color: #e8eaf6; font-family: inherit; width: 100%;">
                                    </div>

                                    <div style="display: flex; gap: 8px; align-items: flex-end;">
                                        <div style="flex: 1;">
                                            <label style="font-size: 12px; color: #9fa8da; margin-bottom: 4px; display: block;">Belopp</label>
                                            <input type="number" value="${expense.amount}" onchange="updateExpenseAmount('${expense.category}', ${expense.id}, this.value)" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 8px; color: #e8eaf6; font-family: inherit; width: 100%;">
                                        </div>
                                        <div style="flex: 1;">
                                            <label style="font-size: 12px; color: #9fa8da; margin-bottom: 4px; display: block;">Kategori</label>
                                            <select onchange="moveExpense('${expense.category}', ${expense.id}, this.value)" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 8px; color: #e8eaf6; font-family: inherit; width: 100%;">
                                                <option value="${expense.category}" selected>${expense.categoryName}</option>
                                                ${Object.entries(state.currentMonth.categories).filter(([key]) => key !== expense.category).map(([key, cat]) => `
                                                    <option value="${key}">‚Üí ${cat.name}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <button class="delete-button" onclick="deleteExpense('${expense.category}', ${expense.id})" style="margin-bottom: 0;">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `<p style="color: #9fa8da; text-align: center; padding: 32px 0;">${t('noExpenses')}</p>`}
                    
                    ${allExpenses.length > 0 ? `
                        <button class="primary-button" onclick="saveExpenseTemplate(); goTo('budget');" style="margin-top: 16px;">üíæ Spara utgiftsmal</button>
                    ` : ''}
                </div>
            `;
        }

        function renderCategory() {
            if (!state.selectedCategory || !state.currentMonth) return;
            const key = state.selectedCategory.key;
            const cat = state.currentMonth.categories[key];
            const spent = cat.items.reduce((sum, item) => sum + item.amount, 0);
            
            // FIX: Ber√§kna budget korrekt f√∂r b√•de simple och percentage mode
            const isSimple = isMonthSimpleMode(state.currentMonth);
            const extraIncome = getExtraIncome(state.currentMonth);
            const totalIncome = state.currentMonth.income + extraIncome;
            
            let budget, remaining;
            if (isSimple) {
                budget = totalIncome;
                remaining = totalIncome - spent;
            } else {
                budget = totalIncome * (cat.percentage / 100);
                remaining = budget - spent;
            }
            
            const isOverBudget = remaining < 0;
            const warningThreshold = budget * 0.1;
            const isWarning = remaining >= 0 && remaining <= warningThreshold;

            let statusColor = '#81c784';
            let psychoText = 'Okej, jag kan ta en lunch idag';

            if (isOverBudget) {
                statusColor = '#e57373';
                psychoText = 'Fyfan, nu √§r jag fattig...';
            } else if (isWarning) {
                statusColor = '#ffa726';
                psychoText = 'Aj aj nu blir det matl√•dor';
            }

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('budget')">‚Üê</button>
                        </div>
                        <h2>${cat.name}</h2>
                        <div class="view-header-right"></div>
                    </div>

                    <div class="total-card" style="margin-bottom: 24px;">
                        <h3>Status</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                            <div>
                                <div style="font-size: 12px; color: #9fa8da; margin-bottom: 4px;">${isSimple ? 'Total inkomst' : 'Budget'}</div>
                                <div style="font-size: 18px; font-weight: 700;">${formatCurrency(budget)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #9fa8da; margin-bottom: 4px;">Anv√§nt</div>
                                <div style="font-size: 18px; font-weight: 700;">${formatCurrency(spent)}</div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(159, 168, 218, 0.1); text-align: center;">
                            <div style="font-size: 12px; color: ${statusColor}; margin-bottom: 8px; font-weight: 600;">${isOverBudget ? '√ñVERSTIGER BUDGET' : 'KVAR ATT ANV√ÑNDA'}</div>
                            <div style="font-size: 24px; font-weight: 700; color: ${statusColor};">${formatCurrency(Math.abs(remaining))}</div>
                        </div>
                    </div>

                    ${state.editingItem && state.editingItem.key === key ? `
                        <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 24px; display: flex; gap: 10px; align-items: flex-end;">
                            <input type="text" id="editName" value="${state.editingItem.name}" placeholder="Namn" style="flex: 0.5; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 13px;">
                            <input type="number" id="editAmount" value="${state.editingItem.amount}" placeholder="Belopp" style="flex: 0.3; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 13px; min-width: 80px;" min="1">
                            <button type="button" class="primary-button" style="padding: 10px 18px; font-size: 13px; margin: 0;" onclick="saveEditingItem('${key}')">Uppdatera</button>
                            <button type="button" style="background: rgba(159, 168, 218, 0.1); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px 16px; color: #9fa8da; cursor: pointer; font-size: 13px; font-weight: 600;" onclick="cancelEditing()">Avbryt</button>
                        </div>
                    ` : `
                        <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 24px; display: flex; gap: 10px; align-items: flex-end;">
                            <input type="text" id="expenseName" placeholder="Namn" style="flex: 0.5; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 13px;">
                            <input type="number" id="expenseAmount" placeholder="Belopp" style="flex: 0.3; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 13px; min-width: 80px;" min="1">
                            <button type="button" class="primary-button" style="padding: 10px 18px; font-size: 13px; margin: 0;" onclick="addExpenseQuick('${key}')">L√§gg till</button>
                        </div>
                    `}

                    <h3 style="font-size: 14px; color: #9fa8da; margin-bottom: 16px; font-weight: 600; text-transform: uppercase; margin-top: 32px;">Sparade utgifter (${cat.items.length})</h3>
                    <div style="margin-bottom: 32px;">
                        ${cat.items.map(item => `
                            <div class="expense-item" style="align-items: center;">
                                <span class="expense-name">${item.name}</span>
                                <span class="expense-amount">${formatCurrency(item.amount)}</span>
                                <button type="button" style="background: none; border: none; cursor: pointer; font-size: 16px; padding: 6px; color: #667eea; opacity: 0.7; transition: all 0.2s ease;" onclick="editExpense('${key}', ${item.id})" onmouseover="this.style.opacity='1';" onmouseout="this.style.opacity='0.7';">‚úèÔ∏è</button>
                                <button class="delete-button" onclick="deleteExpense('${key}', ${item.id})">üóëÔ∏è</button>
                            </div>
                        `).join('')}
                    </div>

                    <button class="primary-button" onclick="goTo('budget')" style="width: 100%;">‚úì Klart</button>
                </div>
            `;
            if (!state.editingItem || state.editingItem.key !== key) {
                document.getElementById('expenseName')?.focus();
            } else {
                document.getElementById('editName')?.focus();
            }
        }

        function addExpenseQuick(key) {
            const nameInput = document.getElementById('expenseName');
            const amountInput = document.getElementById('expenseAmount');
            
            if (!nameInput || !amountInput) return;
            
            const name = nameInput.value.trim();
            const amount = parseFloat(amountInput.value);
            
            if (!name || !amount || amount <= 0 || isNaN(amount)) {
                alert('Fyll i ett giltigt namn och belopp');
                return;
            }

            if (!state.currentMonth || !state.currentMonth.categories[key]) {
                alert('Fel: Kategorin hittades inte');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            
            const newExpense = {
                id: Date.now() + Math.floor(Math.random() * 10000),
                name: name,
                amount: amount,
                date: today // Spara datum f√∂r streak-funktionen
            };
            
            state.currentMonth.categories[key].items.push(newExpense);
            
            // Bryt streak - registrera att en utgift lades till idag
            state.noSpendStreak.lastExpenseDate = today;
            state.noSpendStreak.streakStartDate = null; // √Öterst√§ll streak
            
            saveState();
            render();
            
            setTimeout(() => {
                const newNameInput = document.getElementById('expenseName');
                if (newNameInput) {
                    newNameInput.focus();
                }
            }, 0);
        }

        // HANDLERS
        function goTo(view) { state.view = view; saveState(); render(); }
        function goToCategory(key) { state.selectedCategory = { key, ...state.currentMonth.categories[key] }; goTo('category'); }
        
        function resetForNewMonth() {
            state.currentMonth = null;
            state.selectedCategory = null;
            state.showExtraIncomeForm = false;
            state.pendingIncome = 0;
            state.pendingMonth = new Date().getMonth() + 1;
            state.pendingYear = new Date().getFullYear();
            state.totalResultView = 'month';
            goTo('createIncome');
        }

        function selectBudgetModel(model) {
            state.budgetModel = model;
            if (model === 'recommended') {
                state.customPercentages = { fasta: 50, nojen: 30, sparande: 20 };
            } else if (model === 'simple') {
                state.customPercentages = { fasta: 0, nojen: 0, sparande: 0 };
            }
        }

        function updateCustomPercentage(category, value) {
            state.customPercentages[category] = Math.max(0, Math.min(100, parseInt(value) || 0));
            render();
        }

        function createBudgetWithDate() {
            const income = state.pendingIncome;
            const month = state.pendingMonth;
            const year = state.pendingYear;
            
            if (!income || income <= 0) {
                alert('Ange en giltig inkomst');
                return;
            }

            const monthNames = ['', 'Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni', 'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'];
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            const displayDate = month > 0 ? `${monthNames[month]} ${year}` : `${year}`;

            let newMonth;
            
            if (state.budgetModel === 'simple') {
                // FIX: Spara budgetModel med m√•naden
                newMonth = {
                    monthKey, displayDate, income, extraIncome: 0,
                    budgetModel: 'simple', // FIX: Spara modellen
                    categories: {
                        utgifter: { name: 'Utgifter', percentage: 0, budget: income, items: [] }
                    }
                };
            } else {
                // FIX: Spara budgetModel med m√•naden
                newMonth = {
                    monthKey, displayDate, income, extraIncome: 0,
                    budgetModel: state.budgetModel, // FIX: Spara modellen
                    customPercentages: { ...state.customPercentages }, // FIX: Spara procentsatserna
                    categories: {
                        fasta: { name: t('fixedCosts'), percentage: state.customPercentages.fasta, budget: income * (state.customPercentages.fasta / 100), items: [] },
                        nojen: { name: t('fun'), percentage: state.customPercentages.nojen, budget: income * (state.customPercentages.nojen / 100), items: [] },
                        sparande: { name: t('savings'), percentage: state.customPercentages.sparande, budget: income * (state.customPercentages.sparande / 100), items: [] }
                    }
                };
            }

            if (!state.months) {
                state.months = [];
            }

            const existingIndex = state.months.findIndex(m => m.monthKey === monthKey);
            if (existingIndex >= 0) {
                state.months[existingIndex] = newMonth;
            } else {
                state.months.push(newMonth);
                state.months.sort((a, b) => a.monthKey.localeCompare(b.monthKey));
            }

            state.currentMonth = newMonth;
            state.priceToTime.incomeType = 'monthly';
            state.priceToTime.incomeAmount = income;
            saveState();
            goTo('budget');
        }

        function toggleExtraIncome() {
            state.showExtraIncomeForm = !state.showExtraIncomeForm;
            render();
            if (state.showExtraIncomeForm) {
                setTimeout(() => {
                    const input = document.getElementById('extraIncomeInput');
                    if (input) input.focus();
                }, 100);
            }
        }

        function removeExtraIncome() {
            // FIX: Uppdatera endast currentMonth, inte en separat state.extraIncome
            if (state.currentMonth) {
                state.currentMonth.extraIncome = 0;
            }
            state.showExtraIncomeForm = false;
            saveState();
            render();
        }

        function cancelExtraIncome() {
            state.showExtraIncomeForm = false;
            render();
        }

        // FIX: Uppdaterad updateMainIncome som fungerar f√∂r b√•de simple och percentage mode
        function updateMainIncome(newIncome) {
            const income = parseFloat(newIncome);
            if (income && income > 0 && state.currentMonth) {
                state.currentMonth.income = income;
                
                // FIX: Uppdatera budget baserat p√• budgetmodellen
                const isSimple = isMonthSimpleMode(state.currentMonth);
                
                if (isSimple) {
                    // I simple mode, s√§tt utgifter-budget till hela inkomsten
                    if (state.currentMonth.categories.utgifter) {
                        const extraIncome = getExtraIncome(state.currentMonth);
                        state.currentMonth.categories.utgifter.budget = income + extraIncome;
                    }
                } else {
                    // I percentage mode, uppdatera varje kategori baserat p√• procent
                    const extraIncome = getExtraIncome(state.currentMonth);
                    const totalIncome = income + extraIncome;
                    
                    Object.keys(state.currentMonth.categories).forEach(key => {
                        const cat = state.currentMonth.categories[key];
                        cat.budget = totalIncome * (cat.percentage / 100);
                    });
                }
                
                saveState();
                render();
            }
        }

        // FIX: Uppdaterad saveExtraIncome som sparar till currentMonth
        function saveExtraIncome() {
            const input = document.getElementById('extraIncomeInput');
            if (input && state.currentMonth) {
                const value = parseFloat(input.value);
                if (value > 0) {
                    state.currentMonth.extraIncome = value;
                    state.showExtraIncomeForm = false;
                    
                    // FIX: Uppdatera budgetar baserat p√• ny total inkomst
                    const isSimple = isMonthSimpleMode(state.currentMonth);
                    const totalIncome = state.currentMonth.income + value;
                    
                    if (isSimple) {
                        if (state.currentMonth.categories.utgifter) {
                            state.currentMonth.categories.utgifter.budget = totalIncome;
                        }
                    } else {
                        Object.keys(state.currentMonth.categories).forEach(key => {
                            const cat = state.currentMonth.categories[key];
                            cat.budget = totalIncome * (cat.percentage / 100);
                        });
                    }
                    
                    saveState();
                    render();
                } else {
                    input.focus();
                }
            }
        }

        function addExpense(key, e) {
            e.preventDefault();
            const name = document.getElementById('expenseName').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            if (!name || !amount) return;
            
            const today = new Date().toISOString().split('T')[0];
            state.currentMonth.categories[key].items.push({ 
                id: Date.now(), 
                name, 
                amount,
                date: today 
            });
            
            // Bryt streak
            state.noSpendStreak.lastExpenseDate = today;
            state.noSpendStreak.streakStartDate = null;
            
            saveState();
            goTo('category');
        }

        function startEditingItem(key, id, name, amount) {
            state.editingItem = { key, id, name, amount };
            render();
        }

        function editExpense(key, id) {
            if (!state.currentMonth || !state.currentMonth.categories[key]) return;
            
            const item = state.currentMonth.categories[key].items.find(i => i.id === id);
            if (item) {
                state.editingItem = { key, id, name: item.name, amount: item.amount };
                render();
            }
        }

        function saveEditingItem(key) {
            const nameInput = document.getElementById('editName');
            const amountInput = document.getElementById('editAmount');
            
            if (!nameInput || !amountInput) return;
            
            const name = nameInput.value.trim();
            const amount = parseFloat(amountInput.value);
            
            if (!name || !amount || amount <= 0 || isNaN(amount)) {
                alert('Fyll i ett giltigt namn och belopp');
                return;
            }

            if (!state.currentMonth || !state.currentMonth.categories[key]) {
                alert('Fel: Kategorin hittades inte');
                return;
            }

            const item = state.currentMonth.categories[key].items.find(i => i.id === state.editingItem.id);
            if (item) {
                item.name = name;
                item.amount = amount;
                state.editingItem = null;
                saveState();
                render();
            } else {
                alert('Fel: Utgiften hittades inte');
            }
        }

        function cancelEditing() {
            state.editingItem = null;
            render();
        }

        function saveMonthAndGo() {
            if (!state.currentMonth) {
                alert('Ingen m√•nad att spara!');
                return;
            }
            
            if (!state.months) {
                state.months = [];
            }
            
            const existingIndex = state.months.findIndex(m => m.monthKey === state.currentMonth.monthKey);
            if (existingIndex >= 0) {
                state.months[existingIndex] = { ...state.currentMonth };
            } else {
                state.months.push({ ...state.currentMonth });
                state.months.sort((a, b) => a.monthKey.localeCompare(b.monthKey));
            }
            
            saveState();
            alert(`‚úÖ ${state.currentMonth.displayDate} har sparats!`);
            goTo('totalResult');
        }

        function deleteExpense(key, id) {
            state.currentMonth.categories[key].items = state.currentMonth.categories[key].items.filter(i => i.id !== id);
            saveState();
            render();
        }

        function saveExpenseTemplate() {
            if (!state.currentMonth) return;
            let template = {};
            Object.entries(state.currentMonth.categories).forEach(([key, cat]) => {
                template[key] = cat.items.map(item => ({ ...item }));
            });
            state.savedExpenseTemplate = template;
            saveState();
        }

        function applyExpenseTemplate() {
            if (!state.savedExpenseTemplate || !state.currentMonth) return;
            Object.entries(state.savedExpenseTemplate).forEach(([key, items]) => {
                if (state.currentMonth.categories[key]) {
                    state.currentMonth.categories[key].items = items.map(item => ({
                        ...item,
                        id: Date.now() + Math.random()
                    }));
                }
            });
            saveState();
        }

        function updateExpenseName(key, id, newName) {
            const item = state.currentMonth.categories[key].items.find(i => i.id === id);
            if (item && newName.trim()) {
                item.name = newName;
                saveState();
                render();
            }
        }

        function updateExpenseAmount(key, id, newAmount) {
            const item = state.currentMonth.categories[key].items.find(i => i.id === id);
            if (item && parseFloat(newAmount) > 0) {
                item.amount = parseFloat(newAmount);
                saveState();
                render();
            }
        }

        function moveExpense(fromKey, id, toKey) {
            if (fromKey === toKey) return;
            
            const item = state.currentMonth.categories[fromKey].items.find(i => i.id === id);
            if (item) {
                state.currentMonth.categories[fromKey].items = state.currentMonth.categories[fromKey].items.filter(i => i.id !== id);
                state.currentMonth.categories[toKey].items.push(item);
                saveState();
                render();
            }
        }

        function saveSettings() { saveState(); goTo('profile'); }

        // Radera m√•nad funktioner
        function confirmDeleteMonth(monthKey, displayDate) {
            const modal = document.getElementById('deleteModal');
            const modalText = document.getElementById('deleteModalText');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            modalText.textContent = `√Ñr du s√§ker p√• att du vill radera "${displayDate}"? Detta g√•r inte att √•ngra.`;
            confirmBtn.setAttribute('onclick', `deleteMonth('${monthKey}')`);
            modal.style.display = 'flex';
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }
        
        function showInfoModal(type) {
            const modal = document.getElementById('infoModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        function closeInfoModal() {
            const modal = document.getElementById('infoModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function deleteMonth(monthKey) {
            // Ta bort m√•naden fr√•n months array
            state.months = state.months.filter(m => m.monthKey !== monthKey);
            
            // Om vi raderade currentMonth, v√§lj en annan
            if (state.currentMonth && state.currentMonth.monthKey === monthKey) {
                if (state.months.length > 0) {
                    state.currentMonth = state.months[state.months.length - 1];
                } else {
                    state.currentMonth = null;
                }
            }
            
            // Ta bort streak-data f√∂r denna m√•nad
            if (state.noSpendStreak && state.noSpendStreak.savedDays) {
                state.noSpendStreak.savedDays = state.noSpendStreak.savedDays.filter(
                    d => d.monthKey !== monthKey
                );
            }
            
            saveState();
            closeDeleteModal();
            
            // Om inga m√•nader kvar, g√• till start
            if (state.months.length === 0) {
                goTo('start');
            } else {
                render();
            }
        }

        // FIX: selectMonth beh√•ller m√•nadens egen budgetModel
        function selectMonth(monthKey) {
            const month = state.months.find(m => m.monthKey === monthKey);
            if (month) { 
                state.currentMonth = month;
                // FIX: S√§tt inte state.budgetModel - l√•t m√•naden anv√§nda sin sparade modell
                goTo('budget'); 
            }
        }

        const app = document.getElementById('app');
        
        loadState();
        
        if (!state.months) {
            state.months = [];
        }
        
        // Initiera noSpendStreak om det inte finns
        if (!state.noSpendStreak) {
            state.noSpendStreak = {
                lastExpenseDate: null,
                streakStartDate: null,
                savedDays: [],
                lastCheckedDate: null
            };
        }
        if (!state.noSpendStreak.savedDays) {
            state.noSpendStreak.savedDays = [];
        }
        
        // Initiera salaryAfterTax om det inte finns
        if (!state.salaryAfterTax) {
            state.salaryAfterTax = {
                incomeType: 'monthly',
                grossSalary: 0,
                hourlyRate: 0,
                hoursWorked: 160,
                municipality: '',
                birthYear: 1990,
                churchMember: false
            };
        }
        
        if (state.months.length === 0) {
            state.view = 'start';
        } else {
            // FIX: V√§lj senaste m√•naden (sista i sorterad array)
            state.currentMonth = state.months[state.months.length - 1];
            state.view = 'budget';
        }
        
        render();
    </script>
</body>
</html>
