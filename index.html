<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monly - Din personliga budgetapp</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%); color: #e8eaf6; min-height: 100vh; padding: 20px; }
        .app { max-width: 480px; margin: 0 auto; min-height: 100vh; }
        .view-header { display: flex; justify-content: center; align-items: center; margin-bottom: 32px; position: relative; }
        .view-header h2 { font-size: 24px; font-weight: 700; color: #e8eaf6; text-align: center; }
        .view-header-left { position: absolute; left: 0; }
        .view-header-right { position: absolute; right: 0; padding-right: 0; }
        .icon-button { background: none; border: none; color: #667eea; cursor: pointer; padding: 8px; font-size: 18px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .icon-button:hover { background: rgba(102, 126, 234, 0.1); }
        .primary-button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px 32px; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin-bottom: 12px; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4); transition: all 0.3s ease; }
        .primary-button:hover { transform: translateY(-4px); }
        .primary-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .secondary-button { background: rgba(159, 168, 218, 0.1); color: #667eea; border: 2px solid rgba(159, 168, 218, 0.2); padding: 14px 28px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-bottom: 12px; }
        .secondary-button:hover { background: rgba(159, 168, 218, 0.15); }
        .start-view { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 40px); gap: 32px; }
        .logo { font-size: 64px; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
        .tagline { font-size: 16px; color: #9fa8da; }
        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; font-size: 14px; color: #9fa8da; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select { background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 12px; padding: 12px; font-size: 15px; color: #e8eaf6; font-family: inherit; width: 100%; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        /* Hide number input spinners */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        select { background: rgba(10, 14, 39, 0.6) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E") no-repeat right 8px center; padding-right: 28px; }
        .flex-row { display: flex; gap: 12px; }
        .flex-row input, .flex-row select { flex: 1; }
        
        .category-card { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 20px; padding: 24px; margin-bottom: 16px; cursor: pointer; transition: all 0.3s ease; }
        .category-card:hover { transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3); }
        .category-card.fasta { border-color: rgba(244, 67, 54, 0.3); }
        .category-card.nojen { border-color: rgba(255, 152, 0, 0.3); }
        .category-card.sparande { border-color: rgba(76, 175, 80, 0.3); }
        .category-card h3 { font-size: 18px; font-weight: 700; color: #e8eaf6; margin-bottom: 8px; }
        .category-card .percentage { font-size: 14px; color: #9fa8da; font-weight: 600; margin-bottom: 12px; }
        .category-card .budget-amount { font-size: 32px; font-weight: 800; color: #e8eaf6; margin-bottom: 16px; }
        .category-card .remaining { display: flex; justify-content: space-between; font-size: 16px; font-weight: 700; padding-top: 12px; border-top: 1px solid rgba(159, 168, 218, 0.1); }
        .category-card .remaining.negative { color: #e57373; }
        .category-card .remaining:not(.negative) { color: #81c784; }
        
        .income-display { background: rgba(102, 126, 234, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        .income-display-label { font-size: 12px; color: #9fa8da; }
        .income-display-amount { font-size: 24px; font-weight: 700; color: #667eea; }
        
        .summary-bars { display: flex; gap: 12px; margin-bottom: 24px; }
        .summary-bar { flex: 1; border-radius: 12px; padding: 16px; background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); }
        .summary-bar-label { font-size: 12px; color: #9fa8da; margin-bottom: 8px; }
        .summary-bar-amount { font-size: 18px; font-weight: 700; }
        
        .menu-button { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 20px; display: flex; align-items: center; gap: 16px; cursor: pointer; font-size: 16px; font-weight: 600; color: #e8eaf6; margin-bottom: 12px; transition: all 0.2s ease; width: 100%; }
        .menu-button:hover { background: rgba(159, 168, 218, 0.1); transform: translateX(4px); }
        
        .total-card { background: rgba(159, 168, 218, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .total-card h3 { font-size: 12px; color: #9fa8da; text-transform: uppercase; margin-bottom: 8px; font-weight: 600; }
        .total-card-amount { font-size: 18px; font-weight: 700; }
        .total-card.fasta { border-left: 4px solid rgba(244, 67, 54, 0.5); }
        .total-card.nojen { border-left: 4px solid rgba(255, 193, 7, 0.5); }
        .total-card.sparande { border-left: 4px solid rgba(76, 175, 80, 0.5); }
        
        .special-box { background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.1) 100%); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 16px; padding: 20px; margin-bottom: 24px; }
        .special-box-amount { font-size: 28px; font-weight: 700; color: #667eea; margin: 12px 0; }
        
        .expense-item { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 14px; padding: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .expense-item[style*="flex-direction"] { align-items: flex-start; }
        .expense-name { flex: 1; font-size: 15px; font-weight: 600; }
        .expense-amount { font-size: 14px; font-weight: 700; color: #667eea; margin: 0 12px; }
        .delete-button { background: none; border: none; color: #e57373; cursor: pointer; font-size: 16px; padding: 4px; }
        
        .history-month { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 24px; margin-bottom: 16px; cursor: pointer; transition: all 0.3s ease; }
        .history-month:hover { background: rgba(159, 168, 218, 0.1); transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3); }
        .history-month h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #e8eaf6; }
        .history-month-stats { font-size: 14px; color: #9fa8da; }
        
        .budget-option { background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 12px; padding: 16px; color: #e8eaf6; cursor: pointer; transition: all 0.2s ease; }
        .budget-option:hover { background: rgba(159, 168, 218, 0.1); }
        .budget-option.active { background: rgba(102, 126, 234, 0.3); border-color: rgba(102, 126, 234, 0.6); }
        .budget-option-title { font-weight: 600; margin-bottom: 4px; font-size: 15px; }
        .budget-option-desc { font-size: 13px; color: #9fa8da; }
    </style>
</head>
<body>
    <div class="app" id="app"></div>

    <script>
        const languages = {
            sv: {
                appName: 'Monly', tagline: 'Enkel privatekonomi f√∂r alla', createFirst: 'üìÖ Starta budgetering',
                income: 'M√•nadsinkomst', next: 'B√∂rja budgetera', back: 'Tillbaka', myProfile: 'Min profil',
                account: 'Konto', history: 'Historik', totalResult: 'Totalt resultat', editExpenses: 'Redigera utgifter',
                language: 'Spr√•k', currency: 'Valuta', name: 'Namn', fixedCosts: 'Fasta kostnader',
                fun: 'N√∂jen', savings: 'Sparande', remaining: 'Kvar', used: 'Anv√§nt', leftToUse: 'Kvar att anv√§nda',
                forFunAndEntertainment: 'f√∂r n√∂je och underh√•llning', addExpense: 'L√§gg till utgift', 
                noExpenses: 'Inga poster √§nnu', totalIncome: 'Total inkomst', totalExpenses: 'Totala utgifter',
                totalSavings: 'Totalt sparande', totalUsed: 'Totalt anv√§nt', totalRemaining: 'Totalt kvar',
                extraIncome: 'Extra inkomst'
            },
            en: {
                appName: 'Monly', tagline: 'Easy personal finance for everyone', createFirst: 'üìÖ Start budgeting',
                income: 'Monthly income', next: 'Start budgeting', back: 'Back', myProfile: 'My profile',
                account: 'Account', history: 'History', totalResult: 'Total result', editExpenses: 'Edit expenses',
                language: 'Language', currency: 'Currency', name: 'Name', fixedCosts: 'Fixed costs',
                fun: 'Fun', savings: 'Savings', remaining: 'Remaining', used: 'Used', leftToUse: 'Left to use',
                forFunAndEntertainment: 'for fun and entertainment', addExpense: 'Add expense', 
                noExpenses: 'No items yet', totalIncome: 'Total income', totalExpenses: 'Total expenses',
                totalSavings: 'Total savings', totalUsed: 'Total used', totalRemaining: 'Total remaining',
                extraIncome: 'Extra income'
            }
        };

        const state = {
            view: 'start', language: 'sv', currency: 'SEK', userName: '',
            currentMonth: null, selectedCategory: null, accounts: [], currentAccountId: null,
            extraIncome: 0, showExtraIncomeForm: false, budgetModel: 'recommended',
            customPercentages: { fasta: 50, nojen: 30, sparande: 20 }
        };

        const currencies = {
            'SEK': 'Svenska kronor', 'EUR': 'Euro', 'USD': 'US Dollar', 'GBP': 'British Pound',
            'NOK': 'Norska kronor', 'DKK': 'Danska kronor'
        };

        function t(key) { return languages[state.language][key] || key; }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('sv-SE', { style: 'currency', currency: state.currency, minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        }

        function loadState() {
            const saved = localStorage.getItem('monly_data');
            if (saved) Object.assign(state, JSON.parse(saved));
        }

        function saveState() { localStorage.setItem('monly_data', JSON.stringify(state)); }

        function render() {
            switch(state.view) {
                case 'start': renderStart(); break;
                case 'createIncome': renderCreateIncome(); break;
                case 'budget': renderBudget(); break;
                case 'profile': renderProfile(); break;
                case 'accountSettings': renderAccountSettings(); break;
                case 'totalResult': renderTotalResult(); break;
                case 'history': renderHistory(); break;
                case 'editExpenses': renderEditExpenses(); break;
                case 'category': renderCategory(); break;
            }
        }

        function renderStart() {
            app.innerHTML = `
                <div class="start-view">
                    <div style="text-align: center;">
                        <div class="logo">${t('appName')}</div>
                        <div class="tagline">${t('tagline')}</div>
                    </div>
                    <button class="primary-button" onclick="goTo('createIncome')">${t('createFirst')}</button>
                </div>
            `;
        }

        function renderCreateIncome() {
            const monthNames = ['', 'Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni', 'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'];
            const currentYear = new Date().getFullYear();
            const years = [currentYear - 1, currentYear, currentYear + 1];

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('start')">‚Üê</button>
                        </div>
                        <h2>Ny m√•nad</h2>
                        <div class="view-header-right"></div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 20px; padding: 28px; margin-bottom: 32px;">
                        <div style="font-size: 12px; color: #9fa8da; text-transform: uppercase; font-weight: 600; margin-bottom: 12px;">M√•nadsinkomst</div>
                        <input type="number" id="incomeInput" placeholder="0" required min="1" style="background: none; border: none; outline: none; font-size: 48px; font-weight: 800; color: #667eea; width: 100%; padding: 0; font-family: inherit; margin-bottom: 12px;">
                        <div style="font-size: 14px; color: #9fa8da;">${state.currency}</div>
                    </div>

                    <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 20px; margin-bottom: 32px;">
                        <h3 style="font-size: 12px; color: #9fa8da; margin-bottom: 16px; font-weight: 600; text-transform: uppercase;">V√§lj m√•nad & √•r</h3>
                        <div style="display: flex; gap: 12px;">
                            <select id="monthSelect" style="flex: 1; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 14px;">
                                ${monthNames.map((m, i) => `<option value="${i}" ${i === (new Date().getMonth() + 1) ? 'selected' : ''}>${m}</option>`).join('')}
                            </select>
                            <select id="yearSelect" style="width: 100px; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit; font-size: 14px;">
                                ${years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <h3 style="font-size: 14px; color: #9fa8da; margin-bottom: 16px; font-weight: 600;">Budgetf√∂rdelning</h3>

                    <div class="budget-option ${state.budgetModel === 'recommended' ? 'active' : ''}" onclick="selectBudgetModel('recommended'); render()">
                        <div class="budget-option-title">Rekommenderad (50/30/20)</div>
                        <div class="budget-option-desc">Fasta: 50% | N√∂jen: 30% | Sparande: 20%</div>
                    </div>

                    <div class="budget-option ${state.budgetModel === 'free' ? 'active' : ''}" onclick="selectBudgetModel('free'); render()" style="margin-top: 12px;">
                        <div class="budget-option-title">Friare f√∂rdelning (40/40/20)</div>
                        <div class="budget-option-desc">Fasta: 40% | N√∂jen: 40% | Sparande: 20%</div>
                    </div>

                    <div class="budget-option ${state.budgetModel === 'custom' ? 'active' : ''}" onclick="selectBudgetModel('custom'); render()" style="margin-top: 12px;">
                        <div class="budget-option-title">Egen f√∂rdelning</div>
                        <div class="budget-option-desc">Du v√§ljer sj√§lv hur du vill f√∂rdela</div>
                    </div>

                    ${state.budgetModel === 'custom' ? `
                        <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 20px; margin-top: 16px; margin-bottom: 24px;">
                            <h3 style="font-size: 14px; color: #9fa8da; margin-bottom: 16px; font-weight: 600;">Ange dina egna procentsatser</h3>
                            
                            <div class="form-group">
                                <label>Fasta kostnader (%)</label>
                                <input type="number" id="customFasta" value="${state.customPercentages.fasta}" min="0" max="100" oninput="updateCustomPercentage('fasta', this.value)">
                            </div>

                            <div class="form-group">
                                <label>N√∂jen (%)</label>
                                <input type="number" id="customNojen" value="${state.customPercentages.nojen}" min="0" max="100" oninput="updateCustomPercentage('nojen', this.value)">
                            </div>

                            <div class="form-group">
                                <label>Sparande (%)</label>
                                <input type="number" id="customSparande" value="${state.customPercentages.sparande}" min="0" max="100" oninput="updateCustomPercentage('sparande', this.value)">
                            </div>

                            <div style="background: rgba(102, 126, 234, 0.2); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 12px; text-align: center;">
                                <div style="font-size: 12px; color: #9fa8da; margin-bottom: 4px;">Totalt</div>
                                <div style="font-size: 18px; font-weight: 700; color: ${(state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande) === 100 ? '#81c784' : '#e57373'};">${state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande}%</div>
                            </div>
                        </div>
                    ` : ''}

                    <button type="button" class="primary-button" onclick="createBudgetWithDate()" style="margin-top: 48px;" ${state.budgetModel === 'custom' && (state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande) !== 100 ? 'disabled' : ''}>B√∂rja budgetera</button>
                </div>
            `;
            document.getElementById('incomeInput').focus();
        }

        function renderBudget() {
            if (!state.currentMonth) return;
            const month = state.currentMonth;

            const totalBudget = Object.values(month.categories).reduce((sum, cat) => sum + cat.budget, 0);
            const totalSpent = Object.values(month.categories).reduce((sum, cat) => sum + cat.items.reduce((s, item) => s + item.amount, 0), 0);
            const totalRemaining = totalBudget - totalSpent;

            let categoryHtml = '';
            for (const [key, cat] of Object.entries(month.categories)) {
                const spent = cat.items.reduce((sum, item) => sum + item.amount, 0);
                const remaining = cat.budget - spent;
                
                categoryHtml += `
                    <div class="category-card ${key}">
                        <h3>${cat.name}</h3>
                        <div class="percentage">${cat.percentage}%</div>
                        <div class="budget-amount">${formatCurrency(cat.budget)}</div>
                        <div class="remaining ${remaining < 0 ? 'negative' : ''}">
                            <span>${t('remaining')}:</span>
                            <span>${formatCurrency(remaining)}</span>
                        </div>
                        <button type="button" style="background: rgba(102, 126, 234, 0.2); border: 1px solid rgba(102, 126, 234, 0.4); border-radius: 12px; padding: 10px; color: #667eea; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; margin-top: 16px;" onclick="goToCategory('${key}')">
                            ‚ûï ${t('addExpense')}
                        </button>
                    </div>
                `;
            }

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left"></div>
                        <h2>${month.displayDate}</h2>
                        <div class="view-header-right" style="">
                            <button class="icon-button" onclick="goTo('profile')">üë§</button>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 20px; padding: 28px; margin-bottom: 32px;">
                        <div style="font-size: 12px; color: #9fa8da; text-transform: uppercase; font-weight: 600; margin-bottom: 12px;">${t('totalIncome')}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                            <div style="flex: 1;">
                                <input type="number" id="editableIncome" value="${month.income}" style="background: none; border: none; outline: none; font-size: 48px; font-weight: 800; color: #667eea; width: 100%; padding: 0; font-family: inherit;" onchange="updateMainIncome(this.value)">
                                <div style="font-size: 14px; color: #9fa8da; margin-top: 8px;">${state.currency}</div>
                            </div>
                            <button class="secondary-button" style="width: auto; margin: 0; padding: 12px 20px; font-size: 14px; height: fit-content;" onclick="document.getElementById('editableIncome').focus()">‚úèÔ∏è √Ñndra</button>
                        </div>
                    </div>

                    ${state.extraIncome > 0 ? `
                        <div style="background: rgba(76, 175, 80, 0.1); border: 2px solid rgba(76, 175, 80, 0.2); border-radius: 16px; padding: 16px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 12px; color: #81c784; margin-bottom: 4px; text-transform: uppercase; font-weight: 600;">Extra inkomst tillagd</div>
                                <div style="font-size: 18px; font-weight: 700; color: #81c784;">${formatCurrency(state.extraIncome)}</div>
                            </div>
                            <button type="button" class="delete-button" onclick="removeExtraIncome()">üóëÔ∏è</button>
                        </div>
                    ` : ''}

                    ${state.showExtraIncomeForm ? `
                        <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 16px; margin-bottom: 24px; display: flex; gap: 8px;">
                            <input type="number" id="extraIncomeInput" value="" placeholder="Belopp" style="flex: 1; background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 10px; color: #e8eaf6; font-family: inherit;">
                            <button type="button" class="secondary-button" style="width: auto; margin: 0; padding: 10px 16px;" onclick="saveExtraIncome()">L√§gg till</button>
                            <button type="button" class="secondary-button" style="width: auto; margin: 0; padding: 10px 16px;" onclick="cancelExtraIncome()">Avbryt</button>
                        </div>
                    ` : `
                        <button class="primary-button" onclick="toggleExtraIncome()" style="margin-bottom: 24px;">+ L√§gg till extra inkomst</button>
                    `}

                    <div class="summary-bars">
                        <div class="summary-bar">
                            <div class="summary-bar-label">${t('totalUsed')}</div>
                            <div class="summary-bar-amount">${formatCurrency(totalSpent)}</div>
                        </div>
                        <div class="summary-bar">
                            <div class="summary-bar-label">${t('totalRemaining')}</div>
                            <div class="summary-bar-amount">${formatCurrency(Math.max(0, totalRemaining))}</div>
                        </div>
                    </div>

                    ${categoryHtml}

                    <button class="primary-button" onclick="goTo('totalResult')" style="margin-top: 32px;">Spara m√•nad</button>
                </div>
            `;
        }

        function renderProfile() {
            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('budget')">‚Üê</button>
                        </div>
                        <h2>${t('myProfile')}</h2>
                        <div class="view-header-right"></div>
                    </div>
                    <button class="menu-button" onclick="goTo('accountSettings')">${t('account')}</button>
                    <button class="menu-button" onclick="goTo('totalResult')">${t('totalResult')}</button>
                    <button class="menu-button" onclick="goTo('history')">${t('history')}</button>
                    <button class="menu-button" onclick="goTo('editExpenses')">${t('editExpenses')}</button>
                </div>
            `;
        }

        function renderAccountSettings() {
            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('profile')">‚Üê</button>
                        </div>
                        <h2>${t('account')}</h2>
                        <div class="view-header-right"></div>
                    </div>
                    <div class="form-group">
                        <label>${t('name')}</label>
                        <input type="text" id="userName" value="${state.userName}" oninput="state.userName = this.value" placeholder="${t('name')}">
                    </div>
                    <div class="form-group">
                        <label>${t('language')}</label>
                        <select onchange="state.language = this.value; render()">
                            <option value="sv" ${state.language === 'sv' ? 'selected' : ''}>Svenska</option>
                            <option value="en" ${state.language === 'en' ? 'selected' : ''}>English</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>${t('currency')}</label>
                        <select onchange="state.currency = this.value; render()">
                            ${Object.entries(currencies).map(([code, name]) => `<option value="${code}" ${state.currency === code ? 'selected' : ''}>${code} (${name})</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(159, 168, 218, 0.1);">
                        <h3 style="font-size: 14px; color: #9fa8da; margin-bottom: 16px; font-weight: 600; text-transform: uppercase;">Budgetf√∂rdelning f√∂r nya m√•nader</h3>

                        <div class="budget-option ${state.budgetModel === 'recommended' ? 'active' : ''}" onclick="selectBudgetModel('recommended'); saveSettings();">
                            <div class="budget-option-title">Rekommenderad (50/30/20)</div>
                            <div class="budget-option-desc">Fasta: 50% | N√∂jen: 30% | Sparande: 20%</div>
                        </div>

                        <div class="budget-option ${state.budgetModel === 'free' ? 'active' : ''}" onclick="selectBudgetModel('free'); saveSettings();" style="margin-top: 12px;">
                            <div class="budget-option-title">Friare f√∂rdelning (40/40/20)</div>
                            <div class="budget-option-desc">Fasta: 40% | N√∂jen: 40% | Sparande: 20%</div>
                        </div>

                        <div class="budget-option ${state.budgetModel === 'custom' ? 'active' : ''}" onclick="selectBudgetModel('custom');" style="margin-top: 12px;">
                            <div class="budget-option-title">Egen f√∂rdelning</div>
                            <div class="budget-option-desc">Du v√§ljer sj√§lv hur du vill f√∂rdela</div>
                        </div>

                        ${state.budgetModel === 'custom' ? `
                            <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 16px; padding: 20px; margin-top: 16px;">
                                <div class="form-group">
                                    <label>Fasta kostnader (%)</label>
                                    <input type="number" id="customFasta2" value="${state.customPercentages.fasta}" min="0" max="100" oninput="updateCustomPercentage('fasta', this.value)">
                                </div>

                                <div class="form-group">
                                    <label>N√∂jen (%)</label>
                                    <input type="number" id="customNojen2" value="${state.customPercentages.nojen}" min="0" max="100" oninput="updateCustomPercentage('nojen', this.value)">
                                </div>

                                <div class="form-group">
                                    <label>Sparande (%)</label>
                                    <input type="number" id="customSparande2" value="${state.customPercentages.sparande}" min="0" max="100" oninput="updateCustomPercentage('sparande', this.value)">
                                </div>

                                <div style="background: rgba(102, 126, 234, 0.2); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 12px; text-align: center;">
                                    <div style="font-size: 12px; color: #9fa8da; margin-bottom: 4px;">Totalt</div>
                                    <div style="font-size: 18px; font-weight: 700; color: ${(state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande) === 100 ? '#81c784' : '#e57373'};">${state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande}%</div>
                                </div>

                                <button type="button" class="primary-button" onclick="saveSettings()" style="margin-top: 16px;" ${(state.customPercentages.fasta + state.customPercentages.nojen + state.customPercentages.sparande) !== 100 ? 'disabled' : ''}>Spara √§ndringar</button>
                            </div>
                        ` : ''}
                    </div>

                    <button class="primary-button" onclick="saveSettings()" style="margin-top: 32px;">${t('next')}</button>
                </div>
            `;
        }

        function renderTotalResult() {
            if (!state.currentMonth) return;

            const fataSpent = state.currentMonth.categories.fasta.items.reduce((sum, item) => sum + item.amount, 0);
            const nojenSpent = state.currentMonth.categories.nojen.items.reduce((sum, item) => sum + item.amount, 0);
            const sparandeSpent = state.currentMonth.categories.sparande.items.reduce((sum, item) => sum + item.amount, 0);

            const leftToUse = state.currentMonth.income - (fataSpent + sparandeSpent);

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('profile')">‚Üê</button>
                        </div>
                        <h2>${t('totalResult')}</h2>
                        <div class="view-header-right" style=""></div>
                    </div>
                    
                    <p style="font-size: 13px; color: #9fa8da; margin-bottom: 24px; text-align: center; font-weight: 500;">En sammanfattning av dina finansiella status denna m√•nad</p>

                    <div class="total-card fasta">
                        <h3>Fasta kostnader</h3>
                        <div class="total-card-amount">${formatCurrency(fataSpent)}</div>
                    </div>

                    <div class="total-card nojen">
                        <h3>N√∂jen</h3>
                        <div class="total-card-amount">${formatCurrency(nojenSpent)}</div>
                    </div>

                    <div class="total-card sparande">
                        <h3>Sparande</h3>
                        <div class="total-card-amount">${formatCurrency(sparandeSpent)}</div>
                    </div>

                    <div class="special-box">
                        <h3 style="font-size: 14px; font-weight: 700; color: #e8eaf6;">üí∞ ${t('leftToUse')}</h3>
                        <div class="special-box-amount">${formatCurrency(Math.max(0, leftToUse))}</div>
                        <p style="font-size: 12px; color: #9fa8da;">${t('forFunAndEntertainment')}</p>
                    </div>
                </div>
            `;
        }

        function renderHistory() {
            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('profile')">‚Üê</button>
                        </div>
                        <h2>${t('history')}</h2>
                        <div class="view-header-right"></div>
                    </div>
                    
                    <p style="font-size: 13px; color: #9fa8da; margin-bottom: 24px; text-align: center; font-weight: 500;">H√§r finns det samtliga registrerade m√•nader</p>
                    
                    ${state.accounts[0]?.months?.map(month => {
                        const spent = Object.values(month.categories).reduce((sum, cat) => sum + cat.items.reduce((s, item) => s + item.amount, 0), 0);
                        return `
                            <div class="history-month" onclick="selectMonth('${month.monthKey}')">
                                <h3>${month.displayDate}</h3>
                                <div class="history-month-stats">
                                    <div style="margin-bottom: 8px;">
                                        <span style="color: #9fa8da; font-size: 12px;">INKOMST:</span> <span style="font-weight: 700; color: #667eea;">${formatCurrency(month.income)}</span>
                                    </div>
                                    <div>
                                        <span style="color: #9fa8da; font-size: 12px;">UTGIFTER:</span> <span style="font-weight: 700; color: #667eea;">${formatCurrency(spent)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('') || '<p style="color: #9fa8da; text-align: center; padding: 32px 0;">Ingen historik √§nnu</p>'}
                </div>
            `;
        }
        function renderEditExpenses() {
            if (!state.currentMonth) return;
            let allExpenses = [];
            Object.entries(state.currentMonth.categories).forEach(([key, cat]) => {
                cat.items.forEach(item => {
                    allExpenses.push({ ...item, category: key, categoryName: cat.name });
                });
            });

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('profile')">‚Üê</button>
                        </div>
                        <h2>${t('editExpenses')}</h2>
                        <div class="view-header-right"></div>
                    </div>
                    ${allExpenses.length > 0 ? `
                        <div style="margin-bottom: 24px;">
                            ${allExpenses.map(expense => `
                                <div style="background: rgba(159, 168, 218, 0.05); border: 2px solid rgba(159, 168, 218, 0.1); border-radius: 14px; padding: 16px; margin-bottom: 12px;">
                                    <div style="font-size: 12px; color: #9fa8da; margin-bottom: 12px; text-transform: uppercase; font-weight: 600;">${expense.categoryName}</div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <label style="font-size: 12px; color: #9fa8da; margin-bottom: 4px; display: block;">Namn</label>
                                        <input type="text" value="${expense.name}" onchange="updateExpenseName('${expense.category}', ${expense.id}, this.value)" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 8px; color: #e8eaf6; font-family: inherit; width: 100%;">
                                    </div>

                                    <div style="display: flex; gap: 8px; align-items: flex-end;">
                                        <div style="flex: 1;">
                                            <label style="font-size: 12px; color: #9fa8da; margin-bottom: 4px; display: block;">Belopp</label>
                                            <input type="number" value="${expense.amount}" onchange="updateExpenseAmount('${expense.category}', ${expense.id}, this.value)" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 8px; color: #e8eaf6; font-family: inherit; width: 100%;">
                                        </div>
                                        <div style="flex: 1;">
                                            <label style="font-size: 12px; color: #9fa8da; margin-bottom: 4px; display: block;">Kategori</label>
                                            <select onchange="moveExpense('${expense.category}', ${expense.id}, this.value)" style="background: rgba(10, 14, 39, 0.6); border: 2px solid rgba(159, 168, 218, 0.2); border-radius: 8px; padding: 8px; color: #e8eaf6; font-family: inherit; width: 100%;">
                                                <option value="${expense.category}" selected>${expense.categoryName}</option>
                                                ${Object.entries(state.currentMonth.categories).filter(([key]) => key !== expense.category).map(([key, cat]) => `
                                                    <option value="${key}">‚Üí ${cat.name}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <button class="delete-button" onclick="deleteExpense('${expense.category}', ${expense.id})" style="margin-bottom: 0;">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `<p style="color: #9fa8da; text-align: center; padding: 32px 0;">${t('noExpenses')}</p>`}
                </div>
            `;
        }

        function renderCategory() {
            if (!state.selectedCategory || !state.currentMonth) return;
            const key = state.selectedCategory.key;
            const cat = state.currentMonth.categories[key];
            const spent = cat.items.reduce((sum, item) => sum + item.amount, 0);
            const remaining = cat.budget - spent;
            const isOverBudget = remaining < 0;

            app.innerHTML = `
                <div>
                    <div class="view-header">
                        <div class="view-header-left">
                            <button class="icon-button" onclick="goTo('budget')">‚Üê</button>
                        </div>
                        <h2>${cat.name}</h2>
                        <div class="view-header-right"></div>
                    </div>

                    <div class="total-card" style="margin-bottom: 24px;">
                        <h3>Status</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                            <div>
                                <div style="font-size: 12px; color: #9fa8da; margin-bottom: 4px;">Budget</div>
                                <div style="font-size: 18px; font-weight: 700;">${formatCurrency(cat.budget)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #9fa8da; margin-bottom: 4px;">Anv√§nt</div>
                                <div style="font-size: 18px; font-weight: 700;">${formatCurrency(spent)}</div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(159, 168, 218, 0.1); text-align: center;">
                            <div style="font-size: 12px; color: #9fa8da; margin-bottom: 8px;">${isOverBudget ? '√ñVERSTIGER BUDGET' : 'KVAR ATT ANV√ÑNDA'}</div>
                            <div style="font-size: 24px; font-weight: 700; color: ${isOverBudget ? '#e57373' : '#81c784'};">${formatCurrency(Math.abs(remaining))}</div>
                        </div>
                    </div>

                    <form onsubmit="addExpense('${key}', event)">
                        <div class="form-group">
                            <label>${t('addExpense')}</label>
                            <input type="text" id="expenseName" placeholder="Namn" required>
                        </div>
                        <div class="form-group">
                            <input type="number" id="expenseAmount" placeholder="Belopp" required min="1">
                        </div>
                        <button type="submit" class="primary-button">‚ûï ${t('addExpense')}</button>
                    </form>

                    <h3 style="font-size: 14px; color: #9fa8da; margin-bottom: 16px; font-weight: 600; text-transform: uppercase; margin-top: 32px;">Poster</h3>
                    <div style="margin-bottom: 24px;">
                        ${cat.items.map(item => `
                            <div class="expense-item">
                                <span class="expense-name">${item.name}</span>
                                <span class="expense-amount">${formatCurrency(item.amount)}</span>
                                <button class="delete-button" onclick="deleteExpense('${key}', ${item.id})">üóëÔ∏è</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('expenseName').focus();
        }

        // HANDLERS
        function goTo(view) { state.view = view; saveState(); render(); }
        function goToCategory(key) { state.selectedCategory = { key, ...state.currentMonth.categories[key] }; goTo('category'); }

        function selectBudgetModel(model) {
            state.budgetModel = model;
            if (model === 'recommended') {
                state.customPercentages = { fasta: 50, nojen: 30, sparande: 20 };
            } else if (model === 'free') {
                state.customPercentages = { fasta: 40, nojen: 40, sparande: 20 };
            }
        }

        function updateCustomPercentage(category, value) {
            state.customPercentages[category] = Math.max(0, Math.min(100, parseInt(value) || 0));
            render();
        }

        function createBudgetWithDate() {
            const income = parseFloat(document.getElementById('incomeInput').value);
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            
            if (!income || income <= 0) {
                alert('Ange en giltig inkomst');
                return;
            }

            const monthNames = ['', 'Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni', 'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'];
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            const displayDate = month > 0 ? `${monthNames[month]} ${year}` : `${year}`;

            const newMonth = {
                monthKey, displayDate, income,
                categories: {
                    fasta: { name: t('fixedCosts'), percentage: state.customPercentages.fasta, budget: income * (state.customPercentages.fasta / 100), items: [] },
                    nojen: { name: t('fun'), percentage: state.customPercentages.nojen, budget: income * (state.customPercentages.nojen / 100), items: [] },
                    sparande: { name: t('savings'), percentage: state.customPercentages.sparande, budget: income * (state.customPercentages.sparande / 100), items: [] }
                }
            };

            const newAccount = { id: 'acc_' + Date.now(), name: 'Mitt konto', months: [newMonth] };
            state.accounts = [newAccount];
            state.currentAccountId = newAccount.id;
            state.currentMonth = newMonth;
            state.extraIncome = 0;
            saveState();
            goTo('budget');
        }

        function createBudget() {
            const income = parseFloat(document.getElementById('incomeInput').value);
            if (!income || income <= 0) {
                alert('Ange en giltig inkomst');
                return;
            }

            const now = new Date();
            const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthNames = ['', 'Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni', 'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'];
            const displayDate = `${monthNames[now.getMonth() + 1]} ${now.getFullYear()}`;

            const newMonth = {
                monthKey, displayDate, income,
                categories: {
                    fasta: { name: t('fixedCosts'), percentage: state.customPercentages.fasta, budget: income * (state.customPercentages.fasta / 100), items: [] },
                    nojen: { name: t('fun'), percentage: state.customPercentages.nojen, budget: income * (state.customPercentages.nojen / 100), items: [] },
                    sparande: { name: t('savings'), percentage: state.customPercentages.sparande, budget: income * (state.customPercentages.sparande / 100), items: [] }
                }
            };

            const newAccount = { id: 'acc_' + Date.now(), name: 'Mitt konto', months: [newMonth] };
            state.accounts = [newAccount];
            state.currentAccountId = newAccount.id;
            state.currentMonth = newMonth;
            state.extraIncome = 0;
            saveState();
            goTo('budget');
        }

        function toggleExtraIncome() {
            state.showExtraIncomeForm = !state.showExtraIncomeForm;
            render();
            if (state.showExtraIncomeForm) {
                setTimeout(() => {
                    const input = document.getElementById('extraIncomeInput');
                    if (input) input.focus();
                }, 100);
            }
        }

        function removeExtraIncome() {
            state.extraIncome = 0;
            state.showExtraIncomeForm = false;
            saveState();
            render();
        }

        function cancelExtraIncome() {
            state.showExtraIncomeForm = false;
            render();
        }

        function updateMainIncome(newIncome) {
            const income = parseFloat(newIncome);
            if (income && income > 0) {
                state.currentMonth.income = income;
                // Uppdatera budget f√∂r varje kategori baserat p√• ny inkomst
                Object.keys(state.currentMonth.categories).forEach(key => {
                    state.currentMonth.categories[key].budget = state.currentMonth.income * (state.currentMonth.categories[key].percentage / 100);
                });
                saveState();
                render();
            }
        }

        function saveExtraIncome() {
            const input = document.getElementById('extraIncomeInput');
            if (input) {
                const value = parseFloat(input.value);
                if (value > 0) {
                    state.extraIncome = value;
                    state.showExtraIncomeForm = false;
                    saveState();
                    render();
                } else {
                    input.focus();
                }
            }
        }

        function addExpense(key, e) {
            e.preventDefault();
            const name = document.getElementById('expenseName').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            if (!name || !amount) return;
            state.currentMonth.categories[key].items.push({ id: Date.now(), name, amount });
            saveState();
            goTo('category');
        }

        function deleteExpense(key, id) {
            state.currentMonth.categories[key].items = state.currentMonth.categories[key].items.filter(i => i.id !== id);
            saveState();
            render();
        }

        function updateExpenseName(key, id, newName) {
            const item = state.currentMonth.categories[key].items.find(i => i.id === id);
            if (item && newName.trim()) {
                item.name = newName;
                saveState();
                render();
            }
        }

        function updateExpenseAmount(key, id, newAmount) {
            const item = state.currentMonth.categories[key].items.find(i => i.id === id);
            if (item && parseFloat(newAmount) > 0) {
                item.amount = parseFloat(newAmount);
                saveState();
                render();
            }
        }

        function moveExpense(fromKey, id, toKey) {
            if (fromKey === toKey) return;
            
            const item = state.currentMonth.categories[fromKey].items.find(i => i.id === id);
            if (item) {
                // Radera fr√•n gamla kategorin
                state.currentMonth.categories[fromKey].items = state.currentMonth.categories[fromKey].items.filter(i => i.id !== id);
                
                // L√§gg till i nya kategorin
                state.currentMonth.categories[toKey].items.push(item);
                
                saveState();
                render();
            }
        }

        function saveSettings() { saveState(); goTo('profile'); }

        function selectMonth(monthKey) {
            const month = state.accounts[0].months.find(m => m.monthKey === monthKey);
            if (month) { state.currentMonth = month; goTo('budget'); }
        }

        const app = document.getElementById('app');
        
        // Clear all data on first load to start fresh
        localStorage.clear();
        
        // RESET APP - Clear all data and reload
        function resetApp() {
            localStorage.clear();
            location.reload();
        }
        
        loadState();
        if (state.accounts.length === 0) state.view = 'start';
        else { state.currentAccountId = state.accounts[0].id; state.currentMonth = state.accounts[0].months[0]; state.view = 'budget'; }
        render();
    </script>
</body>
</html>
